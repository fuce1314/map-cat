/**/﻿_jsload&&_jsload('buslineSearch', 'ev.extend(d6.prototype,{_asyncSearch:function(){for(var T=0,e=this._queryList.length;T<e;T++){var je=this._queryList[T];this[je.method].apply(this,je.arguments)}delete this._queryList},_getMoreUrl:function(T,e){var i=w.apiHost+"/line?region="+T+"&name="+e+"&output=html&src=jsapi";return i},getBusList:function(e){var i=this;this._getIdByLoc(this._loc,function(je){if(!je){this._busListResult=new dF({keyword:e,city:"",moreUrl:"",_cityCode:""});i._setStatus(BMAP_STATUS_INVALID_REQUEST);i._triggerCbk(az.CBK_BUSLIST_COMPLETE,this._busListResult);return}var T={qt:i.QUERY_TYPE_BUSLIST,c:je,wd:e};iZ.request(function(jg,jf){i._busListDataCbk(jg,jf)},T,{keyword:e})})},_busListDataCbk:function(jf,e){this["clearResults"]();var jh=jf.result;if(!jf.content||jh.error!=0||jh.type!=this.RETURN_TYPE_BUSLIST){this._busListResult=new dF({keyword:e.keyword,city:jf.current_city["name"],moreUrl:"",_cityCode:jf.current_city["code"]});this._setStatus(BMAP_STATUS_SERVICE_UNAVAILABLE);this._triggerCbk(az.CBK_BUSLIST_COMPLETE,this._busListResult);return}var jj=jf.content,T=[];for(var je=0,jg=jj.length;je<jg;je++){var ji={name:jj[je]["name"],_uid:jj[je]["uid"],_cityCode:jf.current_city["code"],_index:je,_keyword:e.keyword,_poiType:jj[je]["poiType"]||2};T.push(ji)}this._busListResult=new dF({keyword:e.keyword,city:jf.current_city["name"],moreUrl:this._getMoreUrl(jf.current_city["name"],e.keyword),listItems:T,_cityCode:jf.current_city["code"]});this._setStatus(BMAP_STATUS_SUCCESS);this._triggerCbk(az.CBK_BUSLIST_COMPLETE,this._busListResult);this._renderBusListPanel();this._jumpCity(jf.current_city["geo"],jf.current_city["level"],jf.current_city["code"])},_renderBusListPanel:function(){if(this._opts.renderOptions.panel&&this._opts.renderOptions.panel.appendChild&&this._busListResult&&this._busListResult.getNumBusList()>0){var e=bL("div",{style:"font:12px "+w.fontFamily+";background:#fff"});e.id="divResult"+this.hashCode;var jf=this._busListResult.getNumBusList(),jg=[];for(var je=0;je<jf;je++){var jh=this._busListResult.getBusListItem(je).name;jg.push("<dl style=\'margin:3px 3px\'><dt><span style=\'cursor:pointer\' onclick=BMapGL.I(\\""+this.hashCode+\'")._selectBusListItem(\'+je+")><img id=imgBLIcon"+je+" src="+d6._iconOpen+" style=\'border:none\' /></span>&nbsp;&nbsp;<a style=\'color:blue\' href=\'javascript:void(0)\' onclick=BMapGL.I(\\""+this.hashCode+\'")._selectBusListItem(\'+je+")>"+jh+"</a></dt><dd id=ddBLInfo"+je+" style=\'display:none;margin:2px 0px\'></dd></dl>")}var T="";if(this._busListResult.moreResultsUrl){T+=\'<div style="color:#7777cc;background:#e5ecf9;overflow:hidden;padding:2px;text-align:right">\';T+=\'<a style="color:#7777cc" href="\'+this._busListResult.moreResultsUrl+\'" target="_blank">到百度地图查看&#187;</a>\';T+="&nbsp;</div>"}e.innerHTML=jg.join("")+T;this._opts.renderOptions.panel.appendChild(e);this._triggerCbk(az.CBK_BUSLISTHTML_SET,e)}},_jumpCity:function(je,jf,i){var T=this._opts.renderOptions.map;if(T){var e=by.parseGeo(je,true).point;if(this._preCityCode){if(this._preCityCode!=i){T.centerAndZoom(e,jf);this._preCityCode=i}}else{T.centerAndZoom(e,jf);this._preCityCode=i}}},_switchDDContainer:function(je){var jh=this;if(this._busListResult){for(var jf=0,T=this._busListResult.getNumBusList();jf<T;jf++){var e=ev.G("ddBLInfo"+jf);var jg=ev.G("imgBLIcon"+jf);if(jf==je){if(e.style.display=="none"){e.style.display="block";jg.src=d6._iconClose}else{e.style.display="none";jg.src=d6._iconOpen}}else{e.style.display="none";jg.src=d6._iconOpen}}}},_selectBusListItem:function(je,T){if(!T){var e=ev.G("ddBLInfo"+je);var i=ev.G("imgBLIcon"+je);if(e.style.display=="block"){e.style.display="none";i.src=d6._iconOpen;return}}if(this._busListResult&&this._busListResult[je]&&this._busListResult[je].getNumBusStations()>0){this._busLine=this._busListResult[je];this._setStatus(BMAP_STATUS_SUCCESS);this._triggerCbk(az.CBK_BUSLINE_COMPLETE,this._busLine);this._renderBusLinePanel(je);this._renderBusLineMap(je);return}var jf=this;var jh=this._busListResult.getBusListItem(je);var jg={qt:jf.QUERY_TYPE_BUSLINE,c:jh._cityCode,uid:jh._uid};iZ.request(function(jj,ji){jf._busLineDataCbk(jj,ji,je)},jg,{name:jh.name,_poiType:jh._poiType})},clearResults:function(){delete this._busListResult;delete this._busLine;delete this._stops;delete this._preA;this._clearOverlays();if(this._opts.renderOptions.panel){this._opts.renderOptions.panel.innerHTML=""}},getBusLine:function(e){if(e&&typeof e=="object"&&e._uid&&e._uid!=""&&(typeof e._cityCode!="undefined")&&e._cityCode.toString()!=""&&(typeof e._index!="undefined")&&e._index.toString()!=""&&(typeof e._keyword!="undefined")&&e._keyword.toString()!=""){if(this._busListResult&&this._busListResult.getNumBusList()>0&&e._cityCode==this._busListResult._cityCode&&e._keyword==this._busListResult.keyword){this["_selectBusListItem"](e._index,true)}}},_busLineDataCbk:function(jq,je,jl){var T=jq.result;if(!jq.content||!jq.content[0]||T.error!=0||T.type!=this.RETURN_TYPE_BUSLINE){this._busLine=new aw({name:je.name});this._setStatus(BMAP_STATUS_SERVICE_UNAVAILABLE);this._triggerCbk(az.CBK_BUSLINE_COMPLETE,this._busLine);return}var jn=jq.content[0];var jo="",jp="",jj="",ji={},jm=[];jo=jn.startTime;jp=jn.endTime;jj=jn.company;if(jn.geo){var jf=by.parseGeo(jn.geo,true);ji=new bd(jf.points,{strokeWeight:10})}if(jn.stations){for(var jg=0,jk=jn.stations["length"];jg<jk;jg++){if(jn.stations[jg]["geo"]){var e=by.parseGeo(jn.stations[jg]["geo"],true);var jh={name:jn.stations[jg]["name"],position:e.point,_uid:jn.stations[jg]["uid"]};jm.push(jh)}}}this._busLine=new aw({name:je.name,startTime:jo,endTime:jp,company:jj,polyline:ji,stations:jm,_poiType:je._poiType});this._setStatus(BMAP_STATUS_SUCCESS);this._triggerCbk(az.CBK_BUSLINE_COMPLETE,this._busLine);this._busListResult[jl]=this._busLine;this._renderBusLinePanel(jl);this._renderBusLineMap(jl)},_renderBusLinePanel:function(jg){if(this._opts.renderOptions.panel&&this._opts.renderOptions.panel.appendChild&&this._busLine&&this._busLine.getNumBusStations()>0){this._switchDDContainer(jg);var je=ev.G("ddBLInfo"+jg);if(je){var ji=[];ji.push("<table style=\'width:100%;background:#CDCDCD;font:12px "+w.fontFamily+"\' cellspacing=\'1\' cellpadding=\'1\' ><tbody>");ji.push("<tr><td style=\'width:95px;line-height:22px;padding:0px 8px;text-align:left;vertical-align:top;background:#F4F4F4\' >首末车时间</th><td  style=\'background:#FFFFFF;line-height:22px;padding:0px 8px\' >"+this._busLine.startTime+"-"+this._busLine.endTime+"</td></tr>");ji.push("<tr><td style=\'width:95px;line-height:22px;padding:0px 8px;text-align:left;vertical-align:top;background:#F4F4F4\' >所属公司</th><td  style=\'background:#FFFFFF;line-height:22px;padding:0px 8px\' >"+this._busLine.company+"</td></tr>");ji.push("</tbody></table>");if(this._busLine._poiType==4){ji.push("<p style=\'margin:2px 0px;font:12px "+w.fontFamily+";\'>沿线地铁站:</p>")}else{ji.push("<p style=\'margin:2px 0px;font:12px "+w.fontFamily+";\'>沿线公交站点:</p>")}ji.push("<table style=\'width:100%;font:12px "+w.fontFamily+";\' ><tbody>");for(var jh=0,e=this._busLine.getNumBusStations();jh<e;jh++){var jf=jh+1;ji.push("<tr><td style=\'width:20px\'>"+jf+"</th><td><a id=aStop_"+jg+"_"+jh+" style=\'color:blue\' href=\'javascript:void(0)\' onclick=BMapGL.I(\\""+this.hashCode+\'")._selectBusStop(\'+jg+","+jh+")>"+this._busLine.getBusStation(jh).name+"</a></td></tr>")}ji.push("</tbody></table>");je.innerHTML=ji.join("")}var T=ev.G("divResult"+this.hashCode);this._triggerCbk(az.CBK_BUSLINEHTML_SET,T)}},_renderBusLineMap:function(je){if(this._opts.renderOptions.map&&this._busLine&&this._busLine.getNumBusStations()>0){this._clearOverlays();e6.addRoute(this._opts.renderOptions.map,this._busLine.getPath());var jj=this._busLine.getPolyline();this._triggerCbk(az.CBK_POLYLINES_SET,jj);var jh=this;this._stops=[];for(var jg=0,e=this._busLine.getNumBusStations();jg<e;jg++){var ji=this._busLine.getBusStation(jg)["position"];var T=this._busLine.getBusStation(jg)["name"];var jf=e6.addStationPoi(this._opts.renderOptions.map,ji,T);(function(jm,jk,jl){jm.addEventListener("click",function(jo){var i=[\'<div style="font:12px \'+w.fontFamily+\'">\'];i.push(\'<div style="margin:17px;text-align:center;"><b>\'+jk+"</b></div>");i.push("</div>");var jp=new hi(i.join(""),{height:0,width:150,});jp.addEventListener("open",function(){var jq=ev.G("aStop_"+je+"_"+jl);if(jq){jq.style.backgroundColor="#cccccc"}});jp.addEventListener("close",function(){var jq=ev.G("aStop_"+je+"_"+jl);if(jq){jq.style.backgroundColor="#ffffff"}});var jn=jh._opts.renderOptions.map;if(jn.config.enableStreetEntrance){PanoramaEntranceUtil.insearchPanoEntranceInInfoWnd(jp,jn.getCurrentCity().code,{panoInstance:jn._pano,lngLat:jo.target.getPosition(),titleTip:jk,type:"busline"},function(){jm.openSimpleInfoWindow(jp)})}else{jm.openSimpleInfoWindow(jp)}})})(jf,T,jg);jf._stName=T;this._stops.push(jf)}this._triggerCbk(az.CBK_MARKERS_SET,this._stops);if(this._opts.renderOptions.autoViewport){this._opts.renderOptions.map.setViewport(jj.getPath(),{margins:[5,5,5,5]})}}},_selectBusStop:function(T,i){if(this._opts.renderOptions.map&&this._stops&&this._stops.length>0){var je=this._stops[i];if(je._stName){var jf=[\'<div style="font:12px \'+w.fontFamily+\'">\'];jf.push(\'<div style="margin:17px;text-align:center;"><b>\'+je._stName+"</b></div>");jf.push("</div>");var jh=new hi(jf.join(""),{height:0,width:150,});jh.addEventListener("open",function(){var ji=ev.G("aStop_"+T+"_"+i);if(ji){ji.style.backgroundColor="#cccccc"}});jh.addEventListener("close",function(){var ji=ev.G("aStop_"+T+"_"+i);if(ji){ji.style.backgroundColor="#ffffff"}});var jg=this._opts.renderOptions.map;if(jg.config.enableStreetEntrance){PanoramaEntranceUtil.insearchPanoEntranceInInfoWnd(jh,jg.getCurrentCity().code,{panoInstance:jg._pano,lngLat:je.getPosition(),titleTip:je._stName,type:"busline"},function(){je.openSimpleInfoWindow(jh)})}else{je.openSimpleInfoWindow(jh)}}}else{if(this.preA){this.preA.style.backgroundColor="#ffffff"}var e=ev.G("aStop_"+T+"_"+i);if(e){e.style.backgroundColor="#cccccc"}this.preA=e}},_clearOverlays:function(){if(this._opts.renderOptions.map){this._opts.renderOptions.map.clearOverlays()}},_setStatus:function(e){if(typeof e=="number"){this._status=e}else{delete this._status}}});function dF(e){this["keyword"]=e.keyword||"";this["city"]=e.city;this["moreResultsUrl"]=e.moreUrl;this._listItems=e.listItems&&e.listItems.slice(0)||[];this._cityCode=e._cityCode}ev.extend(dF.prototype,{getBusListItem:function(e){if(this._listItems[e]){return this._listItems[e]}},getNumBusList:function(){return this._listItems.length}});function aw(e){this["name"]=e.name||"";this["startTime"]=e.startTime||"";this["endTime"]=e.endTime||"";this["company"]=e.company||"";this._polyline=e.polyline||{};this._stations=e.stations&&e.stations.slice(0)||[];this._poiType=e._poiType||2}ev.extend(aw.prototype,{getBusStation:function(e){if(this._stations[e]){return this._stations[e]}},getNumBusStations:function(){return this._stations.length},getPolyline:function(){return this._polyline},getPath:function(){if(this._polyline.getPath()){return this._polyline.getPath()}}});');
