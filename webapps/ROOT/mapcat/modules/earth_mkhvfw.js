/**/ï»¿_jsload&&_jsload('earth', '/*debugger;*/function cu(T,e){this._initStartTime=Date.now();cM.call(this);this.radius=500;this._map=T;e=e||{};this._zoom=1;this._center=new b9(0,0);this._heading=0;this._tilt=0;this._minZoom=1;this._maxZoom=T.getMaxZoom()-2;this._guid=bp.getGUID("earth_");this._enableTiltZoom=7;this._enableHeadingZoom=0;this._showRealSunlight=true;this._showMilkyway=true;this._earthBackground=null;this.zoomEventStatus="idle";this._preMoveendFired=true;this._animationInfo={};for(var i in e){if(typeof e[i]!=="undefined"){this["_"+i]=e[i]}}this._mProjection=ig;this._hotspots={length:0};this._layers=[];this._notLoadThumb=false;this._notLoadHigh=false;this.temp={};this._panes={};this._ratio=fD();this.zoomForNight=1;if(this._showRealSunlight===false){this.zoomForNight=0}this._streetLayerVisible=T._isHybridShow;if(this._zoom>15){this._calcRotationInfo()}this._init();this._initFinishTime=Date.now()}bp.Earth=cu;cu.MIN_TILT=0;cu.MAX_CENTER_LAT=90;cu.MIN_CENTER_LAT=-90;cu.RADIUS=6370996.81;cu.NORTH_POLE_LATLNG=new b9(90,0);cu.SOUTH_POLE_LATLNG=new b9(-90,0);cu.inherits(cM,"Earth");ev.extend(cu.prototype,{_init:function(){this._sphere=new dD(this,this.radius);this._createEarthCanvas();this._bootEarth();this._bindEvent();gt.earth=this;gt.initFPS();var e=this;setTimeout(function(){var je=gt.getAverageFPS();var T=gt.getHigherAverageFPS();var i=new fa("onfpsdata_ready");i.fps=je;i.fpsH=T;e.fire(i);gt.clearFPSData()},10000);setTimeout(function(){var je=gt.getAverageFPS();var T=gt.getHigherAverageFPS();var i=new fa("onfpsdata_ready");i.fps=je;i.fpsH=T;e.fire(i);gt.stopFPS()},30000)},_createEarthCanvas:function(){var jg=this._map;var je=jg.getSize();var T=je.width;var e=je.height;var i=jg.container;var jh=bL("canvas");var jf=jh.style;jf.zIndex=1;jf.position="absolute";jf.background="#000";jf.left=jf.top=0;jf.width=T+"px";jf.height=e+"px";jh.width=T*this._ratio;jh.height=e*this._ratio;gT(jh,jg.platform);this._container=i;this._containerSize=new h8(T,e);this._canvas=jh},_bootEarth:function(){this.scene=new hl(this);if(this._showMilkyway&&!this._earthBackground){this.scene.addRenderer(new dU(this))}if(this._earthBackground){this.scene.addRenderer(new a8(this))}this._atmosphereRenderer=new fn(this);this.scene.addRenderer(this._atmosphereRenderer);this.addLayer(new iS(this));if(this._streetLayerVisible===true){this._streetLayer=new iQ(this);this.addLayer(this._streetLayer);this.scene.addRenderer(new fH(this));this._labelLayer=new fP(this);this.addLayer(this._labelLayer)}else{var e=this._map._hideStreetLayerOptions;if(e&&e.hideStreet===false){this._streetLayer=new iQ(this);this.addLayer(this._streetLayer)}this.scene.addRenderer(new fH(this));if(e&&e.hideLabels===false){this._labelLayer=new fP(this);this.addLayer(this._labelLayer)}}this.scene.addRenderer(new fM(this));this._map._mouse.setEarthDrag(new ai(this._map,this));this._map._mouse.setEarthWheel(new cc(this._map,this))},_bindEvent:function(){var e=this;var i=e._map;i.on("resize",function(je){e._containerSize=je.size;e._imageZoom=null;e._imageRawZoom=null;var T=new fa("onsize_changed");T.size=je.size;e.fire(T)});this.on("statuschange",function(T){if(T.changedStatus.onzoom_changed){e._calcDragLatLimit();if(e._center.lat>cu.MAX_CENTER_LAT||e._center.lat<cu.MIN_CENTER_LAT){e.setCenter(e._center.clone(),{noAnimation:true})}}});this.on("ontilt_changed",function(){e._calcDragLatLimit();if(e._center.lat>cu.MAX_CENTER_LAT||e._center.lat<cu.MIN_CENTER_LAT){e.setCenter(e._center.clone(),{noAnimation:true})}})},setZoom:function(T,e){e=e||{};T=bW(T,this._minZoom,this._maxZoom);if(this._zoom===T){e.callback&&e.callback();return}var i=this;if(this.zoomEventStatus==="idle"){this.fire(new fa("onzoomstart"));this.zoomEventStatus="zooming"}if(e.noAnimation){this._setValue("zoom",T);if(e.renderCallback){e.renderCallback()}this._checkFireZoomend();return}this._animationInfo.zoom={current:this._zoom,diff:T-this._zoom,target:T};var i=this;e.callback=function(){i._checkFireZoomend()};if(e.opMethod==="mouseWheel"){this._startInfiniteZoomAnimation(e);return}this._startAnimation(e)},_checkFireZoomend:function(){var e=this;if(e.fireZoomendTimer){clearTimeout(e.fireZoomendTimer)}e.fireZoomendTimer=setTimeout(function(){if(e.zoomEventStatus==="zooming"){e.fire(new fa("onzoomend"));e.zoomEventStatus="idle"}e.fireZoomendTimer=null},50)},setImageZoom:function(i,e){this.setZoom(this._getEarthZoomByImgZoom(i),e)},_setValue:function(e,i){if(e==="zoom"){this._preZoom=this._zoom;this._imageZoom=null;this._imageRawZoom=null}this["_"+e]=i;if((e==="center"||e==="zoom")&&this._zoom>15){this._calcRotationInfo()}this.fire(new fa("on"+e+"_changed"))},_setValueTick:function(e,jf,je,i){if(e==="center"){var T=new b9(jf.lat+je.lat*i,jf.lng+je.lng*i);this._setValue(e,T);return}this._setValue(e,jf+je*i)},setCenter:function(e,i){i=i||{};e.lat=bW(e.lat,cu.MIN_CENTER_LAT,cu.MAX_CENTER_LAT);if(this._center.equals(e)){return}var T=this;if(!i.noFireEvent){if(this._preMoveendFired){T.fire(new fa("onmovestart"));this._preMoveendFired=false}i.mapNeedCbk=function(){T.fire(new fa("onmoveend"))}}if(i.stopCurrentAnimation&&this._ani){this._ani.stop(false,{stopCurrentAnimation:true})}if(i.noAnimation){this._center=e;if(this._zoom>15){this._calcRotationInfo()}this.fire(new fa("oncenter_changed"));if(!i.noFireEvent){this.fire(new fa("onmoving"));if(this._moveendTimer){clearTimeout(this._moveendTimer)}var T=this;this._moveendTimer=setTimeout(function(){T.fire(new fa("onmoveend"));T._preMoveendFired=true;T._moveendTimer=null},60)}if(i.callback){i.callback()}return}this._animationInfo.center={current:this._center,diff:e.sub(this._center)};this._startAnimation(i)},_calcRotationInfo:function(){var T=this._center;var jf=Math.sin(hM(T.lat));var je=Math.cos(hM(T.lat));var i=Math.sin(hM(-T.lng-180));var e=Math.cos(hM(-T.lng-180));this.rotationInfo=[jf,je,i,e]},setViewportIn:function(i,T){var e;if(i&&i.center){e=i}else{e=this.getViewportIn(i,T)}var je=e.earthZoom||e.zoom;T=T||{};if(this._ani){this._ani.stop(false,{stopCurrentAnimation:T.stopCurrentAnimation})}this.centerAndZoomIn(e.center,je,T.callback)},setHeading:function(je,i){i=i||{};if(je===this._heading){i.callback&&i.callback();return}var T=dM(this._heading,360);var e=dM(je,360);if(e===T){this._heading=je;return}if(i&&i.noAnimation){this._setValue("heading",je);i.callback&&i.callback();return}this._animationInfo.heading={current:this._heading,diff:je-this._heading};this._startAnimation(i)},resetHeading:function(e){var i=this._heading;while(i<0){i+=360}i=i%360;if(i>180){i-=360}this._heading=i;this.setHeading(0,e)},setTilt:function(e,i){i=i||{};if(e===this._tilt){i.callback&&i.callback();return}e=bW(e,cu.MIN_TILT,this._map.getCurrentMaxTilt());if(i.noAnimation){this._setValue("tilt",e);i.callback&&i.callback();return}this._animationInfo.tilt={current:this._tilt,diff:e-this._tilt};this._startAnimation(i)},centerAndZoomIn:function(e,je,jf){je=bW(je,this._minZoom,this._maxZoom);e.lat=bW(e.lat,cu.MIN_CENTER_LAT,cu.MAX_CENTER_LAT);var i=bp.EarthAnimation.start(this,e,je,jf);if(i===false){var T={noAnimation:true};this.setCenter(e,T);this.setZoom(je,T);jf&&jf()}},mathLog2:function(e){return Math.log(e)/Math.log(2)},getViewportIn:function(js,jh){var jm;if(js.length>0){jm=new cm();for(var jt=0,jq=js.length;jt<jq;jt++){jm.extend(js[jt])}}else{if(js instanceof cm){jm=js}else{return{center:this.getCenter(),zoom:this.getZoom(),imageZoom:this.getImageZoom()}}}jh=jh||{};var e=jh.margins||[10,10,10,10];var ji=jh.zoomFactor||0;var ju=e[1]+e[3];var jf=e[0]+e[2];var jp=jm.getSouthWest();var jk=jm.getNorthEast();var jo=jk.lat-jp.lat;var jx=ig.convertLL2MC(jp);var T=ig.convertLL2MC(jk);var jl=new hf(jx,T);var jv;if(jh.mapCenter){jv=ig.convertMC2LL(jh.mapCenter)}else{jv=jm.getCenter()}var jg=jl.toSpan();var je=jg.width/(this._containerSize.width-ju);var jj=jg.height/(this._containerSize.height-jf);var jn=je>jj?je:jj;var jr=18-this.mathLog2(jn);var jw=Math.floor(jr);jw+=ji;return{center:jv,zoom:jw}},getZoom:function(){return this._zoom},zoomIn:function(e){this.setZoom(this.getZoom()+1,e)},zoomOut:function(e){this.setZoom(this.getZoom()-1,e)},getCenter:function(){return this._center},getHeading:function(){return this._heading},getTilt:function(){return this._tilt},getContainerSize:function(){return this._containerSize},getContainer:function(){return this._container},fromPixelToLatLng:function(i,e){return this.scene.fromPixelToLatLng(i,e)},fromLatLngToPixel:function(T,i){i=i||{};var e=this.scene.fromLatLngToPixel(T,i);if(!i.useRound){return e}e.x=Math.round(e.x);e.y=Math.round(e.y);return e},ifLatLngInView:function(i){var e=this.scene.fromLatLngToXYZ(i);return this.scene.ifXYZInView(e[0],e[1],e[2])},saveMatrixInfo:function(){this.scene.saveMatrixInfo()},getBounds:function(){return this.scene.getBounds()},getCustomBounds:function(){return this.scene.getCustomBounds()},getProjection:function(){return this._mProjection},getSunZenith:function(){return this.scene._camera.getSunZenith()},_startAnimation:function(i){var je=this._animationInfo;var T=this;i=i||{};if(T._ani){T._ani.stop(!!i.goToEnd,{stopCurrentAnimation:i.stopCurrentAnimation})}if(T._infiniteAni){T._infiniteAni.stop();T._infiniteAni=null}var jf=i.duration||500;var jg=i.transition||fY.easeOutQuad;var e=new fa("onanimation_start");this.fire(e);T._ani=new e3({duration:jf,transition:jg,render:function(jj,ji){for(var jh in je){var jl=je[jh].current;var jk=je[jh].diff;T._setValueTick(jh,jl,jk,jj)}if(i.renderCallback){i.renderCallback()}},finish:function(){T.fire(new fa("onanimation_end"));T._animationInfo={};T._ani=null;if(i.mapNeedCbk){i.mapNeedCbk()}if(i.callback){i.callback()}},onStop:function(jh){jh=jh||{};T.fire(new fa("onanimation_end"));if(jh.stopCurrentAnimation){T._animationInfo={}}T._ani=null;if(jh.mapNeedCbk){jh.mapNeedCbk()}if(jh.callback){jh.callback()}}})},_startInfiniteZoomAnimation:function(i){var je=this._animationInfo;var T=this;i=i||{};if(T._ani){T._ani.stop(!!i.goToEnd,{stopCurrentAnimation:i.stopCurrentAnimation})}if(T._infiniteAni){return}var e=new fa("onanimation_start");this.fire(e);T._infiniteAni=new e3({duration:10000,transition:fY.linear,render:function(jh,jg){var jf=T._animationInfo.zoom;if(Math.abs(jf.current-jf.target)<0.001){T._setValue("zoom",jf.target);T._infiniteAni.stop();return}jf.current+=(jf.target-jf.current)*0.35;T._setValue("zoom",jf.current);if(i.renderCallback){i.renderCallback()}},finish:function(){T._infiniteAni=null;T._animationInfo={};T.fire(new fa("onanimation_end"));if(i.callback){i.callback()}},onStop:function(){T._infiniteAni=null;T._animationInfo={};T.fire(new fa("onanimation_end"));if(i.callback){i.callback()}}})},_generateTmpPMatrix:function(i){var je=mat4.create(Float64Array);mat4.identity(je);var T=this.getContainerSize();this._widthHeightRatio=T.width/T.height;i=i||this.getZoom();var e;if(i<=3){e=70-10*i}else{e=40}mat4.perspective(je,hM(e),this._widthHeightRatio,0.01,6000);return je},_generateTmpMVMatrix:function(e,jh,ji,jj){var T=mat4.create(Float64Array);mat4.identity(T);jh=jh||this.getZoom();var i;if(jh<=3){i=3.4*this.radius-0.8*this.radius*jh}else{i=this.radius/Math.pow(2,jh-3)}mat4.translate(T,T,[0,0,-i]);if(typeof ji!=="number"){ji=this.getTilt()}if(ji!==0&&jh<6){if(jh>=4){ji=(1-(6-jh)/2)*ji}else{ji=0}}if(ji!==0){mat4.rotate(T,T,hM(ji),[-1,0,0])}if(typeof jj!=="number"){jj=this.getHeading()%360}else{jj=jj%360}mat4.translate(T,T,[0,0,-this.radius]);if(jj!==0){mat4.rotate(T,T,hM(jj),[0,0,-1])}e=e||this.getCenter();var jf=e.lat;mat4.rotate(T,T,hM(jf),[1,0,0]);var je=180;var jg=e.lng;mat4.rotate(T,T,hM(je+jg),[0,-1,0]);return T},addLayer:function(je){var jf=new fa("onlayer_add");jf.layer=je;for(var T=0;T<this._layers.length;T++){if(this._layers[T]===je){return}}this._layers.push(je);this.fire(jf)},removeLayer:function(je){var jf=new fa("onlayer_remove");jf.layer=je;for(var T=0;T<this._layers.length;T++){if(this._layers[T]===je){this._layers.splice(T,1);this.fire(jf);return}}},addHotspot:function(e){if(!this._hotspots[e.guid]){this._hotspots[e.guid]=e;this._hotspots.length++}e.initialize(this);this.fire(new fa("onhotspot_add"))},removeHotspot:function(e){if(this._hotspots[e.guid]){delete this._hotspots[e.guid];this._hotspots.length--}this.fire(new fa("onhotspot_remove"))},setNotLoadThumb:function(e){this._notLoadThumb=e},setNotLoadHigh:function(e){this._notLoadHigh=e},getDistance:function(jg,e){var T=hM(jg.lng);var jf=hM(jg.lat);var i=hM(e.lng);var je=hM(e.lat);return cu.RADIUS*Math.acos((Math.sin(jf)*Math.sin(je)+Math.cos(jf)*Math.cos(je)*Math.cos(i-T)))},getImageZoom:function(ji){if(ji!==true&&this._imageZoom){return this._imageZoom}var i=this._containerSize.width;var jn=this._containerSize.height;var jh=jn/6;var jk=null;var e=new b9(39,116);if(this._zoom<=3){e=new b9(0,0);jk=this._generateTmpPMatrix(this._zoom)}var je=this._generateTmpMVMatrix(e,this.getZoom(),0,0);var jl=this.fromPixelToLatLng(new eO(i/2,jn/2-jh),{matrixInfo:{modelViewMatrix:je,projectionMatrix:jk}});var T=this.fromPixelToLatLng(new eO(i/2,jn/2+jh),{matrixInfo:{modelViewMatrix:je,projectionMatrix:jk}});var jg=ig.convertLL2MC(jl);var jm=ig.convertLL2MC(T);var jf=Math.abs(jg.lat-jm.lat);var jo=this._imageRawZoom=18-this.mathLog2(jf/jn*3);if(ji===true){return jo}var jj=(jo*10)%10>=7?Math.ceil(jo):Math.floor(jo);if(jj-this._zoom>2.5){jj=Math.floor(this._zoom+2)}this._imageZoom=jj;if(this._imageZoom>19){this._imageZoom=19}if(this._imageZoom<3){this._imageZoom=3}return this._imageZoom},getMapZoom:function(){return this.getImageZoom(this._map._renderType==="webgl")},_getEarthZoomByImgZoom:function(jp,jr,jh){var jn=this._containerSize.width;var jm=this._containerSize.height;jr=jr||this._center;if(!jh){var jk=ig.convertLL2MC(jr);var jj=jm/3*Math.pow(2,18-jp);var jt=new cf(jk.lng,jk.lat-jj/2);var i=new cf(jk.lng,jk.lat+jj/2);jh=ig.convertMC2LL(i).lat-ig.convertMC2LL(jt).lat}var je;var jq=180;var e=jm/3;var T=2/3*jm;for(var jf=jp;jf>=jp-3;jf-=0.1){var jg=null;if(jf<3&&this._zoom>=3||jf>=3&&this._zoom<3){this._generateTmpPMatrix(jf)}var ji=this._generateTmpMVMatrix(jr,jf,0,0);var js=this.fromPixelToLatLng(new eO(jn/2,e),{matrixInfo:{modelViewMatrix:ji,projectionMatrix:jg}});var jo=this.fromPixelToLatLng(new eO(jn/2,T),{matrixInfo:{modelViewMatrix:ji,projectionMatrix:jg}});var jl=Math.abs((js.lat-jo.lat)-jh);if(jl<jq){jq=jl}else{break}}jf+=0.1;if(jf<1){jf=1}else{if(jf>this._maxZoom){jf=this._maxZoom}}return jf},getEarthCanvas:function(){return this._canvas},getMap:function(){return this._map},showStreetLayer:function(){if(this._streetLayerVisible===true){return}this._streetLayerVisible=true;this.addLayer(this._streetLayer);this.addLayer(this._labelLayer);this._map.fire(new fa("onstreetlayer_show"))},hideStreetLayer:function(e){if(this._streetLayerVisible===false){return}this._streetLayerVisible=false;e=e||{hideLabels:true,hideStreet:true};if(e.hideLabels){this.removeLayer(this._labelLayer)}if(e.hideStreet){this.removeLayer(this._streetLayer)}this._map.fire(new fa("onstreetlayer_hide"))},startSunLightAnimation:function(){bp.EarthAnimation.startSunLightAnimation(this)},stopSunLightAnimation:function(e){bp.EarthAnimation.stopSunLightAnimation(this,e)},setTimeForSunLight:function(i,T){if(i===null){this._timeForSunLight=null;this.fire(new fa("onsunlighttime_clear"));return}this._timeForSunLight={hour:i,minute:T};var e=new fa("onsunlighttime_change");e.timeForSunLight=this._timeForSunLight;this.fire(e)},getDeviceInfo:function(){return this._deviceInfo},setLock:function(e){this._lock=e},getLock:function(){return this._lock},_calcDragLatLimit:function(){var jf=this.scene._camera.getEarthRadiusOnScreen();var i=this.getContainerSize().height/2;var je;if(jf>i){je=30}else{cu.MAX_CENTER_LAT=46;cu.MIN_CENTER_LAT=-46;return}var e=new b9(0,0);var T=this._generateTmpMVMatrix(e,0,0,0);var ji=null;if(this._zoom<=3){ji=this._generateTmpPMatrix(this._zoom)}var jh=this.fromPixelToLatLng(new eO(this.getContainerSize().width/2,je),{matrixInfo:{modelViewMatrix:T,projectionMatrix:ji}});if(!jh){return}var jg=jh.sub(e);cu.MAX_CENTER_LAT=90-Math.abs(jg.lat);cu.MIN_CENTER_LAT=-90+Math.abs(jg.lat)},zoomWithMousePosFix:function(je,ji,jj){if(je<1.3&&jj&&jj.opMethod==="mouseWheel"){je=1}var e=this.fromPixelToLatLng(ji);var jf={from:"mouse"};jj=jj||{};ev.extend(jf,jj);if(!e){this.setZoom(je,jf);return}var i=this.getCenter().clone();var jg=this;var jh=null;if(je<=3){jh=jg._generateTmpPMatrix(je)}var T=jg.fromPixelToLatLng(ji,{matrixInfo:{modelViewMatrix:jg._generateTmpMVMatrix(i,je),projectionMatrix:jh}});if(!T){this.setZoom(je,jf);return}jf.renderCallback=function(){var jo=null;var jm=jg.getZoom();if(jm<=3){jo=jg._generateTmpPMatrix(jm)}var jn=jg.fromPixelToLatLng(ji,{matrixInfo:{modelViewMatrix:jg._generateTmpMVMatrix(i,jm),projectionMatrix:jo}});if(jn){var jl=jn.sub(e);var jk=new b9(i.lat-jl.lat,i.lng-jl.lng);jg.setCenter(jk,{noAnimation:true,from:"mouse",noFireEvent:true})}};this.setZoom(je,jf)}});function b4(){}bp.EarthView=b4;ev.extend(b4.prototype,{centerAndZoomIn:function(e,je){if(!e&&!je){return}e=e||this.centerPoint;je=je||this.zoomLevel;je=this._getProperZoom(je).zoom;var i=ig.convertMC2LL(e);var T=this._earth._getEarthZoomByImgZoom(je,i);this._earth.centerAndZoomIn(i,T)},zoomTo:function(jf,i){var je=i;if(!je&&this.temp.infoWin&&this.temp.infoWin.isOpen()){je=this.getInfoWindow().getPoint()}if(je){var e=this.pointToPixelIn(je);var T=this._earth._getEarthZoomByImgZoom(jf);this._earth.zoomWithMousePosFix(T,e)}else{this._earth.setImageZoom(jf)}},deepZoomMedia:function(e){var i=this;if(!i.temp.isStdCtrlBusy){i.temp.isStdCtrlBusy=true;i.deepZoomTo(i.zoomLevel+e);setTimeout(function(){i.temp.isStdCtrlBusy=false},400)}},deepZoomTo:function(e){this.zoomTo(e)},flyToIn:function(e,je){if(!je||je===this.zoomLevel){this.panToIn(e);return}var T=ig.convertMC2LL(e);var i=this._earth._getEarthZoomByImgZoom(je,T);this._earth.centerAndZoomIn(T,i)},panToIn:function(e,je){if(!e||e.toString()!=="Point"){return}if(e.equals(this.centerPoint)){return}var i=new eO(this.width/2,this.height/2);var T=ig.convertMC2LL(e);e._llPt=T;var jf=this.pointToPixelIn(e);je=je||{};if(Math.abs(i.x-jf.x)>this.width||Math.abs(i.y-jf.y)>this.height||je.noAnimation===true){this._earth.setCenter(T,{noAnimation:true,callback:je.callback})}else{this._earth.setCenter(T,je)}},panBy:function(jm,ji,jl){var jg=this._earth.getCenter();var jk=this.getSize();jl=jl||{};var je;if(!jl.point){je=new eO(jk.width/2+jm,jk.height/2+ji)}else{var jf=ig.convertMC2LL(jl.point);var jj=this._earth.fromLatLngToPixel(jf);je=new eO(jj.x+jm,jj.y+ji);jg=new b9(jf.lat,jf.lng)}var jh=this._earth.fromPixelToLatLng(je);var T=jh.sub(jg);var e=this._earth.getCenter();var i=new b9(e.lat-T.lat,e.lng-T.lng);this._earth.setCenter(i,jl)},getCenterIn:function(){var e=this._earth.getCenter();return ig.convertLL2MC(e)},getZoom:function(){if(this._renderType==="webgl"){return this._earth.getImageZoom(true)}return this._earth.getImageZoom()}});var g3={_zoomAni:null,_zoomAni2:null,_posAni:null,start:function(je,i,jo,jk){var jq=je.getCenter();var T=je.getZoom();if(i.equals(je.getCenter())&&jo!==je.getZoom()){je.setZoom(jo,{callback:jk});return{}}var ji=je.getDistance(i,jq)/1000;if(ji<100&&jo!==je.getZoom()){return false}if(ji<100&&jo===je.getZoom()){je.setCenter(i,{callback:jk});return{}}if(i.equals(je.getCenter())&&jo===je.getZoom()){return false}je.setLock(true);var jr=null;var jl=null;var jf=new b9((jq.lat+i.lat)/2,(jq.lng+i.lng)/2);jr=je._generateTmpMVMatrix(jf,jo);if(jo<=3){jl=je._generateTmpPMatrix(jo)}var jg={matrixInfo:{modelViewMatrix:jr,projectionMatrix:jl}};var ju=je.fromLatLngToPixel(jq,jg);var jm=je.fromLatLngToPixel(i,jg);var jh=Math.sqrt(Math.pow(ju.x-jm.x,2)+Math.pow(ju.y-jm.y,2));var jj=jo;while(jh>350){jj-=1;jh/=2}jj=jj<1.1?1.1:jj;jj=jj>17?17:jj;var jp=Math.min(Math.min(jj,T),jo);var jt=jp-T;var jv=jo-jp;var jw=i.sub(jq);var js=1100;var e=1200;var jn=2000;je.setNotLoadHigh(true);if(g3._zoomAni){g3._zoomAni.stop()}g3._zoomAni=new e3({duration:js,transition:fY.easeOutCubic,render:function(jy,jx){if(jx>0.8){je.setNotLoadThumb(false)}if(T+jt*jy<1){throw"error"}je._setValue("zoom",T+jt*jy)},finish:function(){g3._zoomAni=null},onStop:function(jx){g3._zoomAni=null}}).append(function(){g3._zoomAni2=new e3({duration:e,delay:1100,transition:fY.easeInCubic,render:function(jy,jx){if(jx>0.8){je.setNotLoadThumb(false)}if(jp+jv*jy<1){throw"error"}je._setValue("zoom",jp+jv*jy)},finish:function(){je.setNotLoadHigh(false);je._setValue("zoom",jo);g3._zoomAni2=null;jk&&jk();je.setLock(false);je.fire(new fa("oncenterandzoom"))},onStop:function(jx){g3._zoomAni2=null;jk&&jk();je.setLock(false);je.fire(new fa("oncenterandzoom"))}})});if(g3._posAni){g3._posAni.stop()}g3._posAni=new e3({duration:jn,delay:500,transition:fY.easeInOutQuad,render:function(jy,jx){je._setValue("center",new b9(jq.lat+jw.lat*jy,jq.lng+jw.lng*jy))},finish:function(){g3._posAni=null},onStop:function(jx){g3._posAni=null}});return{zoomAniStart:g3._zoomAni,zoomAniEnd:g3._zoomAni2,posAni:g3._posAni}},stop:function(){g3._zoomAni&&g3._zoomAni.stop();g3._zoomAni2&&g3._zoomAni2.stop();g3._posAni&&g3._posAni.stop();g3._zoomAni=g3._zoomAni2=g3._posAni=null},startFirstAnimation:function(jm){var jl=false;try{jl=!!window.localStorage.getItem("show_first_earth_ani")}catch(ji){jl=true}if(jl){return false}var je=jm.getCenter();var jo=jm.getZoom();var T=jm.getSunZenith();var i=new b9(-T.lat,T.lng+180);var jn=je.sub(i);jm._firstAni=true;jm.setLock(true);jm.setZoom(jm.zoomForNight,{noAnimation:true});jm.setCenter(i,{noAnimation:true});var jf=6000;var jk=3000;var jj=jf+1700;var jg=new e3({duration:jf,delay:1600,transition:fY.easeInOutQuad,render:function(e){jm.setCenter(new b9(i.lat+jn.lat*e,i.lng+jn.lng*e),{noAnimation:true})}});var jh=new e3({duration:jk,delay:jj,transition:fY.easeInOutQuad,render:function(e){if(e>0.2&&e<0.4){jm.setNotLoadHigh(true)}jm.setZoom(jm.zoomForNight+(jo-jm.zoomForNight)*e,{noAnimation:true})},finish:function(){jm.setNotLoadHigh(false);jm._firstAni=false;jm.zoomForNight=1;jm.setLock(false)},onStop:function(){jm.setNotLoadHigh(false);jm._firstAni=false;jm.zoomForNight=1;jm.setLock(false)}});try{window.localStorage.setItem("show_first_earth_ani",true)}catch(ji){}return{firstCenterAni:jg,firstZoomAni:jh}},startSunLightAnimation:function(jh){if(this._sunLightAni){return}if(jh.getLock()){return}this._originCenter=new b9(jh.getCenter().lat,jh.getCenter().lng);this._originZoom=jh.getZoom();var T=jh.getSunZenith();var jg=new b9(T.lat,T.lng-90);var je=this;var i=new Date();var e=i.getHours();var jf=i.getMinutes()-0.5;if(jf<0){jf+=60;e--}jh.setLock(true);jh.centerAndZoomIn(jg,jh.zoomForNight,function(){jh.setLock(false);if(je._sunLightAni){return}je._sunLightAni=new e3({duration:9999999,render:function(ji){jf+=0.5;if(jf===60){jf=0;e++}jh.setTimeForSunLight(e,jf);jg.lng=jh.getSunZenith().lng-90;jh.setCenter(new b9(jg.lat,jg.lng),{noAnimation:true});if(jh._zoom!==jh.zoomForNight){je.stopSunLightAnimation(jh,true)}}})})},stopSunLightAnimation:function(i,e){if(!this._sunLightAni){return}if(i.getLock()){return}this._sunLightAni.stop();this._sunLightAni=null;if(e){i.setTimeForSunLight(null);return}i.setLock(true);i.centerAndZoomIn(this._originCenter,this._originZoom,function(){i.setLock(false);i.setTimeForSunLight(null)})}};bp.EarthAnimation=g3;function af(T){var i=T.getExtension("WEBGL_debug_renderer_info");if(!i){return null}var je=T.getParameter(i.UNMASKED_VENDOR_WEBGL);var e=T.getParameter(i.UNMASKED_RENDERER_WEBGL);return{vendor:je,renderer:e}}var gt={_fps:0,fps:0,currentTime:null,preFrameTimeStamp:Date.now(),fpsArr:[],averageFPS:0,higherAverageFPS:0,averageTimeInterval:30,initFPS:function(){gt._fps++;gt.currentTime=Date.now();if(gt.currentTime-gt.preFrameTimeStamp>=1000){gt.fps=gt._fps;gt.fpsArr.push(gt.fps);if(gt.fpsArr.length===gt.averageTimeInterval){gt._calcAverageFPS()}gt._fps=0;gt.preFrameTimeStamp=gt.currentTime;var e=new fa("onfpstick");e.fps=gt.fps;gt.earth._map.fire(e)}gt.timer=requestAnimationFrame(gt.initFPS)},_calcAverageFPS:function(){var je=0;var e=0;gt.fpsArr.sort(function(jg,i){return i-jg});var jf=gt.fpsArr.length*0.8;for(var T=0;T<gt.fpsArr.length;T++){if(T===jf){e=je}je+=gt.fpsArr[T]}gt.averageFPS=Math.round(je/gt.fpsArr.length);gt.higherAverageFPS=Math.round(e/jf);gt.fpsArr=[]},getAverageFPS:function(){if(gt.averageFPS===0){gt._calcAverageFPS()}return gt.averageFPS},getHigherAverageFPS:function(){if(gt.higherAverageFPS===0){gt._calcAverageFPS()}return gt.higherAverageFPS},stopFPS:function(){if(gt.timer){cancelAnimationFrame(gt.timer);gt.timer=null}},clearFPSData:function(){gt.averageFPS=0;gt.higherAverageFPS=0}};function dD(je,e,T){this._earth=je;var i=this._mcPrj=je.getProjection();this._radius=e;this._options={};T=T||{};ev.extend(this._options,T);this._rowPrecisionPerTile=1;this._colPrecisionPerTile=1;this._mc180Pt=i.convertLL2MC(new b9(0,180));this._mcM180Pt=i.convertLL2MC(new b9(0,-180));this._mcMergeY=8388608;this._mcNorthLat=74;this._mcSouthLat=-60;this._polarModelsCache={1:{n:null,s:null},2:{n:null,s:null},3:{n:null,s:null}};this._ERTileModelInfo=null;this._mergedTilesCache={}}dD.totalTileCount=0;dD.cachedTileCount=0;dD._tileModelInfoCache=new hn(1000,{removeOldCallback:function(){if(window.map&&window.map._earth){var i=new fa("ontilemodelcache_full");i.cacheUsage=dD.cachedTileCount/dD.totalTileCount;window.map._earth.dispatchEvent(i)}}});dD.getMergedKey=function(e,je,i){var T=dD.getMergedColRow(i,e,je);return["key_merge",T[0],T[1],i].join("_")};dD.getMergedColRow=function(i,e,T){return[Math.floor(e/2),Math.floor(T/2)]};dD.getMergedTextureOffset=function(e,T){var i=[];i[0]=(Math.abs(e)%2)/2;i[1]=(Math.abs(T)%2)/2;return i};ev.extend(dD.prototype,{getCurViewModels:function(i,jh,jl){var jj=this._earth.getImageZoom();var jg=this.getTileModels(i,jh,jl,jj);var je=jg[0];var jf=jg[1];if(i._addBounds){jg=this.getTileModels(i._addBounds,jh,jl,jj);je=je.concat(jg[0])}var ji=this.removeExtraTiles(je)||[];var jk=this.mergeTiles(ji)||[];if(jl<this._earth.zoomForNight+1){var e=this.getERTileModels();this._sortByImgZoom(jk);var T=jk.concat(e);this._generateNormalModels(ji);return T}if(jk.length>300){jk=jk.slice(0,300)}this._sortByImgZoom(jk);this._sortByImgZoom(ji);this._generateNormalModels(ji,jf);return jk},_generateNormalModels:function(jf,T){var e=jf.slice(0);for(var je=e.length-1;je>=0;je--){if(e[je].key&&e[je].key.indexOf("_er_")>0){e.splice(je,1);continue}}this._curViewNormalModels=e;this._curViewNormalNAModels=T},getCurViewNormalModels:function(e){if(!e||e.getName()==="web"){return this._curViewNormalModels}return this._curViewNormalNAModels},removeExtraTiles:function(ju){var js=ju.slice(0);var T=this._earth;var jG=T.getBounds();var e=T.getZoom();var je=T.getContainerSize();var jg=T.getImageZoom();var jk=this._mcPrj;if(e>2&&e<6&&jG.holeAtTopLeft||js.length>90){var jE=250;var jw=230;for(var jD=js.length-1;jD>=0;jD--){if(!js[jD].bounds){continue}js[jD].atEdge=false;var jB=js[jD].bounds[0];var jx=js[jD].bounds[1];var jo=new cf(jx.lng,jB.lat);var jz=new cf(jB.lng,jx.lat);var jF=new cf((jB.lng+jx.lng)/2,(jB.lat+jx.lat)/2);var jp=jk.convertMC2LL(jF);var jm=T.scene.fromLatLngToXYZ(jp);var jl=T.scene.fromLatLngToPixel(jp);var jh=T.scene.ifXYZOnBack(jm.x,jm.y,jm.z,jE);if(jh){js.splice(jD,1);continue}jh=T.scene.ifXYZOnBack(jm.x,jm.y,jm.z,-50);if(jh){if(js[jD].imgZoom===jg){js[jD].atEdge=true}continue}if(jl.x<0-jw||jl.x>je.width+jw||jl.y<0-jw||jl.y>je.height+jw){js.splice(jD,1);continue}if(jl.x<50||jl.x>je.width-50||jl.y<50||jl.y>je.height-50){if(js[jD].imgZoom===jg){js[jD].atEdge=true}}}return js}if((T.getTilt()===0&&T.getHeading()%90===0)||T.getZoom()<5){return js}var jf=jG.pointBottomLeft;var jA=jG.pointTopRight;var jr=jG.pointTopLeft;var jn=jG.pointBottomRight;if(!jf||!jA||!jr||!jn){return js}for(var jD=js.length-1;jD>=0;jD--){if(!js[jD].bounds){continue}var jB=js[jD].bounds[0];var jx=js[jD].bounds[1];var jo=new cf(jx.lng,jB.lat);var jz=new cf(jB.lng,jx.lat);var jF=new cf((jB.lng+jx.lng)/2,(jB.lat+jx.lat)/2);var jp=jk.convertMC2LL(jF);var jm=T.scene.fromLatLngToXYZ(jp);var jj=T.scene.ifXYZInView(jm.x,jm.y,jm.z);var jt=[jz,jx,jo,jB];if(!jj){var ji=false;for(var jy=0,jq=jt.length;jy<jq;jy++){var jv=jy+1;if(jv===jq){jv=0}var jC=jy;var jH=ie(jt[jv],jt[jC],jr,jf);if(jH){ji=true;break}jH=ie(jt[jv],jt[jC],jn,jA);if(jH){ji=true;break}jH=ie(jt[jv],jt[jC],jA,jr);if(jH){ji=true;break}jH=ie(jt[jv],jt[jC],jf,jn);if(jH){ji=true;break}}if(ji===true){continue}js.splice(jD,1)}}return js},mergeTiles:function(T){var e=this._mergedTilesCache;var jg=[];for(var jk=T.length-1;jk>=0;jk--){var jl=T[jk];var jn=jl.imgZoom;if(jn>5||jl.projType==="er"){continue}var jf=jl.col;var jp=jl.row;var jj=dD.getMergedKey(jf,jp,jn);if(!e[jj]){var jh=dD.getMergedColRow(jn,jf,jp);e[jj]={key:jj,vertex:[],index:[],texture:null,textureCoord:[],mergedTile:true,col:jh[0],row:jh[1],imgZoom:jn,useZoom:jl.useZoom,tileCount:0,mergeInfo:[]}}var je=e[jj];if(!je.mergeInfo[jf+"_"+jp]){var ji=this.addOffsetToIndex(jl.index,je.vertex.length);je.vertex=je.vertex.concat(jl.vertex);je.index=je.index.concat(ji);var jm=dD.getMergedTextureOffset(jf,jp);var jo=this.addOffsetToTexCoords(jl.textureCoord,jm);je.textureCoord=je.textureCoord.concat(jo);je.tileCount++;je.mergeInfo[jf+"_"+jp]=true;je.textureCoord._dir=jl.textureCoord._dir}if(!jg[jj]){jg.push(je);jg[jj]=true}jl.loadTextureOnly=true;jl.mergedKey=jj;jl.mergedCol=je.col;jl.mergedRow=je.row;jl.textureOffset=jm}return T.concat(jg)},addOffsetToIndex:function(e,jg){var je=[];jg=jg/3;for(var T=0,jf=e.length/3;T<jf;T++){je[T*3]=e[T*3]+jg;je[T*3+1]=e[T*3+1]+jg;je[T*3+2]=e[T*3+2]+jg}return je},addOffsetToTexCoords:function(T,jf){var je=[];for(var e=0;e<T.length;e+=2){je[e]=T[e]/2+jf[0];je[e+1]=T[e+1]/2+jf[1]}return je},getTileModels:function(i,jh,jq,jj){var jm=this._earth;var jg=i.getSouthWest();var jl=i.getNorthEast();var T=jq>3?3:jq;var jf=[];if(jl.lat>this._mcNorthLat||jh==="n"){jf=this.getPolarTileModels(T,"n")}var jo=Math.max(Math.min(this._mcNorthLat,jl.lat),this._mcSouthLat);var jn=Math.min(Math.max(this._mcSouthLat,jg.lat),this._mcNorthLat);var jp=new cm(new b9(jn,jg.lng),new b9(jo,jl.lng));var e;if(i.useLOD){e=this.getLODTileModels(jp,jh,jq,jj)}else{e=this._getTileModels(jp,jh,jq,jj)}var je=e[0];var ji=e[1];var jk=[];if(jg.lat<this._mcSouthLat||jh==="s"){jk=this.getPolarTileModels(T,"s")}return[je.concat(jf).concat(jk),ji]},_getTileModels:function(jl,jk,T,jz){var jq=jl.getSouthWest();var jg=jl.getNorthEast();var jx=this._earth.getCenter();var jw=this._mcPrj.convertLL2MC(jx);var je=Math.pow(2,18-jz);var jf={col:Math.floor(jw.lng/je/256),row:Math.floor(jw.lat/je/256)};var jj=hg.getInstance("na");var jt=jj.getDataZoom(jz);var ju=jj.getMercatorSize(jz,jt);var e={col:Math.floor(jw.lng/ju),row:Math.floor(jw.lat/ju)};var jv=hg.getInstance("web");var jj=hg.getInstance("na");if(jq.lng>jg.lng){var jo=new cm(new b9(jq.lat,jq.lng),new b9(jg.lat,180));var jr=new cm(new b9(jq.lat,-180),new b9(jg.lat,jg.lng));var jp=this.__getTileModels(jo,jk,T,jz,"left",jv);var jn=this.__getTileModels(jr,jk,T,jz,"right",jv);var ji=jp.concat(jn);ji=this._sortByCenter(ji,jf);var jh=this.__getTileModels(jo,jk,T,jz,"left",jj);var jm=this.__getTileModels(jr,jk,T,jz,"right",jj);var js=jh.concat(jm);js=this._sortByCenter(js,e);return[ji,js]}var jy=this.__getTileModels(jl,jk,T,jz,null,jv);jy=this._sortByCenter(jy,jf);var i=this.__getTileModels(jl,jk,T,jz,null,jj);i=this._sortByCenter(i,e);return[jy,i]},_sortByImgZoom:function(e){e.sort(function(T,i){if(T.projType==="er"){return 1}if(i.projType==="er"){return-1}return T.imgZoom-i.imgZoom});return e},_sortByCenter:function(e,jl){if(e.length===0){return e}var jj=e[0].col;var jm=e[0].col;var jg=e[0].row;var ji=e[0].row;for(var je=0,T=e.length;je<T;je++){var jf=e[je];if(jf.col<jj){jj=jf.col}if(jf.col>jm){jm=jf.col}if(jf.row<jg){jg=jf.row}if(jf.row>ji){ji=jf.row}}var jk=jl.col;var jh=jl.row;e.sort(function(jn,i){var jp=Math.pow((jn.col-jk),2)+Math.pow((jn.row-jh),2);var jo=Math.pow((i.col-jk),2)+Math.pow((i.row-jh),2);return jp-jo});return e},__getTileModels:function(jC,jr,jL,je,jm,jo){var jq=this;var T=jq._earth;var jk=this._mcPrj;var jx=jC.getSouthWest();var jn=jC.getNorthEast();var ji=jo.getDataZoom(je);var jy=jo.getTileSize(je);var jE=jo.getMercatorSize(je,ji);if(jL>4){jr=false}var jR=jk.convertLL2MC(jx);var jI=jk.convertLL2MC(jn);var jH=jR.lng;var jv=jI.lng;var jG=jR.lat;var ju=jI.lat;var jA=Math.floor(jH/jE);var jK=Math.floor(jv/jE);var jD=Math.floor(jG/jE);var jU=Math.floor(ju/jE);var jf=jk.convertLL2MC(jC.getCenter());var jt=Math.floor(jf.lat/jE);var jP=jD;var jl=jU;if(jr){var jw=jk.convertLL2MC(new b9(this._mcSouthLat,-180));var jF=jk.convertLL2MC(new b9(this._mcNorthLat,180));var jS=Math.floor(jw.lng/jE);var jQ=Math.floor(jw.lat/jE);var jM=Math.floor(jF.lng/jE);var jp=Math.floor(jF.lat/jE);if(jr==="n"){jl=jp}else{if(jr==="s"){jP=jQ}}}var jT=[];var jj=jq._colPrecisionPerTile;var jz=jq._rowPrecisionPerTile;if(je<=7){jj=jz=Math.pow(2,7-je)}var jB=this._mcMergeY;for(var jO=jP;jO<=jl;jO++){var jJ=jA;var jg=jK;if((jr==="n"&&jO>=Math.min(jD,jt))||(jr==="s"&&jO<=Math.max(jU,jt))){if(jm==="left"){jJ=jS;jg=-1}else{if(jm==="right"){jJ=0;jg=jM}else{jJ=jS;jg=jM}}}for(var jN=jJ;jN<=jg;jN++){var e=jO*jE;var js="key_"+jo.getName()+"_"+jN+"_"+jO+"_"+je+"_"+ji;var jh;if((e>=jB||e+jE<-jB)&&je>3){jh=this._createTileModel(js,jO,jN,je,ji,jE,jo,jj,jz)}else{jh=this._createTileModel(js,jO,jN,je,ji,jE,jo,jj,jz)}if(!jT[jh.key]){jT.push(jh);jT[jh.key]=true}}}return jT},_createTileModel:function(jA,jr,jq,jx,jk,e,T,jv,jt){var js=null,jj=this._mc180Pt,jf=this._mcM180Pt;var jl=jx/jv;var jp=jA+"_"+jl;dD.totalTileCount++;if(!dD._tileModelInfoCache.getData(jp)){var ji=jq*e,jh=jr*e;var je=e,jn=e,jw=0,jo="";var jy=ji+e;if(jy>jj.lng){je=jj.lng-ji;jo="left"}if(ji<jf.lng){jw=jf.lng-ji;je=e-jw;ji=jf.lng;jo="right"}var jz=[null,null,null];if(T.getName()==="web"){jz=this._genTileVertexInfo(ji,jh,je,jn,jo,jw,e,jv,jt)}var jm=new cf(ji,jh),jg=new cf(ji+je,jh+jn),ju=[jm,jg];js={key:jA,col:jq,row:jr,imgZoom:jk,useZoom:jx,vertex:jz[0],index:jz[1],textureCoord:jz[2],bounds:ju};dD._tileModelInfoCache.setData(jp,js)}else{dD.cachedTileCount++;js=dD._tileModelInfoCache.getData(jp)}return js},_genTileVertexInfo:function(jq,jp,jf,jw,jx,jI,e,jE,jB){var jr=[];var jh=[];var jn=[];var jC=this._mcPrj;var jF=this._earth.scene;var jv=jf/jE;var ji=jw/jB;var jj=this._radius;var jJ=[];for(var jz=0;jz<=jE;jz++){var je=jq+jz*jv;var T=jp;var jy=jC.convertMC2LL(new cf(je,T));jJ[jz]=jy}var ju=[];for(var jA=0;jA<=jB;jA++){var je=jq;var T=jp+jA*ji;var jy=jC.convertMC2LL(new cf(je,T));ju[jA]=jy}for(var jA=0;jA<=jB;jA++){for(var jz=0;jz<=jE;jz++){var jy=new b9(ju[jA].lat,jJ[jz].lng);var jk=jF.fromLatLngToXYZ(jy,jj);jr.push(jk[0],jk[1],jk[2]);if(jA<jB&&jz<jE){var jm=jA*(jE+1)+jz;var jH=jm+1;var jD=(jA+1)*(jE+1)+jz+1;jh.push(jm,jH,jD);var jG=jm;var jl=jD;var jo=(jA+1)*(jE+1)+jz;jh.push(jG,jl,jo)}var jt;var js=jA*ji/e;if(!jx){jt=jz*jv/e}else{var jg=0.01;if(jx=="left"){jt=jz*jv/e-jg}else{if(jx=="right"){jt=(jz*jv+jI)/e+jg}}}jn.push(jt,js)}}jn._dir=jx;return[jr,jh,jn]},getPolarTileModels:function(e,jr){if(this._polarModelsCache[e][jr]){return this._polarModelsCache[e][jr]}var jn=[];var je=[];var jl=[];var jA=this._earth.scene;var jg=this._radius;var jt=Math.floor(e);var jD=e+2;var T=11.25;var jG=5.625;var jh=360/T;var jf=22.5/jG;var jv;var js;if(jr==="n"){jv=67.5;js=90}else{jv=-90;js=-45;jf=45/jG}var jx=0;var jw=0;for(var jj=jv;jj<=js;jj+=jG){for(var jF=-180;jF<=180;jF+=T){var jq=new b9(jj,jF);var ju=jA.fromLatLngToXYZ(jq,jg);jn.push(ju[0],ju[1],ju[2]);if(jj<js&&jF<180){var jk=jx*(jh+1)+jw;var jC=jk+1;var jz=(jx+1)*(jh+1)+jw+1;je.push(jk,jC,jz);var jB=jk;var ji=jz;var jm=(jx+1)*(jh+1)+jw;je.push(jB,ji,jm)}var jp=jw/jh;var jo=jx/jf;jl.push(jp,jo);jw++}jw=0;jx++}var jE="key_er_"+(jr==="n"?"north":"south")+"_"+jD;var jy={key:jE,imgZoom:jD,vertex:jn,index:je,textureCoord:jl,projType:"er",polar:true};this._polarModelsCache[e][jr]=jy;return jy},getERTileModels:function(){if(this._ERTileModelInfo){return this._ERTileModelInfo}var jm=[];var T=[];var jk=[];var jv=this._earth.scene;var jf=this._radius;var e=11.25/2;var jA=5.625;var jg=360/e;var je=180/jA;var js=0;var jr=0;for(var ji=-90;ji<=90;ji+=jA){for(var jz=-180;jz<=180;jz+=e){var jp=new b9(ji,jz);var jq=jv.fromLatLngToXYZ(jp,jf);jm.push(jq[0],jq[1],jq[2]);if(ji<90&&jz<180){var jj=js*(jg+1)+jr;var jx=jj+1;var ju=(js+1)*(jg+1)+jr+1;T.push(jj,jx,ju);var jw=jj;var jh=ju;var jl=(js+1)*(jg+1)+jr;T.push(jw,jh,jl)}var jo=jr/jg;var jn=js/je;jk.push(jo,jn);jr++}jr=0;js++}var jy="key_er_1";var jt={key:jy,vertex:jm,index:T,textureCoord:jk,projType:"er",world:true};this._ERTileModelInfo=jt;return jt},getLODTileModels:function(jT,jG,j9,jf){var jr=jT.getSouthWest();var jh=jT.getNorthEast();if(jr.lat===-90||jr.lat===jh.lat){return[]}var T=this._earth;var jX=this._mcPrj;var j8=Math.pow(2,18-jf);var jO=256;var jV=j8*jO;var kd=jX.convertLL2MC(jr);var j0=jX.convertLL2MC(jh);var jE=kd.lat;var jK=kd.lng;var jg=j0.lat;var jQ=j0.lng;var i=T.getCenter();var jw=jX.convertLL2MC(i);var jP=Math.abs(jw.lat-j0.lat);var jA=Math.abs(jw.lng-j0.lng);var j4=Math.abs(jw.lat-kd.lat);var js=Math.abs(jw.lng-kd.lng);var ji=Math.min(jP,jA,j4,js);var jS=jw.lat-ji;var jI=jw.lng-ji;var jC=jw.lat+ji;var jM=jw.lng+ji;var kc=jV*2;var j5=Math.floor(jS/kc);var ke=Math.floor(jC/kc);var ju=Math.floor(jI/kc);var jH=Math.floor(jM/kc);var jk=j5*kc;var jz=ke*kc+kc;var jp=ju*kc;var jL=jH*kc+kc;var jZ=jV*0.1;var jD=new cf(jp+jZ,jk+jZ);var j2=new cf(jL-jZ,jz-jZ);var jj=jX.convertMC2LL(jD);var jR=jX.convertMC2LL(j2);var kb=new cm(jj,jR);var jn=this._getTileModels(kb,jG,j9,jf);var e=jn[0];var jl=jn[1];var jJ=jk,jm=jz,jW=jp,j3=jL,jo=kc,jF=jo*2,jy=jf;while(jm<jg||jJ>jE||jW>jK||j3<jQ){var kf=jm,jt=jJ,jU=jW,j1=j3;jy-=1;if(jm<jg){jm+=jo;if(jm%jF!==0){jm+=jo}}if(jJ>jE){jJ-=jo;if(jJ%jF!==0){jJ-=jo}}if(j3<jQ){j3+=jo;if(j3%jF!==0){j3+=jo}}if(jW>jK){jW-=jo;if(jW%jF!==0){jW-=jo}}var jq;var je;var jN;var jB;var ka;var j6=jo*0.1;var jv=[];if(jm>kf){jq=new cf(jW+j6,kf+j6);je=new cf(j3-j6,jm-j6);jN=jX.convertMC2LL(jq);jB=jX.convertMC2LL(je);ka=new cm(jN,jB);jv=this._getTileModels(ka,jG,j9,jy)[0]}var jY=[];if(jt>jJ){jq=new cf(jW+j6,jJ+j6);je=new cf(j3-j6,jt-j6);jN=jX.convertMC2LL(jq);jB=jX.convertMC2LL(je);ka=new cm(jN,jB);jY=this._getTileModels(ka,jG,j9,jy)[0]}var j7=[];if(j3>j1){jq=new cf(j1+j6,jt+j6);je=new cf(j3-j6,kf-j6);jN=jX.convertMC2LL(jq);jB=jX.convertMC2LL(je);ka=new cm(jN,jB);j7=this._getTileModels(ka,jG,j9,jy)[0]}var jx=[];if(jU>jW){jq=new cf(jW+j6,jt+j6);je=new cf(jU-j6,kf-j6);jN=jX.convertMC2LL(jq);jB=jX.convertMC2LL(je);ka=new cm(jN,jB);jx=this._getTileModels(ka,jG,j9,jy)[0]}this.mergeArray(e,jv);this.mergeArray(e,jY);this.mergeArray(e,j7);this.mergeArray(e,jx);jo=kc*2;jF=jo*2}return[e,jl]},mergeArray:function(jf,T){for(var je=0,e=T.length;je<e;je++){jf.push(T[je])}return jf}});function gJ(e,i){this._radius=e;this._options={colSegs:64,rowSegs:32,latSpan:180};i=i||{};ev.extend(this._options,i);this._sphereVerticesOriginal=null;this._facesVertex=[];this._facesVertexIndiceMiddle=[]}ev.extend(gJ.prototype,{generateAllVertex:function(){this.initSphereVertexAll();this.initSphereAllFacesIndices();return{vertex:this._sphereVerticesOriginal,indice:this._facesVertexIndiceMiddle}},initSphereVertexAll:function(){if(this._sphereVerticesOriginal){return}var T=this._options.colSegs;var jk=this._options.rowSegs;var jj=this._radius;var je=360/T;var ji=this._options.latSpan;var e=ji/2;var jm=ji/jk;var jq=[];for(var jg=jk;jg>=0;jg--){var jo=hM(jg*jm-e);var jh=Math.cos(jo)*jj;var jl=Math.sin(jo)*jj;for(var jf=0;jf<T;jf++){var jp=Math.sin(hM(jf*je))*jh;var jn=Math.cos(hM(jf*je))*jh;jq.push(jp,jn,jl)}}this._sphereVerticesOriginal=jq},initSphereAllFacesIndices:function(){var T=this._options.colSegs;var jk=this._options.rowSegs;for(var jf=0;jf<jk;jf++){for(var je=0;je<T;je++){var jl=jf*T;var jg=jl+je;var e=jg+T;if(je<T-1){var jh=jg+1;var jj=jh+T;this._facesVertexIndiceMiddle.push(jg,jh,jj);this._facesVertexIndiceMiddle.push(jg,jj,e)}else{var ji=(jf+1)*T;this._facesVertexIndiceMiddle.push(jg,jl,ji);this._facesVertexIndiceMiddle.push(jg,ji,e)}}}return this._facesVertexIndiceMiddle},setSegments:function(i,e){this._options.colSegs=i;this._options.rowSegs=e}});function aU(e,je,T){this._radius=e;this._cols=je||Math.pow(2,4-1);this._rows=T||this._cols/2;this._sphereVerticesOriginal=null;this._facesVertex=[];this._facesVertexIndiceMiddle=[];this._textureCoords=[];var i=360/this._cols;this._x1=Math.cos(hM(i*2))*this._radius;this.initSphereVertex()}aU.H_SEGS=16;aU.V_SEGS=9;ev.extend(aU.prototype,{initSphereVertex:function(){if(this._facesVertex.length>0){return}var T=aU.H_SEGS;var jv=aU.V_SEGS;var je=this._radius;var jt=360/T;var jp=180/(jv-1);var jr=[];var ju=T/this._cols;var jm=T/ju;var jo=[];var jg=0;var jf=0;var jh;for(var js=0;js<jv;js++){var jn=Math.cos(hM(js*jp-90))*je;jn=Math.round(jn*100)/100;var jk=Math.sin(hM(js*jp-90))*je;jk=Math.round(jk*100)/100;jg=Math.floor(js/ju);for(var jq=0;jq<T;jq++){var jl=Math.cos(hM(jq*jt))*jn;var jj=Math.sin(hM(jq*jt))*jn;jl=Math.round(jl*100)/100;jj=Math.round(jj*100)/100;jr.push(jl,jk,jj);jf=Math.floor(jq/ju);jh=jf+jg*jm;if(jg<this._rows){if(!this._facesVertex[jh]){this._facesVertex[jh]=[]}this._facesVertex[jh].push(jl,jk,jj)}if(jg>0&&js%ju===0){var e=jf+(jg-1)*jm;var ji=this._facesVertex[e].length-3*(ju+1);this._facesVertex[e].push(jl,jk,jj);if(jq>0&&jq%ju===0){if(this._facesVertex[e-1]){this._facesVertex[e-1].push(jl,jk,jj)}}if(jq==T-1){this._facesVertex[e].push(jo[0],jo[1],jo[2])}}if(jf===0&&jq===0){jo=[jl,jk,jj]}if(jq>0&&jq%ju===0){if(this._facesVertex[jh-1]){this._facesVertex[jh-1].push(jl,jk,jj)}}if(jg<this._rows){if(jq===T-1){this._facesVertex[jh].push(jo[0],jo[1],jo[2])}}}}this._sphereVerticesOriginal=jr},initSphereFacesIndices:function(){var ji;var e=aU.H_SEGS;var jl=aU.V_SEGS;var jo=e/this._cols;var jh=e/jo;var jn=(jl-1)/this._rows;var jg=jo+1;var jf;ji=this._facesVertex[this._facesVertex.length/2];for(var je=0;je<jo;je++){for(var T=0;T<jo;T++){var jm=je*jg;var jj=jm+T+1;var jk=jm+T+1+jg;this._facesVertexIndiceMiddle.push(jm+T,jj,jk);jj=jm+T+1+jg;this._facesVertexIndiceMiddle.push(jm+T,jj,jm+jg+T)}}return this._facesVertexIndiceMiddle},generateTextureCoord:function(jm,jf,jp){var jl=this._facesVertex[Math.round(this._facesVertex.length/2)];if(!jl){return}var jq=[];var jo=Math.pow(2,2-jm);var ji=jf%jo;var T=jp%jo;var e=ji+T*jo;var jk=aU.H_SEGS/this._cols;var je=1/jk;var jg=1/((aU.V_SEGS-1)/this._rows);for(var jj=0;jj<jl.length/3;jj++){var jh=jj%(jk+1)*je;var jn=Math.floor(jj/(jk+1))*jg;jh=jh/jo+ji*1/jo;jn=jn/jo+T*1/jo;if(jm===1){jn*=2}jq.push(jh,jn)}return jq},getFaceIndex:function(jg){var i=0;var jk=0;var jh=jg[0];var jf=jg[1];var je=jg[2];var jj=Math.round(Math.atan(Math.abs(je)/Math.abs(jh))*180/Math.PI);if(jh>0){if(je<0){jj=360-jj}}else{if(je>0){jj=180-jj}else{jj=180+jj}}if(jf>this._x1){jk=3}else{if(jf>0){jk=2}else{if(jf>-this._x1){jk=1}else{jk=0}}}var i=Math.floor(jj/(360/this._cols));var e=aU.H_SEGS;var ji=e/this._cols;var T=e/ji;return[i,jk,i+jk*T]}});function d7(e){this._earth=e;this._pMatrix=mat4.create();this._pMatrixInverse=mat4.create();this._pMatrix64=mat4.create(Float64Array);this._pMatrixInverse64=mat4.create(Float64Array);this._cMatrix=mat4.create();this._mvMatrix=mat4.create();this._mvMatrixForCamera=mat4.create();this._mvMatrixForCameraInverse=mat4.create();this._mvMatrixForAt=mat4.create();this._mvMatrixInverse=mat4.create();this._mvMatrix64=mat4.create(Float64Array);this._mvMatrixInverse64=mat4.create(Float64Array);this._mvMatrixForAtInverse=mat4.create();this._mvMatrixWithNoHeading=mat4.create();this._mvMatrixWithNoHeadingInverse=mat4.create();this._near=0.001;this._far=8000;this._guid=d7.guid++;this._lightMatrix=mat4.create();this._lightMatrixInverse=mat4.create();this._lightMatrixForAt=mat4.create();this._lightMatrixForAtInverse=mat4.create();this._lightPosition=null;this._date=new Date();this._ray=new dt.Ray();this._calculateSunLightPos();this._tempV4=vec4.create(Float64Array);this._tempRes=vec4.create();this._tempNdc=vec4.create()}d7.guid=0;ev.extend(d7.prototype,{updateProjectionMatrix:function(){var i=this._earth.getContainerSize();this._widthHeightRatio=i.width/i.height;var e=this._earth.getZoom();if(e<=3){this._fovy=70-10*e}else{this._fovy=40}mat4.perspective(this._pMatrix64,hM(this._fovy),this._widthHeightRatio,this._near,this._far);mat4.invert(this._pMatrixInverse64,this._pMatrix64);this._pMatrix=mat4.clone(this._pMatrix64);this._pMatrixInverse=mat4.clone(this._pMatrixInverse64)},updateModelViewMatrix:function(){var je=this._mvMatrix64;var jj=this._mvMatrixForCamera;mat4.identity(je);mat4.identity(jj);var jl=this._earth;var jn=jl.getZoom();var jf=180;var jo=jl.radius;var i;if(jn<=3){i=3.4*jo-0.8*jo*jn}else{i=jo/Math.pow(2,jn-3)}mat4.translate(je,je,[0,0,-i]);mat4.translate(jj,jj,[0,0,-i]);var jk=this._mvMatrixWithNoHeading;mat4.copy(jk,je);var jm=jl.getTilt();if(jm!==0&&jn<jl._enableTiltZoom){if(jn>=jl._enableTiltZoom-2){jm=(1-(jl._enableTiltZoom-jn)/2)*jm}else{jm=0}}if(jm!==0){mat4.rotate(je,je,hM(jm),[-1,0,0]);mat4.rotate(jj,jj,hM(jm),[-1,0,0])}var jp=jl.getHeading();while(jp<0){jp+=360}jp%=360;if(jp>=315||jp<45){mat4.rotate(jk,jk,hM(jm),[-1,0,0])}else{if(jp<135){mat4.rotate(jk,jk,hM(jm),[0,-1,0])}else{if(jp<225){mat4.rotate(jk,jk,hM(jm),[1,0,0])}else{mat4.rotate(jk,jk,hM(jm),[0,1,0])}}}mat4.translate(jk,jk,[0,0,-jo]);mat4.translate(je,je,[0,0,-jo]);mat4.translate(jj,jj,[0,0,-jo]);var e=jl.getCenter();var jh=e.lat;var ji=e.lng;if(jn<=6){mat4.copy(this._mvMatrixForAt,je);mat4.invert(this._mvMatrixForAtInverse,this._mvMatrixForAt);mat4.copy(this._lightMatrix,je);var jg=this._lightMatrix;mat4.rotate(jg,jg,hM(this._sunLightLat),[1,0,0]);mat4.rotate(jg,jg,hM(-jf+this._sunLightLng),[0,-1,0]);mat4.invert(this._lightMatrixInverse,this._lightMatrix);mat4.copy(this._lightMatrixForAt,this._mvMatrixForAt);var T=this._lightMatrixForAt;mat4.rotate(T,T,hM(this._sunLightLat),[1,0,0]);mat4.rotate(T,T,hM(ji-this._sunLightLng),[0,1,0]);mat4.rotate(T,T,hM(-jh),[1,0,0]);if(jp!==0){mat4.rotate(T,T,hM(jp),[0,0,1])}mat4.invert(this._lightMatrixForAtInverse,T)}if(jp!==0){mat4.rotate(je,je,hM(jp),[0,0,-1]);mat4.rotate(jj,jj,hM(jp),[0,0,-1])}mat4.rotate(je,je,hM(jh),[1,0,0]);mat4.rotate(jk,jk,hM(jh),[1,0,0]);mat4.rotate(je,je,hM(jf+ji),[0,-1,0]);mat4.rotate(jk,jk,hM(jf+ji),[0,-1,0]);mat4.invert(this._mvMatrixInverse64,je);this._mvMatrix=mat4.clone(je);this._mvMatrixInverse=mat4.clone(this._mvMatrixInverse64);mat4.invert(this._mvMatrixForCameraInverse,jj);mat4.invert(this._mvMatrixWithNoHeadingInverse,jk);this._cameraPosition=null;this._cameraPositionForAt=null;this._distanceToSphereEdge=null;this._earthRadius=null;this._lightPosition=null;this._lightPositionForAt=null},_calculateSunLightPos:function(){var e=e2(this._date);this._sunLightLng=e[0];this._sunLightLat=e[1];var i=this;this._earth.on("sunlighttime_change",function(je){var T=e2(i._date);i._sunLightLng=T[0];i._sunLightLat=T[1]});this._earth.on("sunlighttime_clear",function(je){var T=e2(i._date);i._sunLightLng=T[0];i._sunLightLat=T[1]})},getSunZenith:function(){return new b9(this._sunLightLat,this._sunLightLng)},saveMatrixInfo:function(){this._savePMatrixInverse=mat4.clone(this._pMatrixInverse);this._saveMVMatrixInverse=mat4.clone(this._mvMatrixInverse)},getProjectionMatrix:function(){return this._pMatrix},getModelViewMatrix:function(){return this._mvMatrix},getModelViewMatrixForAt:function(){return this._mvMatrixForAt},getInverseProjectionMatrix:function(){return this._pMatrixInverse},getInverseModelViewMatrix:function(){return this._mvMatrixInverse},fromXYZToNDC:function(jh,jf,T,jj){var je=vec4.set(this._tempV4,jh,jf,T,1);var i=this._tempRes;jj=jj||{};var e=this._mvMatrix;var jg=this._pMatrix;if(jj.matrixInfo){e=jj.matrixInfo.modelViewMatrix||e;jg=jj.matrixInfo.projectionMatrix||jg}mat4.multiply(i,e,je);mat4.multiply(i,jg,i);var ji=vec4.set(this._tempNdc,i[0]/i[3],i[1]/i[3],i[2]/i[3],1);ji.w=i[3];return ji},getPosition:function(){if(this._cameraPosition){return this._cameraPosition}this._cameraPosition=vec3.transformMat4(vec3.create(),vec3.fromValues(0,0,0),this._mvMatrixInverse);return this._cameraPosition},getPositionForAt:function(){if(this._cameraPositionForAt){return this._cameraPositionForAt}this._cameraPositionForAt=vec3.transformMat4(vec3.create(),vec3.fromValues(0,0,0),this._mvMatrixForAtInverse);return this._cameraPositionForAt},getDistanceToSphereEdge:function(){if(this._distanceToSphereEdge){return this._distanceToSphereEdge}var i=vec3.len(this.getPosition());var e=this._earth.radius;this._distanceToSphereEdge=(Math.pow(i,2)-e*e)/i;return this._distanceToSphereEdge},getLength:function(){return vec3.len(this.getPosition())},castRay:function(T,jf){var i=this._ray;var e=T.x;var ji=T.y;var je=vec3.create(Float64Array);var jg=vec4.set(this._tempV4,e,ji,-1,1);this._calcV4InCastRay(jg,jf);vec3.scale(je,jg,1/jg[3]);var jh=vec3.create(Float64Array);jg=vec4.fromValues(e,ji,1,1);this._calcV4InCastRay(jg,jf);vec3.scale(jg,jg,1/jg[3]);vec3.sub(jh,jg,je);vec3.normalize(jh,jh);i.set(je,jh);return i},_calcV4InCastRay:function(jg,T){if(!T){mat4.multiply(jg,this._pMatrixInverse64,jg);mat4.multiply(jg,this._mvMatrixInverse64,jg)}else{if(T.useOld){mat4.multiply(jg,this._savePMatrixInverse,jg);mat4.multiply(jg,this._saveMVMatrixInverse,jg)}else{if(T.useNoHeading){mat4.multiply(jg,this._pMatrixInverse,jg);mat4.multiply(jg,this._mvMatrixWithNoHeadingInverse,jg)}else{if(T.matrixInfo){var e=T.matrixInfo.projectionMatrix;var je=mat4.create(Float64Array);if(e){mat4.invert(je,e)}else{je=this._pMatrixInverse}var i=T.matrixInfo.modelViewMatrix;var jf=mat4.create(Float64Array);if(i){mat4.invert(jf,i)}else{jf=this._mvMatrixInverse}mat4.multiply(jg,je,jg);mat4.multiply(jg,jf,jg)}}}}},getLightPosition:function(){if(this._lightPosition){return this._lightPosition}this._lightPosition=vec3.transformMat4(vec3.create(),vec3.fromValues(0,0,0),this._lightMatrixInverse);return this._lightPosition},getLightPositionForAt:function(){if(this._lightPositionForAt){return this._lightPositionForAt}this._lightPositionForAt=vec3.transformMat4(vec3.create(),vec3.fromValues(0,0,0),this._lightMatrixForAtInverse);return this._lightPositionForAt},getEarthRadiusOnScreen:function(){if(this._earthRadius){return this._earthRadius}var je=vec3.len(this.getPosition());var T=Math.tan(hM(this._fovy/2))*this._near;var i=this._earth.radius;var e=this._near*i/Math.sqrt(Math.pow(je,2)-i*i)/T;this._earthRadius=Math.round(e*this._earth.getContainerSize().height/2);return this._earthRadius}});function hl(i){this._earth=i;this._canvas=i._canvas;this._gl=null;this._renderers=[];this._camera=new d7(i);var e=i.getContainerSize();this._width=e.width;this._height=e.height;this._enableTiltZoom=i._enableTiltZoom;this._changedStatus={};this._ratio=i._ratio;this._radius=i.radius;this._onEachFrame=(function(T){return function(){T._renderFrame()}})(this);this._init()}ev.extend(hl.prototype,{_init:function(){this._gl=G(this._canvas);this._handleContextStatus();this._setupWebGL();this._bind();this.onStatusChange();this.startRenderThread();var T=new fa("onearthload");var i=af(this._gl);if(!i){i={renderer:"",vendor:""}}T.hardwareInfo=i;T.earth=this._earth;this._earth._deviceInfo={hardwareInfo:i};this._earth._map._earth=this._earth;this._earth._map.dispatchEvent(T)},_handleContextStatus:function(){var e=this._canvas;var i=this;e.addEventListener("webglcontextlost",function(T){T.preventDefault();cancelAnimationFrame(i.renderTimer);i._earth.fire(new fa("onwebglcontextlost"));setTimeout(function(){window.location.reload()},200)},false);e.addEventListener("webglcontextrestored",function(T){i._earth.fire(new fa("onwebglcontextrestored"))},false)},_setupWebGL:function(){var i=this._gl;var e=this._canvas;i.clearColor(0,0,0,1);i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT);i.viewport(0,0,e.width,e.height)},_bind:function(){var je=this._earth;var T=this;function jf(jg){T._renderOptions={event:jg};T._changedStatus[jg.type]=true;T._needToChangeStatus=true;T.startRenderThread()}je.on("zoom_changed",jf);je.on("center_changed",jf);je.on("heading_changed",jf);je.on("tilt_changed",jf);je.on("forcerefresh",jf);je.on("size_changed",jf);je.on("displayoptions_changed",jf);je.on("animation_end",jf);je.on("layer_add",function e(jg){if(jg.layer.renderer){T.addRenderer(jg.layer.renderer)}});je.on("layer_remove",function i(jg){if(jg.layer.renderer){T.removeRenderer(jg.layer.renderer)}});je.on("idle",function(){cancelAnimationFrame(T.renderTimer);je.fire(new fa("onrenderthreadstop"));T.renderTimer=null});je.on("refresh",function(){T.startRenderThread()})},startRenderThread:function(){var e=this;if(e.idleTimer){clearTimeout(e.idleTimer)}e.idleTimer=setTimeout(function(){e._earth.fire(new fa("onidle"));e.idleTimer=null},100);if(this.renderTimer){return}this.renderTimer=requestAnimationFrame(this._onEachFrame)},_renderFrame:function(){this.renderTimer=requestAnimationFrame(this._onEachFrame);if(this._needToChangeStatus){this.onStatusChange();this._changedStatus={};this._needToChangeStatus=false}var je=this._gl;je.clear(je.COLOR_BUFFER_BIT|je.DEPTH_BUFFER_BIT);for(var T=0,e=this._renderers.length;T<e;T++){this._renderers[T].renderFrame(this._renderOptions)}this._earth._map.insertRender&&this._earth._map.insertRender()},onStatusChange:function(){var jf=this;if(jf._changedStatus.onsize_changed){jf.resize()}jf._curBounds=null;jf._camera.updateProjectionMatrix();jf._camera.updateModelViewMatrix();for(var je=0,T=jf._renderers.length;je<T;je++){jf._renderers[je].onStatusChange(jf._camera)}jf._statusChangeTimer=null;var jg=new fa("onstatuschange");jg.changedStatus=jf._changedStatus;jf._earth.fire(jg);var e=new fa("onearthstatuschange");e.changedStatus=jf._changedStatus;jf._earth.getMap().fire(e)},resize:function(){var jg=this._earth.getContainerSize();var T=this._width=jg.width;var jh=this._height=jg.height;var je=this._canvas;je.style.width=T+"px";je.style.height=jh+"px";je.width=T*this._ratio;je.height=jh*this._ratio;this._gl.viewport(0,0,je.width,je.height);for(var jf=0,e=this._renderers.length;jf<e;jf++){this._renderers[jf].resize&&this._renderers[jf].resize()}},saveMatrixInfo:function(){this._camera.saveMatrixInfo()},addRenderer:function(e){this._renderers.push(e);this._renderers.sort(function(T,i){return T.zIndex-i.zIndex});this.startRenderThread()},removeRenderer:function(T){for(var e=0;e<this._renderers.length;e++){if(this._renderers[e]===T){this._renderers.splice(e,1)}}this.startRenderThread()},fromPixelToXYZ:function(ji,jg){var jt=this._width;var js=this._height;var jn=ji.x*2/jt-1;var jm=1-ji.y*2/js;var jq=this._camera.castRay(new eO(jn,jm),jg);var jh=this._radius;var jv=jq.direction;var T=jq.origin;var e=vec3.fromValues(0,0,0,Float64Array);var jr=vec3.create(Float64Array);vec3.sub(jr,T,e);var jl=vec3.dot(jv,jv);var jk=2*vec3.dot(jv,T);var jj=vec3.dot(T,T)-jh*jh;var jo=jk*jk-4*jl*jj;var ju=vec3.create(Float64Array);if(jo<0){return null}else{if(jo===0){var jp=-jk/(2*jl);return vec3.scaleAndAdd(ju,T,jv,jp)}}var jf=(-jk+Math.sqrt(jo))/(2*jl);var je=(-jk-Math.sqrt(jo))/(2*jl);vec3.scaleAndAdd(ju,T,jv,jf);var i=vec3.create(Float64Array);vec3.scaleAndAdd(i,T,jv,je);if(Math.abs(ju[2]-jq.origin[2])<Math.abs(i[2]-jq.origin[2])){return ju}return i},fromXYZToPixel:function(i,ji,jh,jf){var T=this._camera.fromXYZToNDC(i,ji,jh,jf);if(!T){return null}var jg=this._width;var e=this._height;var je=new eO(((T[0]+1)*jg*0.5),((1-T[1])*e*0.5));je.depth=(T[2]+1)*0.5;je.w=T.w;return je},fromLatLngToXYZ:function(jf,T){T=T||this._radius;var je=Math.cos(jf.lat*Math.PI/180)*T;var jh=Math.sin(jf.lat*Math.PI/180)*T;var i=Math.sin((jf.lng+180)*Math.PI/180)*je;var jg=Math.cos((jf.lng+180)*Math.PI/180)*je;var e=[i,jh,jg];e.x=i;e.y=jh;e.z=jg;return e},fromXYZToLatLng:function(i,jg,jf){var je=eG(Math.asin(jg/this._radius));var T;var e=Math.cos(hM(je))*this._radius;if(i>=0){if(jf<0){T=-eG(Math.asin(bW(i/e,-1,1)))}else{T=-(eG(Math.asin(bW(jf/e,-1,1)))+90)}}if(i<0){if(jf<0){T=eG(Math.asin(bW(-i/e,-1,1)))}else{T=eG(Math.asin(bW(jf/e,-1,1)))+90}}return new b9(je,T)},fromPixelToLatLng:function(T,i){var e=this.fromPixelToXYZ(T,i);if(!e){return null}return this.fromXYZToLatLng(e[0],e[1],e[2])},fromLatLngToPixel:function(i,jk){var jh=this.fromLatLngToXYZ(i);jk=jk||{};var e=this.fromXYZToPixel(jh[0],jh[1],jh[2],jk);if(jk.isCalcOnBack){var jg=this._camera;var jj=jg.getLength();var T=jg._fovy;var jf=this._radius;var ji=Math.sqrt(jj*jj-jf*jf);var je=Math.cos(hM(T/2))*ji;if(e.w>je){e.onBack=true}}return e},ifXYZInView:function(jg,jf,je){var i=this.fromXYZToPixel(jg,jf,je);var e=this._width;var ji=this._height;var jh=this._camera.getLength();if(this._earth.getZoom()>3){var jj=this.fromLatLngToPixel(this._earth.getCenter());var T=jj.w;if(Math.abs(i.w-T)>50){return false}}if(i.x>0&&i.x<e&&i.y>0&&i.y<ji&&i.w<=jh){return true}return false},ifXYZOnBack:function(i,jg,jf,je){je=je||0;var T=this.fromXYZToPixel(i,jg,jf);var e=this._camera.getDistanceToSphereEdge();if(T.w>e+je){return true}return false},getBounds:function(){if(this._curBounds){return this._curBounds}var T=this._earth;var jf=T.getZoom();if(jf<3){return this._getBoundsForSmallZoom()}var jD=T.getHeading();var jj=T.getContainerSize();var jv=[0,0,jj.width,jj.height];if(jD!==0){jv=gQ(jD,new h8(jj.width,jj.height))}var jE=jv[0];var jC=jv[1];var jp=jv[2];var jo=jv[3];var jm=-1;var jl=-1;var ji=-1;var jh=-1;var jn=-1;var e=this._width;var jg=this._height;var jL;var jJ;var jx;var jG;var i=T.getCenter();var ju=false;var jq;var jF=this._hasHoleInfoCache;var jw=this.fromPixelToLatLng(new eO(jE,jC),{useNoHeading:true});if(jw){jL=jw.lat;jG=jw.lng}jq=!jL?true:false;var jB;var jM=this._earth.getTilt();if(jq&&(jM===0||jM>0&&jf<5)){var jt=null;if(i.lat>50){jB=new cm(new b9(i.lat-70,i.lng-90),new b9(40,i.lng+90));jt=new cm(new b9(40,i.lng-120),new b9(90,i.lng+120))}else{if(i.lat<-50){jB=new cm(new b9(-40,i.lng-90),new b9(i.lat+70,i.lng+90));jt=new cm(new b9(-90,i.lng-120),new b9(-40,i.lng+120))}else{jB=new cm(new b9(i.lat-70,i.lng-90),new b9(i.lat+70,i.lng+90))}}jB._addBounds=jt;jB.holeAtTopLeft=!!jq;this._curBounds=jB;if(jM>0&&jf>=this._enableTiltZoom){jB.useLOD=true}return jB}var jI=this.fromPixelToLatLng(new eO(0,0));jw=this.fromPixelToLatLng(new eO((jp+jE)/2,jC),{useNoHeading:true});if(jw){if(!jL||jw.lat>jL){jL=jw.lat}if(jF){jm=this._holeInfoCache.topX;jw=this.fromPixelToLatLng(new eO(jm,jC),{useNoHeading:true})}else{if(jq){for(var jA=jE+1;jA<=jp;jA++){jw=this.fromPixelToLatLng(new eO(jA,jC),{useNoHeading:true});if(jw!==null){break}}if(jw!==null){jm=jA;jG=jw.lng}}}}else{}if(!jq&&jm===-1){jw=this.fromPixelToLatLng(new eO(jp,jC),{useNoHeading:true})}else{jw=this.fromPixelToLatLng(new eO(jp-jm,jC),{useNoHeading:true});if(!jw){if(jF){jn=this._holeInfoCache.topXRight;jw=this.fromPixelToLatLng(new eO(jn,jC),{useNoHeading:true})}else{for(var jA=jp-1;jA>=jE;jA--){jw=this.fromPixelToLatLng(new eO(jA,jC),{useNoHeading:true});if(jw!==null){break}}jn=jA}}}if(jw){jx=jw.lng;if(jw.lat>jL){jL=jw.lat}}var jz=this.fromPixelToLatLng(new eO(e,0));jw=this.fromPixelToLatLng(new eO(jE,(jo+jC)/2),{useNoHeading:true});if(jw){ju=true;if(jq){if(jF){jl=this._holeInfoCache.topY;jw=this.fromPixelToLatLng(new eO(jE,jl),{useNoHeading:true})}else{for(var jy=jC+1;jy<=jo;jy++){jw=this.fromPixelToLatLng(new eO(jE,jy),{useNoHeading:true});if(jw!==null){break}}jl=jy}if(jw){jG=jw.lng}if(jw&&(!jL||jw.lat>jL)){jL=jw.lat}}if(!jG||i.getLngSpan(jw.lng)>i.getLngSpan(jG)){jG=jw.lng}}if(!jL){jL=90}jw=this.fromPixelToLatLng(new eO(jp,(jo+jC)/2),{useNoHeading:true});if(jw){if(jq&&jl!==-1){for(var jy=jC+jl-1;jy<=jo;jy++){jw=this.fromPixelToLatLng(new eO(jp,jy),{useNoHeading:true});if(jw!==null){break}}if(jw){jx=jw.lng}}if(i.getLngSpan(jw.lng)>i.getLngSpan(jx)){jx=jw.lng}}jw=this.fromPixelToLatLng(new eO(jE,jo),{useNoHeading:true});if(jw){jJ=jw.lat;if(i.getLngSpan(jw.lng)>i.getLngSpan(jG)){jG=jw.lng}}else{if(ju){if(jF){jh=this._holeInfoCache.bottomY;jw=this.fromPixelToLatLng(new eO(jE,jh),{useNoHeading:true})}else{for(var jy=jo-1;jy>=jC;jy--){jw=this.fromPixelToLatLng(new eO(jE,jy),{useNoHeading:true});if(jw!==null){break}}jh=jy}if(jw&&i.getLngSpan(jw.lng)>i.getLngSpan(jG)){jG=jw.lng}}}var js=this.fromPixelToLatLng(new eO(0,jg+0));jw=this.fromPixelToLatLng(new eO((jp+jE)/2,jo),{useNoHeading:true});if(jw){var jH=!jJ?true:false;if(jw.lat<jJ||!jJ){jJ=jw.lat}if(jH){for(var jA=jE+1;jA<=jp;jA++){jw=this.fromPixelToLatLng(new eO(jA,jo),{useNoHeading:true});if(jw!==null){break}}if(jw){ji=jA;if(jw.lat<jJ){jJ=jw.lat}if(i.getLngSpan(jw.lng)>i.getLngSpan(jG)){jG=jw.lng}}}}else{if(!jJ){jJ=-90}}if(ji===-1){jw=this.fromPixelToLatLng(new eO(jp,jo),{useNoHeading:true})}else{jw=this.fromPixelToLatLng(new eO(jp-ji,jo),{useNoHeading:true});if(!jw){for(var jA=jp-1;jA>=jE;jA--){jw=this.fromPixelToLatLng(new eO(jA,jo),{useNoHeading:true});if(jw!==null){break}}}}if(jw){if(i.getLngSpan(jw.lng)>i.getLngSpan(jx)){jx=jw.lng}if(jw.lat<jJ){jJ=jw.lat}}var jr=this.fromPixelToLatLng(new eO(e,jg));if(!jG){var jk;var je;if(jf<4){jk=new b9(0,i.lng-90);je=new b9(0,i.lng+90)}else{jk=new b9(0,i.lng-15);je=new b9(0,i.lng+15)}jG=jk.lng;jx=je.lng}jB=new cm(new b9(jJ,jG),new b9(jL,jx));this._curBounds=jB;this._curBounds.holeAtTopLeft=!!jq;if(jM>0&&jf<5){if(!jI){jI=new b9(jL,jG);jz=new b9(jL,jx)}var jK=T.getProjection();jB.pointTopLeft=jK.convertLL2MC(jI);jB.pointTopRight=jK.convertLL2MC(jz);jB.pointBottomRight=jK.convertLL2MC(jr);jB.pointBottomLeft=jK.convertLL2MC(js)}if(jM>0&&jf>=this._enableTiltZoom){jB.useLOD=true}return jB},getCustomBounds:function(){var T=this._earth;if(T.getZoom()<3){return this._getBoundsForSmallZoom()}var je=T.getHeading();var ju=T.getContainerSize();var jg=[0,0,ju.width,ju.height];if(je!==0){jg=gQ(je,new h8(ju.width,ju.height))}var jA=jg[0];var jy=jg[1];var jz=jg[2];var jx=jg[3];var jE=-1;var jC=-1;var jh=-1;var jf=-1;var jm=-1;var js=this._width;var jp=this._height;var jD;var jl;var jv;var jt;var jB=T.getCenter();var i=false;var jH;var e=this._hasHoleInfoCache;var jw=this._earth._generateTmpMVMatrix(T.getCenter(),T.getZoom(),0,0);var jG=this.fromPixelToLatLng(new eO(jA,jy),{matrixInfo:{modelViewMatrix:jw}});if(jG){jD=jG.lat;jt=jG.lng}jH=!jD?true:false;var jF;if(jH){var jk=this.fromPixelToLatLng(new eO((jz+jA)/2,jy),{matrixInfo:{modelViewMatrix:jw}});if(jk){var ji=this.fromPixelToLatLng(new eO((jz+jA)/2,jx),{matrixInfo:{modelViewMatrix:jw}});jF=new cm(new b9(ji.lat-20,jB.lng-90),new b9(jk.lat+20,jB.lng+90))}return jF}jG=this.fromPixelToLatLng(new eO((jz+jA)/2,jy),{matrixInfo:{modelViewMatrix:jw}});if(jG){if(!jD||jG.lat>jD){jD=jG.lat}if(e){jE=this._holeInfoCache.topX;jG=this.fromPixelToLatLng(new eO(jE,jy),{matrixInfo:{modelViewMatrix:jw}})}else{if(jH){for(var jo=jA+1;jo<=jz;jo++){jG=this.fromPixelToLatLng(new eO(jo,jy),{matrixInfo:{modelViewMatrix:jw}});if(jG!==null){break}}if(jG!==null){jE=jo;jt=jG.lng}}}}else{}if(!jH&&jE===-1){jG=this.fromPixelToLatLng(new eO(jz,jy),{matrixInfo:{modelViewMatrix:jw}})}else{jG=this.fromPixelToLatLng(new eO(jz-jE,jy),{matrixInfo:{modelViewMatrix:jw}});if(!jG){if(e){jm=this._holeInfoCache.topXRight;jG=this.fromPixelToLatLng(new eO(jm,jy),{matrixInfo:{modelViewMatrix:jw}})}else{for(var jo=jz-1;jo>=jA;jo--){jG=this.fromPixelToLatLng(new eO(jo,jy),{matrixInfo:{modelViewMatrix:jw}});if(jG!==null){break}}jm=jo}}}if(jG){jv=jG.lng;if(jG.lat>jD){jD=jG.lat}}jG=this.fromPixelToLatLng(new eO(jA,(jx+jy)/2),{matrixInfo:{modelViewMatrix:jw}});if(jG){i=true;if(jH){if(e){jC=this._holeInfoCache.topY;jG=this.fromPixelToLatLng(new eO(jA,jC),{matrixInfo:{modelViewMatrix:jw}})}else{for(var jn=jy+1;jn<=jx;jn++){jG=this.fromPixelToLatLng(new eO(jA,jn),{matrixInfo:{modelViewMatrix:jw}});if(jG!==null){break}}jC=jn}if(jG){jt=jG.lng}if(jG&&(!jD||jG.lat>jD)){jD=jG.lat}}if(!jt||jB.getLngSpan(jG.lng)>jB.getLngSpan(jt)){jt=jG.lng}}if(!jD){jD=90}jG=this.fromPixelToLatLng(new eO(jz,(jx+jy)/2),{matrixInfo:{modelViewMatrix:jw}});if(jG){if(jH&&jC!==-1){for(var jn=jy+jC-1;jn<=jx;jn++){jG=this.fromPixelToLatLng(new eO(jz,jn),{matrixInfo:{modelViewMatrix:jw}});if(jG!==null){break}}if(jG){jv=jG.lng}}if(jB.getLngSpan(jG.lng)>jB.getLngSpan(jv)){jv=jG.lng}}jG=this.fromPixelToLatLng(new eO(jA,jx),{matrixInfo:{modelViewMatrix:jw}});if(jG){jl=jG.lat;if(jB.getLngSpan(jG.lng)>jB.getLngSpan(jt)){jt=jG.lng}}else{if(i){if(e){jf=this._holeInfoCache.bottomY;jG=this.fromPixelToLatLng(new eO(jA,jf),{matrixInfo:{modelViewMatrix:jw}})}else{for(var jn=jx-1;jn>=jy;jn--){jG=this.fromPixelToLatLng(new eO(jA,jn),{matrixInfo:{modelViewMatrix:jw}});if(jG!==null){break}}jf=jn}if(jG&&jB.getLngSpan(jG.lng)>jB.getLngSpan(jt)){jt=jG.lng}}}jG=this.fromPixelToLatLng(new eO((jz+jA)/2,jx),{matrixInfo:{modelViewMatrix:jw}});if(jG){var jr=!jl?true:false;if(jG.lat<jl||!jl){jl=jG.lat}if(jr){for(var jo=jA+1;jo<=jz;jo++){jG=this.fromPixelToLatLng(new eO(jo,jx),{matrixInfo:{modelViewMatrix:jw}});if(jG!==null){break}}if(jG){jh=jo;if(jG.lat<jl){jl=jG.lat}if(jB.getLngSpan(jG.lng)>jB.getLngSpan(jt)){jt=jG.lng}}}}else{if(!jl){jl=-90}}if(jh===-1){jG=this.fromPixelToLatLng(new eO(jz,jx),{matrixInfo:{modelViewMatrix:jw}})}else{jG=this.fromPixelToLatLng(new eO(jz-jh,jx),{matrixInfo:{modelViewMatrix:jw}});if(!jG){for(var jo=jz-1;jo>=jA;jo--){jG=this.fromPixelToLatLng(new eO(jo,jx),{matrixInfo:{modelViewMatrix:jw}});if(jG!==null){break}}}}if(jG){if(jB.getLngSpan(jG.lng)>jB.getLngSpan(jv)){jv=jG.lng}if(jG.lat<jl){jl=jG.lat}}if(!jt){var jq;var jj;if(T.getZoom()<4){jq=new b9(0,jB.lng-90);jj=new b9(0,jB.lng+90)}else{jq=new b9(0,jB.lng-15);jj=new b9(0,jB.lng+15)}jt=jq.lng;jv=jj.lng}jF=new cm(new b9(jl,jt),new b9(jD,jv));return jF},_getBoundsForSmallZoom:function(){var e=this._earth.getCenter();var i=new cm(new b9(e.lat-90,e.lng-120),new b9(e.lat+90,e.lng+120));this._curBounds=i;this._curBounds.holeAtTopLeft=true;return this._curBounds}});function e8(jf,je){this._earth=jf;this._layer=je;this._canvas=jf._canvas;var jg=this._gl=jf.scene._gl;this._webglState=dt.WebGLState.get(jg,jf._guid);this._glProgram=null;this._glProgram1=null;this._glProgram2=null;this._imgPool=new eF("img");this._textureInfoPool=new hn(1000,{clearCallback:function(jh){if(jh){jg.deleteTexture(jh)}}});this._mergedTextureCache=new hn(200);this._tileNeedToLoadCount=0;this._tileLoadedCount=0;this._thumbToLoad=0;this._thumbLoaded=0;this._nightLoaded=false;this._cloudTextureImage=null;this._radius=jf.radius;this._width=this._canvas.width;this._height=this._canvas.height;this._mvMatrix=mat4.create();this._mvMatrixCamera=mat4.create();this._pMatrix=mat4.create();this._nMatrix=mat4.create();this._vertexPositionAttribute=null;this._vertexTexCoordAttribute=null;this._trianglesVerticeBuffer=jg.createBuffer();this._triangleVerticesIndexBuffer=jg.createBuffer();this._atmosphereRenderer=this._earth._atmosphereRenderer;this._float32Array=new Float32Array(30000);this._uint16Array=new Uint16Array(30000);var T=this._canvasForMergedTile=document.createElement("canvas");var i=T.getContext("2d");T.width=T.height=512;i.fillStyle="#040728";i.fillRect(0,0,512,512);this._atmosphereData={Kr:0.0076,Km:0.0057,ESun:16,g:-0.95,innerRadius:jf.radius,outerRadius:1.02*jf.radius,wavelength:[0.65,0.57,0.475],scaleDepth:0.24,mieScaleDepth:0.1};var e=this._atmosphereData;this._atUniformsCommon=this._atmosphereRenderer._uniformsCommon;this._atUniformsGround=this._atmosphereRenderer._atUniformsGround;this._atUniforms={fInnerRadius:{type:"f",value:e.innerRadius},fInnerRadius2:{type:"f",value:e.innerRadius*e.innerRadius},fOuterRadius:{type:"f",value:e.outerRadius},fOuterRadius2:{type:"f",value:e.outerRadius*e.outerRadius},fKrESun:{type:"f",value:e.Kr*e.ESun},fKmESun:{type:"f",value:e.Km*e.ESun},fKr4PI:{type:"f",value:e.Kr*4*Math.PI},fKm4PI:{type:"f",value:e.Km*4*Math.PI},fScale:{type:"f",value:1/(e.outerRadius-e.innerRadius)},fScaleDepth:{type:"f",value:e.scaleDepth},fScaleOverScaleDepth:{type:"f",value:1/(e.outerRadius-e.innerRadius)/e.scaleDepth},g:{type:"f",value:e.g},g2:{type:"f",value:e.g*e.g},fNightScale:{type:"f",value:3}};this._init();this.zIndex=10}e8.VS_SHADER_TEXT=["precision highp float;","attribute vec3 aVertexPosition;","attribute vec2 aVertexTextureCoord;","attribute vec2 aCloudTextureCoord;","uniform vec3 cameraPositionGround;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 uMVMatrix;","uniform mat4 uPMatrix;","uniform mat4 uNMatrix;","uniform vec3 v3LightPositionGround;","uniform vec3 v3InvWavelength;","uniform float fCameraHeightGround;","uniform float fCameraHeight2Ground;","uniform float fOuterRadius;","uniform float fOuterRadius2;","uniform float fInnerRadius;","uniform float fInnerRadius2;","uniform float fKrESun;","uniform float fKmESun;","uniform float fKr4PI;","uniform float fKm4PI;","uniform float fScale;","uniform float fScaleDepth;","uniform float fScaleOverScaleDepth;","varying vec3 v3Direction;","varying vec3 c0;","varying vec3 c1;","const int nSamples = 3;","const float fSamples = 3.0;","varying vec2 vTextureCoord;","varying vec2 vCloudTextureCoord;","float scale(float fCos) {","    float x = 1.0 - fCos;","    return fScaleDepth * exp(-0.00287 + x*(0.459 + x*(3.83 + x*(-6.80 + x*5.25))));","}","void main(void) {","vec3 v3Ray = aVertexPosition - cameraPositionGround;","float fFar = length(v3Ray);","v3Ray /= fFar;","float B = 2.0 * dot(cameraPositionGround, v3Ray);","float C = fCameraHeight2Ground - fOuterRadius2;","float fDet = max(0.0, B*B - 4.0 * C);","float fNear = 0.5 * (-B - sqrt(fDet));","vec3 v3Start = cameraPositionGround + v3Ray * fNear;","fFar -= fNear;","float fDepth = exp((fInnerRadius - fOuterRadius) / fScaleDepth);","float fCameraAngle = dot(-v3Ray, aVertexPosition) / length(aVertexPosition);","float fLightAngle = dot(v3LightPositionGround, aVertexPosition) / length(aVertexPosition);","float fCameraScale = scale(fCameraAngle);","float fLightScale = scale(fLightAngle);","float fCameraOffset = fDepth * fCameraScale;","float fTemp = (fLightScale + fCameraScale);","float fSampleLength = fFar / fSamples;","float fScaledLength = fSampleLength * fScale;","vec3 v3SampleRay = v3Ray * fSampleLength;","vec3 v3SamplePoint = v3Start + v3SampleRay * 0.5;","vec3 v3FrontColor = vec3(0.0, 0.0, 0.0);","vec3 v3Attenuate;","for(int i = 0; i < nSamples; i ++)","{","    float fHeight = length(v3SamplePoint);","    float fDepth = exp(fScaleOverScaleDepth * (fInnerRadius - fHeight));","    float fScatter = fDepth * fTemp - fCameraOffset;","    v3Attenuate = exp(-fScatter * (v3InvWavelength * fKr4PI + fKm4PI));","    v3FrontColor += v3Attenuate * (fDepth * fScaledLength);","    v3SamplePoint += v3SampleRay;","}","c0 = v3Attenuate;","c1 = v3FrontColor * (v3InvWavelength * fKrESun + fKmESun);","gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);","vTextureCoord = aVertexTextureCoord;","vCloudTextureCoord = aCloudTextureCoord;","}"].join("\\n");e8.FS_SHADER_TEXT=["precision highp float;","varying vec2 vTextureCoord;","varying vec2 vCloudTextureCoord;","uniform sampler2D uSampler;","uniform sampler2D uSamplerCloud;","uniform sampler2D uSamplerNight;","uniform bool uDrawCloud;","uniform float uEarthZoom;","uniform float uEarthZoomForNight;","uniform bool uUseColor;","uniform float fNightScale;","varying vec3 c0;","varying vec3 c1;","void main(void) {","    if (uUseColor == true) {","        gl_FragColor = vec4(c1, 1.0) + vec4(.01, .02, .15, 1.0);","        return;","    }","    vec4 cloudDiffuse = vec4(0, 0, 0, 0);","    float cloudAlpha = 0.0;","    if (uDrawCloud) {","        cloudDiffuse = texture2D(uSamplerCloud, vCloudTextureCoord);","        float grayValue = (cloudDiffuse.r + cloudDiffuse.g + cloudDiffuse.b) / 3.0;","        if (grayValue < 0.3) {","            cloudAlpha = 0.0;","        } else {","            cloudAlpha = grayValue;","        }","    }","    float atmosphereAlpha = 1.0;","    if (uEarthZoom > 5.0 && uEarthZoom < 6.0){","        atmosphereAlpha = 6.0 - uEarthZoom;","    }","    float cloudDisplayAlpha = 1.0;","    if (uEarthZoom > 1.0 && uEarthZoom < 2.0){","        cloudDisplayAlpha = 2.0 - uEarthZoom;","    }","    vec3 diffuseDay = (cloudDiffuse * cloudAlpha * cloudDisplayAlpha + ","        texture2D(uSampler, vTextureCoord) * (1.0 - cloudAlpha * cloudDisplayAlpha)).rgb;","    vec3 diffuseNight = texture2D( uSamplerNight, vTextureCoord ).rgb;","    vec3 day = diffuseDay * c0;","    vec3 night = 1.3 * diffuseNight * (1.0 - c0);","    if (uEarthZoom > uEarthZoomForNight) {","        gl_FragColor = vec4(c1, 1.0) * atmosphereAlpha + vec4(day, 1.0);","    }","    else {","        gl_FragColor = vec4(c1, 1.0) + vec4(day + night, 1.0);","    }","}"].join("\\n");e8.VS_SHADER_HIGH_LEVEL_TEXT=["precision highp float;","attribute vec3 aVertexPosition;","attribute vec2 aVertexTextureCoord;","varying vec2 vTextureCoord;","uniform mat4 uMVMatrix;","uniform mat4 uPMatrix;","void main(void) {","    gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);","    vTextureCoord = aVertexTextureCoord;","}"].join("\\n");e8.FS_SHADER_HIGH_LEVEL_TEXT=["precision highp float;","varying vec2 vTextureCoord;","uniform sampler2D uSampler;","uniform bool uUseColor;","void main(void) {","    if (uUseColor == true) {","        gl_FragColor = vec4(.11, .13, .23, 1.0);","        return;","    }","    gl_FragColor = texture2D(uSampler, vTextureCoord);","}"].join("\\n");ev.extend(e8.prototype,{_init:function(){this._initShaders();this._getAllUniforms();this._getAttribLocation();this._initShaders(true);this._getAllUniforms(true);this._getAttribLocation(true);this._sphere=this._earth._sphere},_initShaders:function(jh){var jf=this._gl;var e;var T;if(!jh){e=e8.VS_SHADER_TEXT;T=e8.FS_SHADER_TEXT;this._glProgram1=jf.createProgram();this._glProgram=this._glProgram1}else{e=e8.VS_SHADER_HIGH_LEVEL_TEXT;T=e8.FS_SHADER_HIGH_LEVEL_TEXT;this._glProgram2=jf.createProgram();this._glProgram=this._glProgram2}var jg=this._glProgram;var je=this._makeShader(e,jf.VERTEX_SHADER);var i=this._makeShader(T,jf.FRAGMENT_SHADER);jf.attachShader(jg,je);jf.attachShader(jg,i);jf.bindAttribLocation(jg,0,"aVertexPosition");jf.linkProgram(jg);jf.useProgram(jg)},_makeShader:function(je,e){var T=this._gl;var i=T.createShader(e);T.shaderSource(i,je);T.compileShader(i);return i},_getAllUniforms:function(jf){var je=this._glProgram;var T=this._gl;je.pMatrixUniform=T.getUniformLocation(je,"uPMatrix");je.mvMatrixUniform=T.getUniformLocation(je,"uMVMatrix");je.sampler=T.getUniformLocation(je,"uSampler");if(!jf){je.samplerCloud=T.getUniformLocation(je,"uSamplerCloud");je.samplerNight=T.getUniformLocation(je,"uSamplerNight");je.drawCloud=T.getUniformLocation(je,"uDrawCloud");je.nMatrixUniform=T.getUniformLocation(je,"uNMatrix");je.earthZoom=T.getUniformLocation(je,"uEarthZoom");je.earthZoomForNight=T.getUniformLocation(je,"uEarthZoomForNight");var i=this._atUniformsCommon;for(var e in i){ep(T,je,e)}i=this._atUniformsGround;for(e in i){ep(T,je,e)}i=this._atUniforms;for(e in i){ep(T,je,e)}}je.useColor=T.getUniformLocation(je,"uUseColor")},_setUniforms:function(){var jf=this._glProgram;var je=this._gl;var T=this._earth.getZoom();je.uniformMatrix4fv(jf.pMatrixUniform,false,this._pMatrix);if(T>15){je.uniformMatrix4fv(jf.mvMatrixUniform,false,this._mvMatrixCamera)}else{je.uniformMatrix4fv(jf.mvMatrixUniform,false,this._mvMatrix)}if(T<6){mat4.invert(this._nMatrix,this._mvMatrix);mat4.transpose(this._nMatrix,this._nMatrix);je.uniformMatrix4fv(jf.nMatrixUniform,false,this._nMatrix);je.uniform1f(jf.earthZoom,Math.round(T*1000)/1000);je.uniform1f(jf.earthZoomForNight,this._earth.zoomForNight);var i=this._atUniformsCommon;for(var e in i){bN(je,jf,e,i[e].value,i[e].type)}i=this._atUniformsGround;for(e in i){bN(je,jf,e,i[e].value,i[e].type)}i=this._atUniforms;for(e in i){bN(je,jf,e,i[e].value,i[e].type)}}},_getAttribLocation:function(T){var e=this._gl;var i=this._glProgram;i.vertexPositionAttribute=e.getAttribLocation(i,"aVertexPosition");i.vertexTexCoordAttribute=e.getAttribLocation(i,"aVertexTextureCoord");if(!T){i.cloudTexCoordAttribute=e.getAttribLocation(i,"aCloudTextureCoord")}},onStatusChange:function(i){this._camera=i;this._pMatrix=i.getProjectionMatrix();this._mvMatrix=i.getModelViewMatrix();var e=this._earth.getZoom();if(e>15){this._mvMatrixCamera=i._mvMatrixForCamera}this._arrCurViewTileModels=this._getCurViewTileModels();if(e<3){this._loadCloudTexture()}if(e<2){this._loadHighResTextures(true);return}var T=this;if(T.ThumbLoadTimer){clearTimeout(T.ThumbLoadTimer)}T.ThumbLoadTimer=setTimeout(function(){T._loadThumbTextures(3);T._loadThumbTextures();T._loadHighResTextures()},10)},_loadCloudTexture:function(){if(this._cloudTextureImage!==null||this._textureInfoPool.getData("cloud")){return}this._cloudTextureImage=new Image();this._cloudTextureImage.crossOrigin="anonymous";var je=this;var jf=this._gl;this._cloudTextureImage.onload=function(){var jg=dt.utils.createTexture(jf,this);je._textureInfoPool.setData("cloud",jg);je._cloudTextureImage=null;je._earth.fire(new fa("onrefresh"))};var e=this._earth.getContainerSize().height;var T=fD();var i="";if(e>800||T>=g0.HIGH_RES_MIN_RATIO){i=w.imgPath+"tiles/clouds-2k.jpg?20170702"}else{i=w.imgPath+"tiles/clouds.jpg?20170702"}this._cloudTextureImage.src=i},_loadHighResTextures:function(i){var e=this;if(!i&&e.loadTimer){clearTimeout(e.loadTimer)}if(i&&e.loadTimer){return}e.loadTimer=setTimeout(function(){e._loadTextures();e.loadTimer=null;if(e._earth.getZoom()<5&&e._earth._showRealSunlight){e._loadNightTextures()}},200)},_getCurViewTileModels:function(){var jg=this._earth;var jf=jg.scene;var i=jg.getBounds();var je=false;if(jf.ifXYZInView(0,this._radius,0)){je="n"}else{if(jf.ifXYZInView(0,-this._radius,0)){je="s"}}var e=this._sphere;var T=Math.floor(jg.getZoom());var jh=e.getCurViewModels(i,je,T);return jh},_loadThumbTextures:function(jp){if(this._earth._notLoadThumb){return}var jm=this._arrCurViewTileModels;var T={};var js=this;function ji(){js._thumbLoaded++;js._earth.fire(new fa("onrefresh"))}for(var jn=0,jl=jm.length;jn<jl;jn++){var jo=jm[jn];var jf=jo.col;var jh=jo.row;var jr=jo.imgZoom;if(jo.projType==="er"&&!jo.polar){continue}var je;var jg;var jt;var e;var jq=jp||jr-2;var jj=Math.pow(2,jr-jq);if(jo.polar===true){jt=jo.key.replace("_"+jr,"_"+jq)}else{je=Math.floor(jf/jj);jg=Math.floor(jh/jj);if(jq<=5){e=dD.getMergedKey(je,jg,jq)}jt="key_"+(jo.projType==="er"?"er_":"")+je+"_"+jg+"_"+jq}var jk;if(e){jk=this._mergedTextureCache.getData(e);if(!T[jt]&&(!jk||!jk[je+"_"+jg])){T[jt]=true;this._thumbToLoad++;this._loadTexture(je,jg,jq,jo.projType,jt,ji,e)}}else{jk=this._textureInfoPool.getData(jt);if(!jk&&!T[jt]){T[jt]=true;this._thumbToLoad++;this._loadTexture(je,jg,jq,jo.projType,jt,ji)}}}},_loadTexture:function(i,jm,jg,ji,jj,jl,je){var jh=this;var jf=this._gl;var T=this._imgPool.get();T.crossOrigin="anonymous";T.setAttribute("data-retry-count",0);T.onload=function jk(){var jn=false;if(ji!=="er"&&ji!=="night"&&ji!=="world"&&jg<=5){jh._mergeTileTexture(jf,i,jm,je,this,jg);jn=true}else{var jo=dt.utils.createTexture(jf,this,{format:jf.RGB});jh._textureInfoPool.setData(jj,jo)}jh._imgPool.free(this);if(jl){jl.call(jh,jj,jo,jn)}};T.onerror=function e(){var jn=this;var jq=this.src;var jp=parseInt(this.getAttribute("data-retry-count"),10);if(jp===5){return}jp++;this.setAttribute("data-retry-count",jp);jh._earth.fire(new fa("onsatelayerloaderror"));setTimeout(function jo(){jn.src=jq},3000)};T.src=this._layer.getTilesUrl(i,jm,jg,ji,jj)},_mergeTileTexture:function(ji,T,jh,jg,i,jf){var e=this._mergedTextureCache.getData(jg);if(!e){e=dt.utils.createTexture(ji,this._canvasForMergedTile,{format:ji.RGB});e.tileCount=0;e.totalCount=4;if((jf===3&&(T===2||T===-3))||(jf===4&&(T===4||T===-5))){e.totalCount/=2;if(jf===4&&jh===-3){e.totalCount/=2}}this._mergedTextureCache.setData(jg,e)}if(!e[T+"_"+jh]){ji.bindTexture(ji.TEXTURE_2D,e);e[T+"_"+jh]=true;e.tileCount++;var je=dD.getMergedTextureOffset(T,jh);ji.texSubImage2D(ji.TEXTURE_2D,0,je[0]*512,je[1]*512,ji.RGB,ji.UNSIGNED_BYTE,i)}},_loadNightTextures:function(){var i="key_er_1";var je=this._textureInfoPool.getData(i);if(!je){this._loadTexture(0,0,1,"world","key_er_1",this._onNightTextureLoad)}var e="night_key_er_1";var T=this._textureInfoPool.getData(e);if(!T){this._loadTexture(0,0,1,"night","night_key_er_1",this._onNightTextureLoad)}this._nightLoaded=!!(je&&T)},_onNightTextureLoad:function(){var i="key_er_1";var je=this._textureInfoPool.getData(i);var e="night_key_er_1";var T=this._textureInfoPool.getData(e);if(je&&T){this._nightLoaded=true;this._earth.fire(new fa("onrefresh"))}},_loadTextures:function(){if(this._earth._notLoadHigh){return}var jm=this;var jn=this._arrCurViewTileModels;for(var ji=0,jg=jn.length;ji<jg;ji++){var je=jn[ji];if(je.mergedTile){continue}var jf=je.col;var jp=je.row;var jk=je.imgZoom;var jo=je.key;var jh=je.mergedKey||"";if(je.projType==="er"){if(je.polar===true&&jk<=5){var T=jm._textureInfoPool.getData(jo);if(!T){this._tileNeedToLoadCount++;this._loadTexture(0,0,jk,je.projType,jo,this._onTexturesLoad)}}continue}if(je.mergedKey){var e=jm._mergedTextureCache.getData(je.mergedKey);if(e&&e[jf+"_"+jp]){continue}}var jj=jm._textureInfoPool.getData(jo);var jl=je.projType;if(!jj){this._tileNeedToLoadCount++;this._loadTexture(jf,jp,jk,jl,jo,this._onTexturesLoad,jh)}}jm._earth.fire(new fa("onrefresh"))},_onTexturesLoad:function(T,je,i){this._tileLoadedCount++;var jf=this._earth;if(this._tileNeedToLoadCount===this._tileLoadedCount){this._tileNeedToLoadCount=this._tileLoadedCount=0;if(!jf._firstTilesLoadedTime){var e=new fa("onearthtilesloaded");e.initTime=jf._initFinishTime-jf._initStartTime;e.loadTime=jf._firstTilesLoadedTime=Date.now()-jf._initStartTime;jf.fire(e)}this._earth.fire(new fa("ontilesloaded"))}if(!i){this._textureInfoPool.setData(T,je)}jf.fire(new fa("onrefresh"))},renderFrame:function(){var T=this._gl;var e=this._earth.getZoom();if(e<6){this._glProgram=this._glProgram1}else{this._glProgram=this._glProgram2}T.useProgram(this._glProgram);var i=this._webglState;i.disableCap("depthTest");i.enableCap("blend");i.enableCap("cullFace");i.cullFace(T.BACK);i.blendFunc(T.SRC_ALPHA,T.ONE_MINUS_SRC_ALPHA);i.depthMask(true);this.updateAt();this._setUniforms();i.initAttribute();this._renderFrame()},_renderFrame:function(){var jy=this._gl;var jf=this._earth;var je=jf.getZoom();var jl=this._glProgram;var jx=this._arrCurViewTileModels;var jj=this._webglState;jj.enableAttribute(jl.vertexPositionAttribute);jj.enableAttribute(jl.vertexTexCoordAttribute);var jm=false;var ju=this._textureInfoPool.getData("cloud");if(ju&&je<2){jm=true;jj.enableAttribute(jl.cloudTexCoordAttribute)}jj.disableUnusedAttributes();if(!jx||jx.length===0){return}var jr=this._earth.zoomForNight;var jo=this._float32Array;var jp=this._uint16Array;var e=[];var jt=0;if(je>=jr+1){var jh=[];var jg=[];var jq=0;for(var jz=0,jv=jx.length;jz<jv;jz++){var jA=jx[jz];if(jA.loadTextureOnly){continue}if(jA.projType==="er"&&!jA.polar){continue}e.push(jA);var jC=jA.vertex;var jk=jA.index;var T=jA.textureCoord;var jF=jA.key;var js=null;if(jA.atEdge!==true){if(jA.mergedTile){js=this._mergedTextureCache.getData(jF)}else{js=this._textureInfoPool.getData(jF)}}if(!js||jA.mergedTile&&js.totalCount!==js.tileCount){var jE=this._getThumbTextureInfo(jA);if(jE){js=jE[0];T=jE[1]}}jA.texture=js;if(je>15){for(var jw=0,jn=jC.length/3;jw<jn;jw++){var jD=[jC[jw*3],jC[jw*3+1],jC[jw*3+2]];jD=aj(jD,jf.rotationInfo);jh.push(jD[0],jD[1],jD[2],T[jw*2],T[jw*2+1])}}else{for(var jw=0,jn=jC.length/3;jw<jn;jw++){jh.push(jC[jw*3],jC[jw*3+1],jC[jw*3+2],T[jw*2],T[jw*2+1])}}if(jt>0){jq=jq+e[jt-1].vertex.length/3}for(jw=0,jn=jk.length/3;jw<jn;jw++){jg.push(jk[jw*3]+jq,jk[jw*3+1]+jq,jk[jw*3+2]+jq)}jt++}jy.bindBuffer(jy.ARRAY_BUFFER,this._trianglesVerticeBuffer);if(jh.length<jo.length){jo.set(jh)}else{jo=new Float32Array(jh)}jy.bufferData(jy.ARRAY_BUFFER,jo,jy.STREAM_DRAW);jy.vertexAttribPointer(jl.vertexPositionAttribute,3,jy.FLOAT,false,20,0);jy.vertexAttribPointer(jl.vertexTexCoordAttribute,2,jy.FLOAT,false,20,12);if(jl.cloudTexCoordAttribute){jy.vertexAttribPointer(jl.cloudTexCoordAttribute,2,jy.FLOAT,false,20,12)}jy.bindBuffer(jy.ELEMENT_ARRAY_BUFFER,this._triangleVerticesIndexBuffer);if(jg.length<jp.length){jp.set(jg)}else{jp=new Uint16Array(jg)}jy.bufferData(jy.ELEMENT_ARRAY_BUFFER,jp,jy.STATIC_DRAW);var ji=0;jy.uniform1i(jl.drawCloud,jm);jj.activeTexture(jy.TEXTURE0);for(jz=0,jv=e.length;jz<jv;jz++){var jA=e[jz];var jk=jA.index;var js=jA.texture;if(!js){if(jA.projType!=="er"||jA.polar===true){jy.uniform1i(jl.useColor,true)}}else{jy.uniform1i(jl.useColor,false);jy.bindTexture(jy.TEXTURE_2D,js)}jy.uniform1i(jl.sampler,0);if(jz>0){ji=ji+e[jz-1].index.length*2}jy.drawElements(jy.TRIANGLES,jk.length,jy.UNSIGNED_SHORT,ji)}}if(je<jr+1){var jA=jx[jx.length-1];var jC=jA.vertex;var jk=jA.index;var T=jA.textureCoord;var jF=jA.key;var js=this._textureInfoPool.getData(jF);var jh=[];for(var jw=0,jn=jC.length/3;jw<jn;jw++){jh.push(jC[jw*3],jC[jw*3+1],jC[jw*3+2],T[jw*2],T[jw*2+1])}jy.bindBuffer(jy.ARRAY_BUFFER,this._trianglesVerticeBuffer);jo.set(jh);jy.bufferData(jy.ARRAY_BUFFER,jo,jy.STREAM_DRAW);jy.vertexAttribPointer(jl.vertexPositionAttribute,3,jy.FLOAT,false,20,0);jy.vertexAttribPointer(jl.vertexTexCoordAttribute,2,jy.FLOAT,false,20,12);jy.vertexAttribPointer(jl.cloudTexCoordAttribute,2,jy.FLOAT,false,20,12);jy.bindBuffer(jy.ELEMENT_ARRAY_BUFFER,this._triangleVerticesIndexBuffer);jp.set(jk);jy.bufferData(jy.ELEMENT_ARRAY_BUFFER,jp,jy.STREAM_DRAW);jy.uniform1i(jl.useColor,true);if(js){jj.activeTexture(jy.TEXTURE0);jy.uniform1i(jl.useColor,false);jy.bindTexture(jy.TEXTURE_2D,js);jy.uniform1i(jl.sampler,0)}if(ju){jy.uniform1i(jl.drawCloud,true);jy.activeTexture(jy.TEXTURE2);jy.bindTexture(jy.TEXTURE_2D,ju);jy.uniform1i(jl.samplerCloud,2)}if(this._earth._showRealSunlight){var jB=this._textureInfoPool.getData("night_"+jF);if(jB){jj.activeTexture(jy.TEXTURE1);jy.bindTexture(jy.TEXTURE_2D,jB);jy.uniform1i(jl.samplerNight,1)}}jy.drawElements(jy.TRIANGLES,jk.length,jy.UNSIGNED_SHORT,0)}},_getThumbTextureInfo:function(jv){var jh=jv.col;var jk=jv.row;var jx=jv.imgZoom;var jp=null;var jm=jx-1;var jo=1;while(!jp&&jm>=jo){var jn=Math.pow(2,jx-jm);var jg=Math.floor(jh/jn);var jj=Math.floor(jk/jn);var jz;var jw=false;if(jv.projType==="er"){if(jv.polar===true){jz=jv.key.replace("_"+jx,"_"+jm);jp=this._textureInfoPool.getData(jz);if(jp){return[jp,jv.textureCoord]}}}else{if(jm<=5){jw=true;if(jx<=5){jz="key_merge_"+jg+"_"+jj+"_"+jm}else{jz=dD.getMergedKey(jg,jj,jm)}}else{jz="key_"+jg+"_"+jj+"_"+jm}}if(jw){jp=this._mergedTextureCache.getData(jz)}else{jp=this._textureInfoPool.getData(jz)}if(jp){var T=jg*jn;var jf=jj*jn;var js=jh-T;var ju=jk-jf;var jq=jn;var jy=js/jq;var jl=ju/jq;var e=jv.textureCoord.slice(0);var je=0;if(jv.textureCoord._dir){je=jv.textureCoord._dir==="left"?-0.01:0.01;if(jw){je/=2}}for(var jt=0,jr=e.length;jt<jr;jt+=2){e[jt]=jy+(e[jt]-je)/jn+je;e[jt+1]=jl+e[jt+1]/jn;if(jx>5&&jw){var ji=dD.getMergedTextureOffset(jg,jj);e[jt]=e[jt]/2+ji[0];e[jt+1]=e[jt+1]/2+ji[1]}}return[jp,e]}jm--}return null},updateAt:function(){var e=this._atmosphereData;var T=this._earth.getZoom();if(T>1){var i=T-1;i=i>1.2?1.2:i;e.Kr=0.0075-i*0.0005;e.ESun=16-i*1;e.scaleDepth=0.25-i/20;this._atUniforms.fKrESun.value=e.Kr*e.ESun;this._atUniforms.fKmESun.value=e.Km*e.ESun;this._atUniforms.fScaleDepth.value=e.scaleDepth;this._atUniforms.fScaleOverScaleDepth.value=1/(e.outerRadius-e.innerRadius)/e.scaleDepth}}});function bU(e){this._earth=e;var i=this._gl=G(e._canvas);this._overlayManagerGL=new fr(e);this._layers=e._layers;this._textureInfoPool=new hn(200,{clearCallback:function(T){if(T&&T.texture){i.deleteTexture(T.texture)}}});this._overlayTextureInfo={texture:null,opacity:0,width:0,height:0};this._overlayTextureInfoLOD={texture:null,opacity:0,width:0,height:0};this._imgCache=new hn(150);this._imgToLoad=0;this._preModels={};this.bind()}ev.extend(bU.prototype,{bind:function(){var T=this;function i(je){T._textureInfoPool.forEach(function(jf){jf.texture=null});T.loadTiles()}function e(je){if(je.layer&&!je.layer.renderer){T._textureInfoPool.clear();T.loadTiles()}}this._earth.on("layer_add",e);this._earth.on("layer_remove",e);this._earth.on("overlaylayer_status_change",i)},prepareData:function(){if(this._tileModels){var jf={};for(var je=0,e=this._tileModels.length;je<e;je++){var T=this._tileModels[je].key;jf[T]=true}}},savePreModels:function(){this._preModels={};if(this._tileModels){for(var je=0,e=this._tileModels.length;je<e;je++){var T=this._tileModels[je].key;this._preModels[T]=true}}},loadTiles:function(){var jj=this._tileModels;if(!jj){return}this.prepareData();this.processOverlayCanvas();if(this._loadTimer){clearTimeout(this._loadTimer)}var ji=this;this._loadTimer=setTimeout(function(){if(ji._imgToLoad>0){ji._clearWaiting();ji._startAlphaAnimation()}this._loadTimer=null},1500);for(var jg=0,je=jj.length;jg<je;jg++){var e=jj[jg];var T=e.col;var jl=e.row;var jh=e.imgZoom;var jk=e.key;var jf=this._textureInfoPool.getData(jk);if(!jf){jf={imageLoad:false,texture:null,opacity:0};this._textureInfoPool.setData(jk,jf)}this.loadTile(T,jl,jh,jk)}if(this._imgToLoad===0){clearTimeout(this._loadTimer);this._earth.fire(new fa("onlayertilesload"));this._startAlphaAnimation()}},processOverlayCanvas:function(){this._overlayManagerGL.generateOverlayTile();var e=this._overlayManagerGL.getOverlayCanvas();this._prepareOverlayTexture(e);if(this._earth.getTilt()>0&&this._earth.getImageZoom()>3||this._earth.getZoom()<6){this._overlayManagerGL.generateOverlayTile(this._earth.getImageZoom()-1);var i=this._overlayManagerGL.getOverlayCanvas(true);this._prepareOverlayTexture(i,true)}},loadTile:function(i,jh,jg,T){var jf=this._textureInfoPool.getData(T);if(jf.imageLoad&&jf.texture!==null){if(this._preModels[T]){jf.opacity=1}return}if(this._layers.length<2||!this._layers[1].getTilesUrl){jf.imageLoad=true;clearTimeout(this._loadTimer);return}var je=this;var e=this._imgCache.getData(T);if(e){jf.imageLoad=true;je._prepareImgTexture(e,i,jh,jg,T);if(je._imgToLoad===0){clearTimeout(je._loadTimer);je._clearWaiting();je._startAlphaAnimation()}return}e=new Image();e.crossOrigin="anonymous";this._imgToLoad++;e.onload=function(){jf.imageLoad=true;je._prepareImgTexture(this,i,jh,jg,T);je._imgToLoad--;je._imgCache.setData(T,this);if(je._imgToLoad===0){clearTimeout(je._loadTimer);je._clearWaiting();je._startAlphaAnimation();if(!je._earth._firstLayerTilesLoadedTime){var ji=new fa("onlayertilesload");ji.layersLoadTime=je._earth._firstLayerTilesLoadedTime=Date.now()-je._earth._initStartTime;je._earth.fire(ji)}}};e.onerror=function(){je._earth.fire(new fa("onstreetlayerloaderror"))};e.src=je._layers[1].getTilesUrl(i,jh,jg)},_prepareImgTexture:function(e,i,jh,jg,T){var jf=this._createTexture(e);var je=this._textureInfoPool.getData(T);if(je){je.texture=jf;je.waitForOthers=true}},_prepareOverlayTexture:function(T,i){if(!T){return}var je=this._createTexture(T);var e;if(!i){e=this._overlayTextureInfo}else{e=this._overlayTextureInfoLOD}e.texture=je;e.waitForOthers=false;e.width=T.width;e.height=T.height;e.fromCol=T.fromCol;e.fromRow=T.fromRow;e.toCol=T.toCol;e.toRow=T.toRow;e.cols=T.cols;e.rows=T.rows},_startAlphaAnimation:function(){var e=this;if(e._ani){e._ani.stop()}e._ani=new e3({duration:400,transition:fY.easeOutQuad,render:function(T,i){e._setTextureOpacity(T)},finish:function(){e._setTextureOpacity(1);e._ani=null},onStop:function(i){e._setTextureOpacity(1);e._ani=null}})},_createTexture:function(T){var i=this._gl;var e=i.createTexture();i.bindTexture(i.TEXTURE_2D,e);i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,true);i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,T);i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE);i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE);i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR);i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR);return e},_clearWaiting:function(){var T=this._tileModels;for(var jf=0,e=T.length;jf<e;jf++){var je=T[jf].key;var jg=this._textureInfoPool.getData(je);if(jg){jg.waitForOthers=false;if(jg.opacity!==1){jg.opacity=0}}}},_setTextureOpacity:function(jh){var T=this._tileModels;var jg=1;for(var jf=0,e=T.length;jf<e;jf++){var je=T[jf].key;var ji=this._textureInfoPool.getData(je);if(ji&&ji.opacity!==jg){ji.opacity=jh*jg}}this._earth.fire(new fa("onrefresh"))},getTextureInfo:function(e){return this._textureInfoPool.getData(e)},getOverlayTextureInfo:function(e){if(e){return this._overlayTextureInfoLOD}return this._overlayTextureInfo}});function fH(e){this._earth=e;this._canvas=e._canvas;var i=this._gl=e.scene._gl;this._webglState=dt.WebGLState.get(i,e._guid);this._glProgram=null;this._radius=e.radius;this._blankTileCanvas=bL("canvas");this._blankTileCanvas.width=this._blankTileCanvas.height=256;this._blankTileCanvas.getContext("2d").clearRect(0,0,256,256);this._blankTileTexture=null;this._mvMatrix=mat4.create();this._pMatrix=mat4.create();this._mvMatrixCamera=mat4.create();this._trianglesVerticeBuffer=i.createBuffer();this._triangleVerticesIndexBuffer=i.createBuffer();this._float32Array=new Float32Array(3000);this._uint16Array=new Uint16Array(3000);this.zIndex=11;this._init()}fH.VS_SHADER_TEXT=["precision highp float;","attribute vec3 aVertexPosition;","attribute vec2 aVertexTextureCoord;","attribute vec2 aOverlayTextureCoord;","varying vec2 vTextureCoord;","varying vec2 vOverlayTextureCoord;","uniform mat4 uMVMatrix;","uniform mat4 uPMatrix;","void main(void) {","    gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);","    vTextureCoord = aVertexTextureCoord;","    vOverlayTextureCoord = aOverlayTextureCoord;","}"].join("\\n");fH.FS_SHADER_TEXT=["precision highp float;","varying vec2 vTextureCoord;","varying vec2 vOverlayTextureCoord;","uniform sampler2D uSampler;","uniform sampler2D uOverlaySampler;","uniform float uAlpha;","","vec4 getBlendColor(in vec4 source, in vec4 back, in float alphaSource, in float alphaBack) {","    vec4 finalColor = (1.0 - alphaSource / 1.0) * back +","                      (alphaSource / 1.0) * ((1.0 - alphaBack) * source + alphaBack * source);","    return finalColor;","}","","void main(void) {","    vec4 layer = texture2D(uSampler, vTextureCoord);","    vec4 overlay = texture2D(uOverlaySampler, vOverlayTextureCoord);","    vec4 finalColor = getBlendColor(overlay, layer * uAlpha, overlay.a, layer.a);","    if (finalColor.a == 0.0) {","        discard;","    }","    gl_FragColor = vec4(finalColor.rgb, finalColor.a);","}"].join("\\n");ev.extend(fH.prototype,{_init:function(){this._gl=G(this._canvas);this._initShaders();this._getAllUniforms();this._getAttribLocation();this._createBlankTileTexture();this._layerTextureManager=new bU(this._earth);this._sphere=this._earth._sphere},_initShaders:function(){var e=fH.VS_SHADER_TEXT;var T=fH.FS_SHADER_TEXT;var jf=this._gl;var jg=this._glProgram=jf.createProgram();var je=this._makeShader(e,jf.VERTEX_SHADER);var i=this._makeShader(T,jf.FRAGMENT_SHADER);jf.attachShader(jg,je);jf.attachShader(jg,i);jf.linkProgram(jg);jf.useProgram(jg)},_makeShader:function(je,e){var T=this._gl;var i=T.createShader(e);T.shaderSource(i,je);T.compileShader(i);return i},_getAllUniforms:function(){var i=this._glProgram;var e=this._gl;i.pMatrixUniform=e.getUniformLocation(i,"uPMatrix");i.mvMatrixUniform=e.getUniformLocation(i,"uMVMatrix");i.sampler=e.getUniformLocation(i,"uSampler");i.overlaySampler=e.getUniformLocation(i,"uOverlaySampler");i.alpha=e.getUniformLocation(i,"uAlpha")},_setUniforms:function(){var i=this._glProgram;var e=this._gl;e.uniformMatrix4fv(i.pMatrixUniform,false,this._pMatrix);if(this._earth.getZoom()>15){e.uniformMatrix4fv(i.mvMatrixUniform,false,this._mvMatrixCamera)}else{e.uniformMatrix4fv(i.mvMatrixUniform,false,this._mvMatrix)}},_getAttribLocation:function(){var e=this._gl;var i=this._glProgram;i.vertexPositionAttribute=e.getAttribLocation(i,"aVertexPosition");i.vertexTexCoordAttribute=e.getAttribLocation(i,"aVertexTextureCoord");i.overlayTexCoordAttribute=e.getAttribLocation(i,"aOverlayTextureCoord")},_createBlankTileTexture:function(){var i=this._gl;var e=this._blankTileTexture=i.createTexture();i.bindTexture(i.TEXTURE_2D,e);i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,this._blankTileCanvas);i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE);i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE);i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR);i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR)},onStatusChange:function(i){this._camera=i;this._pMatrix=i.getProjectionMatrix();this._mvMatrix=i.getModelViewMatrix();var e=this._earth.getZoom();var je=Math.floor(e);if(e>15){this._mvMatrixCamera=i._mvMatrixForCamera}if(je>=this._earth.zoomForNight+1){var T=this;if(T.loadTimer){clearTimeout(T.loadTimer)}T.loadTimer=setTimeout(function(){if(T._earth.getZoom()<T._earth.zoomForNight+1){return}var jf=T._arrCurViewTileModels=T._sphere.getCurViewNormalModels();T._layerTextureManager.savePreModels();T._layerTextureManager._tileModels=jf;if(T._earth._notLoadHigh){return}if(!jf){return}T._layerTextureManager.loadTiles()},200)}else{this._arrCurViewTileModels=null}},renderFrame:function(){if(this._earth.getZoom()<this._earth.zoomForNight+1){return}var T=this._gl;T.useProgram(this._glProgram);var i=this._webglState;i.disableCap("depthTest");i.enableCap("blend");i.enableCap("cullFace");i.cullFace(T.BACK);i.blendFunc(T.SRC_ALPHA,T.ONE_MINUS_SRC_ALPHA);this._setUniforms();var e=this._arrCurViewTileModels;if(e){this._renderFrame(e)}},_renderFrame:function(jE){if(jE.length===0){return}var jy=this._earth._map;var jk=jy._displayOptions.street;var jl=jy._displayOptions.overlay;if(!jk&&!jl){return}var jm=this._gl;var jn=this._glProgram;var je=jE[0].imgZoom;var e=this._earth;var jo=e.getImageZoom();if(Math.abs(je-jo)>2){return}var jL=this._webglState;jL.initAttribute();jL.enableAttribute(jn.vertexPositionAttribute);jL.enableAttribute(jn.vertexTexCoordAttribute);jL.enableAttribute(jn.overlayTexCoordAttribute);jL.disableUnusedAttributes();var jx=this._layerTextureManager.getOverlayTextureInfo();var jw=jx?jx.texture:null;var jJ=this._layerTextureManager.getOverlayTextureInfo(true);var ji=jJ?jJ.texture:null;var jD=jx;var jI=jx.cols;var jf=jx.rows;var jK=e.getTilt();if(jK===0&&jl){jL.activeTexture(jm.TEXTURE1);jm.bindTexture(jm.TEXTURE_2D,jw||this._blankTileTexture);jm.uniform1i(jn.overlaySampler,1)}for(var jH=0,jF=jE.length;jH<jF;jH++){var jg=jE[jH];var jv=jg.vertex;var jA=jg.index;var jB=jg.textureCoord;var jr=jg.key;var jj=jg.col;var jp=jg.row;var T=jg.imgZoom;var jh=this._layerTextureManager.getTextureInfo(jr);var jt=jh?jh.texture:null;jm.uniform1f(jn.alpha,jh?jh.opacity:0);if(jK>0&&jl){jL.activeTexture(jm.TEXTURE1);if(T===jo){jD=jx;jm.bindTexture(jm.TEXTURE_2D,jw)}else{jD=jJ;jm.bindTexture(jm.TEXTURE_2D,ji)}jm.uniform1i(jn.overlaySampler,1);jI=jD.cols;jf=jD.rows}var jC=[];for(var jG=0,jz=jv.length/3;jG<jz;jG++){if(e.getZoom()>15){var jq=[jv[jG*3],jv[jG*3+1],jv[jG*3+2]];jq=aj(jq,e.rotationInfo);jC.push(jq[0],jq[1],jq[2],jB[jG*2],jB[jG*2+1])}else{jC.push(jv[jG*3],jv[jG*3+1],jv[jG*3+2],jB[jG*2],jB[jG*2+1])}var js=jj-jD.fromCol;var ju=jp-jD.fromRow;if(jj<=jD.toCol&&jp<=jD.toRow&&js>=0&&ju>=0&&jl){jC.push(jB[jG*2]/jI+js/jI,jB[jG*2+1]/jf+ju/jf)}else{jC.push(0,0)}}jm.bindBuffer(jm.ARRAY_BUFFER,this._trianglesVerticeBuffer);if(jC.length>this._float32Array.length){continue}this._float32Array.set(jC);jm.bufferData(jm.ARRAY_BUFFER,this._float32Array,jm.STREAM_DRAW);jm.vertexAttribPointer(jn.vertexPositionAttribute,3,jm.FLOAT,false,28,0);jm.vertexAttribPointer(jn.vertexTexCoordAttribute,2,jm.FLOAT,false,28,12);jm.vertexAttribPointer(jn.overlayTexCoordAttribute,2,jm.FLOAT,false,28,20);jm.bindBuffer(jm.ELEMENT_ARRAY_BUFFER,this._triangleVerticesIndexBuffer);if(jA.length>this._uint16Array.length){continue}this._uint16Array.set(jA);jm.bufferData(jm.ELEMENT_ARRAY_BUFFER,this._uint16Array,jm.STREAM_DRAW);jL.activeTexture(jm.TEXTURE0);if(jt&&jh.waitForOthers===false&&jk){jm.bindTexture(jm.TEXTURE_2D,jt)}else{jm.bindTexture(jm.TEXTURE_2D,this._blankTileTexture)}jm.uniform1i(jn.sampler,0);jm.drawElements(jm.TRIANGLES,jA.length,jm.UNSIGNED_SHORT,0)}}});function fn(T){this._earth=T;this._canvas=T._canvas;var je=this._gl=T.scene._gl;this._webglState=dt.WebGLState.get(this._gl,T._guid);this._glProgram=null;this._trianglesVerticeBuffer=je.createBuffer();this._triangleVerticesIndexBuffer=je.createBuffer();this._float32Array=new Float32Array(120600);this._uint16Array=new Uint16Array(240000);this._atmosphereData={Kr:0.0015,Km:0.00001,ESun:16,g:-0.95,innerRadius:0.992*T.radius,outerRadius:1.02*T.radius,wavelength:[0.65,0.57,0.475],scaleDepth:0.25,mieScaleDepth:0.1};var e=this._atmosphereData;this._uniformsCommon={modelViewMatrix:{type:"mat4",value:mat4.create()},projectionMatrix:{type:"mat4",value:mat4.create()},cameraPosition:{type:"v3",value:vec3.fromValues(0,0,4.4*T.radius)},v3LightPosition:{type:"v3",value:vec3.normalize(vec3.create(),vec3.fromValues(100000000,0,100000000))},v3InvWavelength:{type:"v3",value:vec3.fromValues(1/Math.pow(e.wavelength[0],4),1/Math.pow(e.wavelength[1],4),1/Math.pow(e.wavelength[2],4))},v3LightDirection:{type:"v3",value:vec3.fromValues(0,0,1)},fCameraHeight:{type:"f",value:0},fCameraHeight2:{type:"f",value:0},nSamples:{type:"i",value:3},fSamples:{type:"f",value:3}};this._uniforms={fInnerRadius:{type:"f",value:e.innerRadius},fInnerRadius2:{type:"f",value:e.innerRadius*e.innerRadius},fOuterRadius:{type:"f",value:e.outerRadius},fOuterRadius2:{type:"f",value:e.outerRadius*e.outerRadius},fKrESun:{type:"f",value:e.Kr*e.ESun},fKmESun:{type:"f",value:e.Km*e.ESun},fKr4PI:{type:"f",value:e.Kr*4*Math.PI},fKm4PI:{type:"f",value:e.Km*4*Math.PI},fScale:{type:"f",value:1/(e.outerRadius-e.innerRadius)},fScaleDepth:{type:"f",value:e.scaleDepth},fScaleOverScaleDepth:{type:"f",value:1/(e.outerRadius-e.innerRadius)/e.scaleDepth},g:{type:"f",value:e.g},g2:{type:"f",value:e.g*e.g},nSamples:{type:"i",value:3},fSamples:{type:"f",value:3},fNightScale:{type:"f",value:6}};this._atUniformsGround={cameraPositionGround:{type:"v3",value:vec3.fromValues(0,0,4.4*T.radius)},v3LightPositionGround:{type:"v3",value:vec3.normalize(vec3.create(),vec3.fromValues(100000000,0,100000000))},fCameraHeightGround:{type:"f",value:0},fCameraHeight2Ground:{type:"f",value:0}};this._lightForAni=vec3.create();this._lightForAniGround=vec3.create();this._processApart=false;this._initialized=false;var i=this;setTimeout(function(){i._init()},200);this.zIndex=2}fn.VS_SHADER_TEXT=["precision highp float;","attribute vec3 position;","uniform vec3 cameraPosition;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform vec3 v3LightPosition;","uniform vec3 v3LightPositionGround;","uniform vec3 v3InvWavelength;","uniform float fCameraHeight;","uniform float fCameraHeight2;","uniform float fCameraHeightGround;","uniform float fCameraHeight2Ground;","uniform float fOuterRadius;","uniform float fOuterRadius2;","uniform float fInnerRadius;","uniform float fInnerRadius2;","uniform float fKrESun;","uniform float fKmESun;","uniform float fKr4PI;","uniform float fKm4PI;","uniform float fScale;","uniform float fScaleDepth;","uniform float fScaleOverScaleDepth;","const int nSamples = 3;","const float fSamples = 3.0;","varying vec3 v3Direction;","varying vec3 c0;","varying vec3 c1;","float scale(float fCos) {","    float x = 1.0 - fCos;","    return fScaleDepth * exp(-0.00287 + x*(0.459 + x*(3.83 + x*(-6.80 + x*5.25))));","}","void main(void) {","    vec3 v3Ray = position - cameraPosition;","    float fFar = length(v3Ray);","    v3Ray /= fFar;","    float B = 2.0 * dot(cameraPosition, v3Ray);","    float C = fCameraHeight2 - fOuterRadius2;","    float fDet = max(0.0, B * B - 4.0 * C);","    float fNear = 0.5 * (-B - sqrt(fDet));","    vec3 v3Start = cameraPosition + v3Ray * fNear;","    fFar -= fNear;","    float fStartAngle = dot(v3Ray, v3Start) / fOuterRadius;","    float fStartDepth = exp(-1.0 / fScaleDepth);","    float fStartOffset = fStartDepth * scale(fStartAngle);","    float fSampleLength = fFar / fSamples;","    float fScaledLength = fSampleLength * fScale;","    vec3 v3SampleRay = v3Ray * fSampleLength;","    vec3 v3SamplePoint = v3Start + v3SampleRay * 0.5;","    vec3 v3FrontColor = vec3(0.0, 0.0, 0.0);","    for(int i = 0; i < nSamples; i++) {","        float fHeight = length(v3SamplePoint);","        float fDepth = exp(fScaleOverScaleDepth * (fInnerRadius - fHeight));","        float fLightAngle = dot(v3LightPosition, v3SamplePoint) / fHeight;","        float fCameraAngle = dot(v3Ray, v3SamplePoint) / fHeight;","        float fScatter = (fStartOffset + fDepth * (scale(fLightAngle) - scale(fCameraAngle)));","        vec3 v3Attenuate = exp(-fScatter * (v3InvWavelength * fKr4PI + fKm4PI));","        v3FrontColor += v3Attenuate * (fDepth * fScaledLength);","        v3SamplePoint += v3SampleRay;","    }","    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","    c0 = v3FrontColor * (v3InvWavelength * fKrESun);","    c1 = v3FrontColor * fKmESun;","    v3Direction = cameraPosition - position;","}",].join("\\n");fn.FS_SHADER_TEXT=["precision highp float;","uniform float g;","uniform float g2;","uniform vec3 v3LightDirection;","varying vec3 v3Direction;","varying vec3 c0;","varying vec3 c1;","float getMiePhase(float fCos, float fCos2, float g, float g2) {","    return 1.5 * ((1.0 - g2) / (2.0 + g2)) * (1.0 + fCos2) / pow(1.0 + g2 - 2.0 * g * fCos, 1.5);","}","float getRayleighPhase(float fCos2) {","    return 0.75 + 0.75 * fCos2;","}","void main (void) {","    float fCos = dot(v3LightDirection, v3Direction) / length(v3Direction);","    float fCos2 = fCos * fCos;","    vec3 color = getRayleighPhase(fCos2) * c0 + getMiePhase(fCos, fCos2, g, g2) * c1;","    if (color.r == 0.0 && color.g == 0.0 && color.b == 0.0) {","        discard;","    }","    gl_FragColor = vec4(color, color.b);","}"].join("\\n");ev.extend(fn.prototype,{_init:function(){var i=new gJ(515,{latSpan:50});var e=ev.Platform.macintosh?128:64;i.setSegments(e,e/6);this._ringData=i.generateAllVertex();this._initShaders();this._getAllUniforms();this._getAttribLocation();this._initialized=true;this._earth.fire(new fa("onforcerefresh"))},_initShaders:function(){var e=fn.VS_SHADER_TEXT;var T=fn.FS_SHADER_TEXT;var jf=this._gl;var jg=this._glProgram=jf.createProgram();var je=this._makeShader(e,jf.VERTEX_SHADER);var i=this._makeShader(T,jf.FRAGMENT_SHADER);jf.attachShader(jg,je);jf.attachShader(jg,i);jf.bindAttribLocation(jg,0,"aVertexPosition");jf.linkProgram(jg);jf.useProgram(jg)},_makeShader:function(je,e){var T=this._gl;var i=T.createShader(e);T.shaderSource(i,je);T.compileShader(i);return i},_getAllUniforms:function(){var je=this._glProgram;var T=this._gl;var i=this._uniformsCommon;for(var e in i){ep(T,je,e)}i=this._uniforms;for(e in i){ep(T,je,e)}i=this._atUniformsGround;for(e in i){ep(T,je,e)}},_getAttribLocation:function(){var i=this._glProgram;var e=this._gl;i.vertexPositionAttribute=e.getAttribLocation(i,"position")},onStatusChange:function(T){if(!this._initialized){return}var je=this._earth.getZoom();if(je>=6){return}this._preZoom=this._zoom||je;this._zoom=je;this._camera=T;var i=this._earth.zoomForNight;if(this._sunLightAni){if(this._preZoom<je&&this._aniDir==="in"||this._preZoom>je&&this._aniDir==="out"||this._preZoom===je){return}}if(this._preZoom<=i&&je>i){this._sunLightAni&&this._sunLightAni.stop();this._startZoomInLightAnimation(T);return}if(je<=i&&this._preZoom>i){this._sunLightAni&&this._sunLightAni.stop();this._startZoomOutLightAnimation(T);return}var jg=vec3.create();var jf=T.getPositionForAt();var e=vec3.create();if(je<=i){vec3.normalize(jg,T.getLightPositionForAt());vec3.normalize(e,T.getLightPosition())}else{vec3.normalize(jg,jf);vec3.normalize(e,T.getPosition())}this._setAtUniforms(jg,e)},_startZoomInLightAnimation:function(T){this._aniDir="in";var i=this._lightForAni;var e=this._lightForAniGround;if(i[0]===0&&i[1]===0&&i[2]===0){vec3.normalize(i,T.getLightPositionForAt());vec3.normalize(e,T.getLightPosition())}var je=this;this._sunLightAni=new e3({duration:800,transition:fY.easeOutCubic,render:function(jh,jg){if(jh===0){return}var jk=je._camera.getPositionForAt();var ji=vec3.normalize(vec3.create(),jk);var jj=je._camera.getPosition();var jf=vec3.normalize(vec3.create(),jj);i[0]=0.9*i[0]+0.1*ji[0];i[1]=0.9*i[1]+0.1*ji[1];i[2]=0.9*i[2]+0.1*ji[2];e[0]=0.9*e[0]+0.1*jf[0];e[1]=0.9*e[1]+0.1*jf[1];e[2]=0.9*e[2]+0.1*jf[2];je._setAtUniforms(i,e);je._earth.fire(new fa("onrefresh"))},finish:function(){je._earth.fire(new fa("onanimation_end"));je._sunLightAni=null},onStop:function(jf){je._earth.fire(new fa("onanimation_end"));je._sunLightAni=null}})},_startZoomOutLightAnimation:function(jh){this._aniDir="out";var e=jh.getPositionForAt();var i=vec3.normalize(vec3.create(),e);var ji=jh.getPosition();var jl=vec3.normalize(vec3.create(),ji);var jf=this._lightForAni;var T=this._lightForAniGround;if(jf[0]===0&&jf[1]===0&&jf[2]===0||this._sunLightAni===null){vec3.copy(jf,i);vec3.copy(T,jl)}var jo=vec3.copy(vec3.create(),jf);var jg=vec3.create();vec3.normalize(jg,jh.getLightPositionForAt());var jn=[jg[0]-jo[0],jg[1]-jo[1],jg[2]-jo[2]];var je=vec3.copy(vec3.create(),T);var jk=vec3.create();vec3.normalize(jk,jh.getLightPosition());var jm=[jk[0]-je[0],jk[1]-je[1],jk[2]-je[2]];var jj=this;this._sunLightAni=new e3({duration:800,transition:fY.easeOutCubic,render:function(js,jr){if(js===0){return}var jq=jj._lightForAni;var jp=jj._lightForAniGround;jq[0]=jo[0]+js*jn[0];jq[1]=jo[1]+js*jn[1];jq[2]=jo[2]+js*jn[2];jp[0]=je[0]+js*jm[0];jp[1]=je[1]+js*jm[1];jp[2]=je[2]+js*jm[2];jj._setAtUniforms(jq,jp);jj._earth.fire(new fa("onrefresh"))},finish:function(){jj._earth.fire(new fa("onanimation_end"));jj._sunLightAni=null},onStop:function(jp){jj._earth.fire(new fa("onanimation_end"));jj._sunLightAni=null}})},_setAtUniforms:function(T,i){var jf=this._camera;var ji=this._uniformsCommon;ji.projectionMatrix.value=jf.getProjectionMatrix();ji.modelViewMatrix.value=jf.getModelViewMatrixForAt();var jh=jf.getPositionForAt();var jg=jf.getPosition();ji.cameraPosition.value=jh;var e=vec3.len(jh);ji.fCameraHeight.value=e;ji.fCameraHeight2.value=e*e;ji.v3LightPosition.value=T;ji.v3LightDirection.value=T;var je=this._atUniformsGround;je.cameraPositionGround.value=jg;e=vec3.len(jg);je.fCameraHeightGround.value=e;je.fCameraHeight2Ground.value=e*e;je.v3LightPositionGround.value=i},renderFrame:function(){if(!this._initialized||this._earth.getZoom()>=6){return}var e=this._earth.getBounds();if(e.holeAtTopLeft===false){return}var T=this._gl;T.useProgram(this._glProgram);var i=this._webglState;i.enableCap("depthTest");i.depthMask(false);i.enableCap("cullFace");i.frontFace(T.CCW);i.cullFace(T.FRONT);i.blendFunc(T.SRC_ALPHA,T.ONE);i.initAttribute();i.enableAttribute(this._glProgram.vertexPositionAttribute);i.disableUnusedAttributes();this._setUniforms();this._renderSphere()},_setUniforms:function(){var je=this._glProgram;var T=this._gl;var i=this._uniformsCommon;for(var e in i){bN(T,je,e,i[e].value,i[e].type)}i=this._uniforms;for(var e in i){bN(T,je,e,i[e].value,i[e].type)}},_renderSphere:function(){var je=this._ringData;var i=je.vertex;var e=je.indice;var T=this._gl;this._float32Array.set(i);T.bindBuffer(T.ARRAY_BUFFER,this._trianglesVerticeBuffer);T.bufferData(T.ARRAY_BUFFER,this._float32Array,T.STREAM_DRAW);if(this._triangleVerticesIndexBuffer.vertexCount!=e.length){T.bindBuffer(T.ELEMENT_ARRAY_BUFFER,this._triangleVerticesIndexBuffer);this._uint16Array.set(e);T.bufferData(T.ELEMENT_ARRAY_BUFFER,this._uint16Array,T.STREAM_DRAW);this._triangleVerticesIndexBuffer.vertexCount=e.length}var jf=this._glProgram;T.bindBuffer(T.ARRAY_BUFFER,this._trianglesVerticeBuffer);T.bindBuffer(T.ELEMENT_ARRAY_BUFFER,this._triangleVerticesIndexBuffer);T.vertexAttribPointer(jf.vertexPositionAttribute,3,T.FLOAT,false,0,0);T.drawElements(T.TRIANGLES,this._triangleVerticesIndexBuffer.vertexCount,T.UNSIGNED_SHORT,0)}});function d0(T,e){this._earth=T;this._layer=e;this._canvas=T._canvas;var i=this._ratio=this._earth.scene._ratio;this._width=this._canvas.width/i;this._height=this._canvas.height/i;var je=this._gl=T.scene._gl;this._webglState=dt.WebGLState.get(je,T._guid);this._textTextureManager=new dt.TextTextureManager(je,{width:e._textTextureImgWidth,height:e._textTextureImgHeight,name:"earth-text"});this._currentRenderTexture=null;this._glProgram=null;this._sphere=T._sphere;this._pMatrix=mat4.create();this._mvMatrix=mat4.create();this._mvMatrixCamera=mat4.create();this._trianglesVerticeBuffer=je.createBuffer();this._iconTextureManager=new dt.TextTextureManager(je,{width:1024,height:1024,name:"earth-icon"});this._iconTextureAtlas=this._iconTextureManager.getEmptyTexture();this._iconTextureAtlasOffset={};this._iconTextureAtlasCoords={};this.zIndex=15;this._textureInfoPool=new hn(350);this._enabled=true;this._collisionRet=[];this._loadedCount=0;this._refreshTimer=null;this._float32Array=new Float32Array(2000);this.curSpotAdded=false;this._init()}d0.VS_SHADER_TEXT=["precision highp float;","attribute vec3 aVertexPosition;","attribute vec2 aVertexTextureCoord;","varying vec2 vTextureCoord;","uniform mat4 uMVMatrix;","uniform mat4 uPMatrix;","void main(void) {","    gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);","    vTextureCoord = aVertexTextureCoord;","}"].join("\\n");d0.FS_SHADER_TEXT=["precision highp float;","uniform sampler2D uSampler;","varying vec2 vTextureCoord;","void main(void) {","    gl_FragColor = texture2D(uSampler, vTextureCoord);","}"].join("\\n");ev.extend(d0.prototype,{_init:function(){this._initShaders();this._getAllUniforms();this._getAttribLocation();mat4.translate(this._mvMatrix,this._mvMatrix,[-this._width/2,-this._height/2,0]);mat4.ortho(this._pMatrix,-this._width/2,this._width/2,-this._height/2,this._height/2,800,-800);var e=this;this._currentRenderTexture=e._textTextureManager.getEmptyTexture();var i=this._earth.getMap();var e=this;i.on("maptypechange",function(T){if(T.mapType===BMAP_EARTH_MAP){e._isMapTypeChange=true;e._arrCurViewTileModels=null;e._collisionRet=[];e._earth.fire(new fa("onrefresh"))}});i.on("streetlayer_show",function(T){if(this.mapType===BMAP_EARTH_MAP){if(!e._camera){return}e._isStreetLayerChange=true;e._arrCurViewTileModels=null;e._collisionRet=[];e.onStatusChange(e._camera);e._earth.fire(new fa("onrefresh"))}});i.on("mousemove",function(){if(this.mapType!==BMAP_EARTH_MAP){return}if(e.curSpotAdded){return}if(this.currentOperation!==dL.idle){return}e._refreshSpotData();this.temp.isPermitSpotOver=true;e.curSpotAdded=true})},_refreshSpotData:function(){this._spotData=[];var T=this._collisionRet||[];for(var jg=0;jg<T.length;jg++){if(!T[jg].icTxtInfo||!T[jg].icTxtInfo.fixedLabel){continue}var je=T[jg].icTxtInfo.fixedLabel;for(var jf=0;jf<je.length;jf++){if(!this.isClickableLabel(je[jf])){continue}this._spotData.push(this._getSpotDataFromLabel(je[jf]))}}var ji=new fa("onspotsdataready");ji.spots=this._spotData;var jh=this._earth.getMap();jh._spotDataOnCanvas=this._spotData;jh.dispatchEvent(ji)},isClickableLabel:function(e){if(e.isDel||(!e.guid&&!e.name)){return false}return true},_getSpotDataFromLabel:function(i){var jf=this._earth.getMap();var T=null;if(i.iconPos){T=new cf(i.pt.lng,i.pt.lat)}var e=i.name?i.name.replace("\\\\","<br>"):"";if(i.iconPos&&i.iconPos.iconType.indexOf("ditie")>-1&&jf.getZoom()>14){e=""}var je={n:e,px:i.scrPt,bd:i.bds,pt:T,userdata:{iconPoint:T,uid:i.guid,name:e,mapPoi:true,type:i.iconPos?i.iconPos.iconType:"",tilePosStr:i.tilePosStr},tag:"MAP_SPOT_INFO"};return je},_initShaders:function(){var i=d0.VS_SHADER_TEXT;var jf=d0.FS_SHADER_TEXT;var je=this._gl;var jg=this._glProgram=je.createProgram();var T=this._makeShader(i,je.VERTEX_SHADER);var e=this._makeShader(jf,je.FRAGMENT_SHADER);je.attachShader(jg,T);je.attachShader(jg,e);je.linkProgram(jg);je.useProgram(jg)},_makeShader:function(je,e){var T=this._gl;var i=T.createShader(e);T.shaderSource(i,je);T.compileShader(i);return i},_getAllUniforms:function(){var i=this._glProgram;var e=this._gl;i.pMatrixUniform=e.getUniformLocation(i,"uPMatrix");i.mvMatrixUniform=e.getUniformLocation(i,"uMVMatrix");i.sampler=e.getUniformLocation(i,"uSampler")},_setUniforms:function(){var i=this._glProgram;var e=this._gl;e.uniformMatrix4fv(i.pMatrixUniform,false,this._pMatrix);e.uniformMatrix4fv(i.mvMatrixUniform,false,this._mvMatrix)},_setPerpectiveUniforms:function(){var i=this._glProgram;var e=this._gl;e.uniformMatrix4fv(i.pMatrixUniform,false,this._pMatrix2);if(this._earth.getZoom()>15){e.uniformMatrix4fv(i.mvMatrixUniform,false,this._mvMatrixCamera)}else{e.uniformMatrix4fv(i.mvMatrixUniform,false,this._mvMatrix2)}},_getAttribLocation:function(){var i=this._glProgram;var e=this._gl;i.vertexPositionAttribute=e.getAttribLocation(i,"aVertexPosition");i.vertexTexCoordAttribute=e.getAttribLocation(i,"aVertexTextureCoord")},resize:function(){this._width=this._canvas.width/this._ratio;this._height=this._canvas.height/this._ratio;mat4.identity(this._mvMatrix);mat4.translate(this._mvMatrix,this._mvMatrix,[-this._width/2,-this._height/2,0]);mat4.ortho(this._pMatrix,-this._width/2,this._width/2,-this._height/2,this._height/2,800,-800);this._layer._lineLabelMagRatio=700*0.5/this._height},enable:function(){this._enabled=true},disable:function(){this._enabled=false},setTextureInfoRes:function(e,T){this._loadedCount--;this.curSpotAdded=false;this._textureInfoPool.setData(e,T);if(this._loadedCount===0){this._updateLabelData();this._earth.fire(new fa("onrefresh"));if(this._refreshTimer){clearTimeout(this._refreshTimer)}}else{if(this._refreshTimer===null){var i=this;this._refreshTimer=setTimeout(function(){i._updateLabelData();i._earth.fire(new fa("onrefresh"));i._refreshTimer=null},200)}}},addTextTexture:function(e,i){if(this._arrCurViewTileModels&&this._arrCurViewTileModels.textureInfo){return this._arrCurViewTileModels.textureInfo.addTexture(e,i)}return this._currentRenderTexture.addTexture(e,i)},onStatusChange:function(T){if(!this._enabled){return}this._camera=T;this._pMatrix2=T.getProjectionMatrix();this._mvMatrix2=T.getModelViewMatrix();this._mvMatrixCamera=T._mvMatrixForCamera;var i=this._earth.getZoom();this._isZoomOut=!!(i-this._lastZoom<0);this._isZoomLarge=!!(Math.abs(i-this._lastZoom)>2);this._lastZoom=i;if(i>=this._earth.zoomForNight+1){var je=this;var e=je._layer;if(je.loadTimer){clearTimeout(je.loadTimer)}je.loadTimer=setTimeout(function(){if(je._earth.getZoom()<je._earth.zoomForNight+1){return}je._arrCurViewTileModels=je._sphere.getCurViewNormalModels(je._layer._tileType);if(je._textureInfoPool.getDataCount()>180||je._currentRenderTexture.getUsage()>0.8){je._arrCurViewTileModels.textureInfo=je._textTextureManager.getEmptyTexture();je._textureInfoPool.clear()}je._loadCurViewData();je.loadTimer=null},240)}else{this._arrCurViewTileModels=null;this._collisionRet=[]}this._updateScreenPixel();if(!this._locked&&this._isZoomOut){if(this._collisionRet&&this._collisionRet._arrLabels){this._layer.collisionTestByZoomingOut(this._collisionRet._arrLabels,this._height)}this._isZoomOut=false}},_updateScreenPixel:function(){if(!this._collisionRet){return}var jg=false;var jk=this._earth;if(jk.getZoom()<=6){jg=true}var jf=jk.getCenter();for(var je=0;je<this._collisionRet.length;je++){var e=this._collisionRet[je];var jh=e.icTxtInfo.fixedLabel;for(var T=0;T<jh.length;T++){var ji=jh[T];if(jk.getZoom()>15){var jj=jk.scene.fromLatLngToXYZ(ji.latLng);jj=aj(jj,jk.rotationInfo);ji.scrPt=jk.scene.fromXYZToPixel(jj[0],jj[1],jj[2],{matrixInfo:{modelViewMatrix:jk.scene._camera._mvMatrixForCamera}})}else{ji.scrPt=jk.fromLatLngToPixel(ji.latLng,{isCalcOnBack:jg})}}}},getStatusChangeEvent:function(){return this._statusChangeEvt},_loadCurViewData:function(){var jk=this;var ji=jk._layer;var jl=this._arrCurViewTileModels;if(this._earth._notLoadHigh||!jl){return}for(var jh=0,jg=jl.length;jh<jg;jh++){var je=jl[jh];var jf=je.col;var jn=je.row;var jj=je.imgZoom;var T=je.useZoom;var jm=je.key;if(this._textureInfoPool.getData(jm)){continue}this._loadedCount++;this._textureInfoPool.setData(jm,{});ji.loadTileData(jf,jn,jj,T,jm)}var e=this._earth.getMap();e.temp.isPermitSpotOver=false;this.curSpotAdded=false;if(this._loadedCount===0){this._updateLabelData();this._earth.fire(new fa("onrefresh"));return}this._waitTimer&&clearTimeout(this._waitTimer);this._waitTimer=setTimeout(function(){if(jk._loadedCount>0){jk._updateLabelData();jk._earth.fire(new fa("onrefresh"))}jk._waitTimer=setTimeout(function(){if(jk._loadedCount>0){jk._updateLabelData();jk._earth.fire(new fa("onrefresh"))}jk._waitTimer=null},3000)},400)},renderFrame:function(){var T=this._earth._map;if(!T._displayOptions.poi){return}var jk=this._arrCurViewTileModels;if(!this._enabled||!jk||jk.length===0){return}var e=this._earth.getZoom();if(e<this._earth.zoomForNight+1){return}var je=jk[0].imgZoom;var jl=this._earth;var jf=jl.getImageZoom();if(!this._locked&&je-jf>=3){this._collisionRet=[];return}var jh=this._gl;var jg=this._glProgram;var i=this._webglState;var ji=this._layer;jh.useProgram(jg);i.disableCap("depthTest");i.enableCap("blend");i.enableCap("cullFace");i.cullFace(jh.BACK);i.initAttribute();i.enableAttribute(jg.vertexPositionAttribute);i.enableAttribute(jg.vertexTexCoordAttribute);i.disableUnusedAttributes();var jj=this._renderLineLabelFrame(jh,jg,this._collisionRet,false);this._renderFixedLabelFrame(jh,jg,this._collisionRet,false,jj);var jl=this._earth;if(!jl._firstLabelLoadedTime&&this._collisionRet.length>0){var jm=new fa("onearthlabelloaded");jm.initTime=jl._initFinishTime-jl._initStartTime;jm.loadTime=jl._firstLabelLoadedTime=Date.now()-jl._initStartTime;jl.fire(jm)}},_updateLabelData:function(){this._collisionRet=this._layer.collisionTest(this._arrCurViewTileModels,this._textureInfoPool,this._height);if(this._arrCurViewTileModels&&this._arrCurViewTileModels.textureInfo){if(this._currentRenderTexture){this._textTextureManager.free(this._currentRenderTexture)}this._currentRenderTexture=this._arrCurViewTileModels.textureInfo;this._arrCurViewTileModels.textureInfo=null}},_renderFixedLabelFrame:function(jo,ji,e,T,jr){var jq=this._iconTextureAtlas.getTexture();var jp=this._layer;var js=this._float32Array;var jn=[];var jh=[];for(var jm=0,jg=e.length;jm<jg;jm++){var jk=e[jm];if(!jk){continue}var jf=jp.mergeFixedLabelInfo(jk,this._width,this._height,this._isAnimationEnd,T);var je=jf.iconVertex;var jl=jf.textVertex;if(jq&&je.length>0){jn=jn.concat(je)}if(jl.length>0){jh=jh.concat(jl)}}if(jh.length===0&&jn.length===0){return}this._setUniforms();if(this._currentRenderTexture&&jh.length>0){jo.bindBuffer(jo.ARRAY_BUFFER,this._trianglesVerticeBuffer);if(jh.length<js.length){js.set(jh,0)}else{js=new Float32Array(jh)}jo.bufferData(jo.ARRAY_BUFFER,js,jo.STREAM_DRAW);jo.vertexAttribPointer(ji.vertexPositionAttribute,3,jo.FLOAT,false,20,0);jo.vertexAttribPointer(ji.vertexTexCoordAttribute,2,jo.FLOAT,false,20,12);if(!jr){var jj=this._currentRenderTexture.getTexture();this._webglState.activeTexture(jo.TEXTURE0);jo.bindTexture(jo.TEXTURE_2D,jj);jo.uniform1i(ji.sampler,0)}jo.drawArrays(jo.TRIANGLES,0,jh.length/5)}if(jn.length===0){return}this._webglState.activeTexture(jo.TEXTURE0);jo.bindTexture(jo.TEXTURE_2D,jq);jo.uniform1i(ji.sampler,0);jo.bindBuffer(jo.ARRAY_BUFFER,this._trianglesVerticeBuffer);if(jn.length<js.length){js.set(jn,0)}else{js=new Float32Array(jn)}jo.bufferData(jo.ARRAY_BUFFER,js,jo.STREAM_DRAW);jo.vertexAttribPointer(ji.vertexPositionAttribute,3,jo.FLOAT,false,20,0);jo.vertexAttribPointer(ji.vertexTexCoordAttribute,2,jo.FLOAT,false,20,12);jo.drawArrays(jo.TRIANGLES,0,jn.length/5)},_renderLineLabelFrame:function(jl,jg,e,T){if(!this._currentRenderTexture||e.length===0){return false}var jm=this._layer;var jn=this._float32Array;var je=[];for(var jk=0,jf=e.length;jk<jf;jk++){var ji=e[jk];var jj=jm.mergeLineLabelInfo(ji,T);if(jj.length>0){je=je.concat(jj)}}if(je.length===0){return false}this._setPerpectiveUniforms();jl.bindBuffer(jl.ARRAY_BUFFER,this._trianglesVerticeBuffer);if(je.length<jn.length){jn.set(je,0)}else{jn=new Float32Array(je)}jl.bufferData(jl.ARRAY_BUFFER,jn,jl.STATIC_DRAW);jl.vertexAttribPointer(jg.vertexPositionAttribute,3,jl.FLOAT,false,20,0);jl.vertexAttribPointer(jg.vertexTexCoordAttribute,2,jl.FLOAT,false,20,12);var jh=this._currentRenderTexture.getTexture();jl.bindTexture(jl.TEXTURE_2D,jh);jl.uniform1i(jg.sampler,0);jl.drawArrays(jl.TRIANGLES,0,je.length/5);return true}});function dU(e){this._earth=e;this._radius=6*e.radius;this._canvas=e._canvas;var i=this._gl=e.scene._gl;this._webglState=dt.WebGLState.get(i,e._guid);this._glProgram=null;this._cols=2;this._rows=1;this._mvMatrix=mat4.create();this._mMatrixMilky=mat4.create();this._mMatrixSun=mat4.create();this._pMatrix=mat4.create();this._sunTexture={};this._float32Array=new Float32Array(243);this._uint16Array=new Uint16Array(384);this.zIndex=1;this._textureTransform={rotateX:300.611,rotateY:328.127};this.init()}dU.VS_SHADER_TEXT=["precision mediump float;","attribute vec3 aVertexPosition;","attribute vec2 aVertexTextureCoord;","varying vec2 vTextureCoord;","uniform mat4 uMVMatrix;","uniform mat4 uMMatrix;","uniform mat4 uPMatrix;","void main(void) {","    gl_Position = uPMatrix * uMVMatrix * uMMatrix * vec4(aVertexPosition, 1.0);","    vTextureCoord = aVertexTextureCoord;","}"].join("\\n");dU.FS_SHADER_TEXT=["precision mediump float;","varying vec2 vTextureCoord;","uniform sampler2D uSampler;","uniform float uAlpha;","uniform bool uRenderSun;","void main(void) {","    if (uRenderSun == true) {","        vec4 diffuse = texture2D(uSampler, vTextureCoord);","        float grayValue = (diffuse.r + diffuse.g + diffuse.b) / 3.0;","        float sunAlpha = 1.0;","        if (grayValue < 0.15) {","            sunAlpha = 0.0;","        } else {","            sunAlpha = grayValue + 0.14;","        }","        gl_FragColor = vec4(diffuse.rgb, sunAlpha) * uAlpha;","        return;","    }","    gl_FragColor = texture2D(uSampler, vTextureCoord) * uAlpha;","}"].join("\\n");ev.extend(dU.prototype,{init:function(){this._genImgColsRowsInfo();this._initShaders();this._getUniforms();this._getAttribLocation();var e=new aU(this._radius,this._cols,this._rows);var i=e.initSphereFacesIndices();this._sphere={sphere:e,facesVertexIndice:i,facesVertex:e._facesVertex};this._vertexForSun=[-400,-400,2800,400,-400,2800,400,400,2800,-400,400,2800];this._indiceForSun=[0,3,2,0,2,1];this._coordsForSun=[0,0,0,1,1,1,1,0];var T=this;this._earth.on("preload",function(){T._prepareTexture()});this._earth.on("idle",function(){T._prepareTexture()});this._earth.on("onsunlighttime_change",function(){T._sunLightPos=null});this._earth.on("onsunlighttime_clear",function(){T._sunLightPos=null});this._initialized=true},_genImgColsRowsInfo:function(){this._imgColsRows=[];for(var e=2;e<=5;e++){this._imgColsRows[e]={cols:Math.pow(2,e-1),rows:Math.pow(2,e-1)/2}}this._imgColsRows[1]={cols:1,rows:1}},_initShaders:function(){var e=dU.VS_SHADER_TEXT;var T=dU.FS_SHADER_TEXT;var jf=this._gl;var jg=this._glProgram=jf.createProgram();var je=this._makeShader(e,jf.VERTEX_SHADER);var i=this._makeShader(T,jf.FRAGMENT_SHADER);jf.attachShader(jg,je);jf.attachShader(jg,i);jf.bindAttribLocation(jg,0,"aVertexPosition");jf.linkProgram(jg);jf.useProgram(jg)},_makeShader:function(je,e){var T=this._gl;var i=T.createShader(e);T.shaderSource(i,je);T.compileShader(i);return i},_getUniforms:function(){var i=this._glProgram;var e=this._gl;i.pMatrixUniform=e.getUniformLocation(i,"uPMatrix");i.mvMatrixUniform=e.getUniformLocation(i,"uMVMatrix");i.mMatrixUniform=e.getUniformLocation(i,"uMMatrix");i.samplerUniform=e.getUniformLocation(i,"uSampler");i.alpha=e.getUniformLocation(i,"uAlpha");i.renderSun=e.getUniformLocation(i,"uRenderSun")},_getAttribLocation:function(){var e=this._gl;var i=this._glProgram;i.vertexPositionAttribute=e.getAttribLocation(i,"aVertexPosition");i.vertexTexCoordAttribute=e.getAttribLocation(i,"aVertexTextureCoord")},_setUniforms:function(){var i=this._glProgram;var e=this._gl;e.uniformMatrix4fv(i.pMatrixUniform,false,this._pMatrix);e.uniformMatrix4fv(i.mvMatrixUniform,false,this._mvMatrix)},onStatusChange:function(i){if(this._earth.getZoom()>=2){return}if(!this._initialized){return}this._camera=i;this._pMatrix=i.getProjectionMatrix();this._mvMatrix=i.getModelViewMatrix();this._calculateCelestialSpherePos();var e=this._getColAndRow();this._faceRange=e[0];this._imgRange=e[1]},_calculateCelestialSpherePos:function(){var jf=this._camera;var jh=this._textureTransform.rotateX;var jg=this._textureTransform.rotateY;var jk=jf.getSunZenith();var jl=jf.getPosition();var e=jf._date;var je=e.getFullYear();var i=Math.floor(je%100*0.2422+20.646)-Math.floor(je%100/4);var jj=new Date(je,2,i);var ji=e-jj;var T=Math.floor(ji/1000/60/60/24)/365.25*360;mat4.identity(this._mMatrixMilky);mat4.translate(this._mMatrixMilky,this._mMatrixMilky,jl);mat4.rotate(this._mMatrixMilky,this._mMatrixMilky,hM(195+jk.lng-T),[0,1,0]);mat4.rotate(this._mMatrixMilky,this._mMatrixMilky,hM(jh),[1,0,0]);mat4.rotate(this._mMatrixMilky,this._mMatrixMilky,hM(jg),[0,1,0])},renderFrame:function(){if(this._earth.getZoom()>=2){return}if(!this._initialized){return}var ju=this._gl;var jk=this._glProgram;ju.useProgram(jk);var jg=this._webglState;jg.initAttribute();jg.enableAttribute(jk.vertexPositionAttribute);jg.enableAttribute(jk.vertexTexCoordAttribute);jg.disableUnusedAttributes();var jr=this._faceRange;if(!this._faceRange){return}var jm=this._rows;var jo=this._cols;var js=jr[0];var jq=jr[1];var jv=jr[2];var jt=jr[3];var jp=this._texturesInfo;if(!jp||!jp.done){return false}jg.enableCap("cullFace");jg.cullFace(ju.BACK);jg.disableCap("depthTest");jg.depthMask(true);this._justBindTexture(jp.texture);this._setUniforms();ju.uniform1f(jk.alpha,(1-(this._earth.getZoom()-1))*0.6);ju.uniform1i(jk.renderSun,false);ju.uniformMatrix4fv(jk.mMatrixUniform,false,this._mMatrixMilky);for(var ji=jv;ji<=jt;ji++){var T=js;var jf=jq;if(typeof this._vertexFromRow==="number"&&ji>=this._vertexFromRow&&ji<=this._vertexToRow){T=0;jf=this._cols-1}for(var jh=T;jh<=jf;jh++){var jj=jh;while(jj<0){jj+=this._cols}jj=jj%this._cols;var jw=this._getVertex(jj,ji);var jn=this._sphere.facesVertexIndice;var e=this._getTextureCoord(jj,ji,1);this._setupBuffers(jw,jn,e);this._draw()}}if(!this._sunTexture.done){return}this._justBindTexture(this._sunTexture.texture);this._setupBuffers(this._vertexForSun,this._indiceForSun,this._coordsForSun);if(!this._sunLightPos){this._sunLightPos=vec3.normalize(vec3.create(),this._camera.getLightPosition());var jl=Math.sqrt(1-this._sunLightPos[1]*this._sunLightPos[1]);var jx=this._sunLightPos[2]/jl;jx=jx>1?1:jx;jx=jx<-1?-1:jx;var je=Math.acos(jx);if(this._sunLightPos[0]<0){je=hM(360)-je}var jy=Math.asin(this._sunLightPos[1]);mat4.identity(this._mMatrixSun);mat4.rotate(this._mMatrixSun,this._mMatrixSun,je,[0,1,0]);mat4.rotate(this._mMatrixSun,this._mMatrixSun,jy,[-1,0,0])}var i=this._earth;if(i._firstAni){ju.uniform1f(jk.alpha,1)}else{ju.uniform1f(jk.alpha,(1-(i.getZoom()-1)))}ju.uniform1i(jk.renderSun,true);ju.uniformMatrix4fv(jk.mMatrixUniform,false,this._mMatrixSun);this._draw()},_prepareTexture:function(){var i=this;if(!i._texturesInfo){i._texturesInfo={}}else{return}var e=i._texturesInfo;e.loaded=false;var T=w.imgPath+"tiles/the-milkyway-2k.jpg?20150826";i._loadImage(T,function(je){e.loaded=true;if(!e.done){i._setupTexture(e,je);e.done=true}i._earth.fire(new fa("onrefresh"))});i._sunTexture.loaded=false;if(i._earth._showRealSunlight){i._loadImage(w.imgPath+"sun.jpg?20150826",function(je){i._sunTexture.loaded=true;if(!i._sunTexture.done){i._setupTexture(i._sunTexture,je);i._sunTexture.done=true}i._earth.fire(new fa("onrefresh"))})}},_loadImage:function(i,T){var e=new Image();e.crossOrigin="anonymous";e._loaded=false;e.onload=function(){T(this);this._loaded=true};e.src=i},_setupTexture:function(i,e){if(!i){return}var je=this._gl;this._webglState.activeTexture(je.TEXTURE0);i.texture=je.createTexture();var T=i.texture;je.bindTexture(je.TEXTURE_2D,T);je.pixelStorei(je.UNPACK_FLIP_Y_WEBGL,true);je.texImage2D(je.TEXTURE_2D,0,je.RGBA,je.RGBA,je.UNSIGNED_BYTE,e);je.texParameteri(je.TEXTURE_2D,je.TEXTURE_WRAP_S,je.CLAMP_TO_EDGE);je.texParameteri(je.TEXTURE_2D,je.TEXTURE_WRAP_T,je.CLAMP_TO_EDGE);je.texParameteri(je.TEXTURE_2D,je.TEXTURE_MAG_FILTER,je.LINEAR);je.texParameteri(je.TEXTURE_2D,je.TEXTURE_MIN_FILTER,je.LINEAR)},_justBindTexture:function(e){if(!e){return}var i=this._gl;var T=this._glProgram;this._webglState.activeTexture(i.TEXTURE0);i.bindTexture(i.TEXTURE_2D,e);i.uniform1i(T.samplerUniform,0)},_setupBuffers:function(T,e,i){var je=this._gl;if(!this._trianglesVerticeBuffer){this._trianglesVerticeBuffer=je.createBuffer()}je.bindBuffer(je.ARRAY_BUFFER,this._trianglesVerticeBuffer);this._float32Array.set(T);je.bufferData(je.ARRAY_BUFFER,this._float32Array,je.STREAM_DRAW);if(!this._triangleVerticesIndexBuffer){this._triangleVerticesIndexBuffer=je.createBuffer();this._triangleVerticesIndexBuffer.vertexCount=e.length;je.bindBuffer(je.ELEMENT_ARRAY_BUFFER,this._triangleVerticesIndexBuffer);this._uint16Array.set(e);je.bufferData(je.ELEMENT_ARRAY_BUFFER,this._uint16Array,je.STREAM_DRAW)}if(this._triangleVerticesIndexBuffer.vertexCount!==e.length){this._triangleVerticesIndexBuffer.vertexCount=e.length;je.bindBuffer(je.ELEMENT_ARRAY_BUFFER,this._triangleVerticesIndexBuffer);this._uint16Array.set(e);je.bufferData(je.ELEMENT_ARRAY_BUFFER,this._uint16Array,je.STREAM_DRAW)}if(!this._vertexTexCoordBuffer){this._vertexTexCoordBuffer=je.createBuffer()}je.bindBuffer(je.ARRAY_BUFFER,this._vertexTexCoordBuffer);this._float32Array.set(i);je.bufferData(je.ARRAY_BUFFER,this._float32Array,je.STREAM_DRAW)},_getVertex:function(T,je){var e=aU.H_SEGS/this._cols;var jf=aU.H_SEGS/e;var i=T+je*jf;return this._sphere.facesVertex[i]},_getTextureCoord:function(e,i){return this._sphere.sphere.generateTextureCoord(1,e,i)},_draw:function(){var e=this._gl;var i=this._glProgram;e.bindBuffer(e.ARRAY_BUFFER,this._trianglesVerticeBuffer);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._triangleVerticesIndexBuffer);e.vertexAttribPointer(i.vertexPositionAttribute,3,e.FLOAT,false,0,0);e.bindBuffer(e.ARRAY_BUFFER,this._vertexTexCoordBuffer);e.vertexAttribPointer(i.vertexTexCoordAttribute,2,e.FLOAT,false,0,0);e.drawElements(e.TRIANGLES,this._triangleVerticesIndexBuffer.vertexCount,e.UNSIGNED_SHORT,0)},_getColAndRow:function(){var je;var jh;var jg;var T;var ji;var e;var jf;var i;je=0;jh=this._cols-1;jg=0;T=this._rows-1;ji=0;e=0;jf=0;i=0;return[[je,jh,jg,T],[ji,e,jf,i]]}});function a8(e){this._earth=e;this._radius=6*e.radius;this._canvas=e._canvas;var i=this._gl=e.scene._gl;this._webglState=dt.WebGLState.get(i,e._guid);this._glProgram=null;this._cols=2;this._rows=1;this._mvMatrix=mat4.create();this._mMatrixMilky=mat4.create();this._mMatrixSun=mat4.create();this._pMatrix=mat4.create();this._sunTexture={};this._float32Array=new Float32Array(243);this._uint16Array=new Uint16Array(384);this.zIndex=1;this._textureTransform={rotateX:300.611,rotateY:328.127};this.init()}a8.VS_SHADER_TEXT=["precision mediump float;","attribute vec3 aVertexPosition;","attribute vec2 aVertexTextureCoord;","varying vec2 vTextureCoord;","uniform mat4 uMVMatrix;","uniform mat4 uMMatrix;","uniform mat4 uPMatrix;","void main(void) {","    gl_Position = uPMatrix * uMVMatrix * uMMatrix * vec4(aVertexPosition, 1.0);","    vTextureCoord = aVertexTextureCoord;","}"].join("\\n");a8.FS_SHADER_TEXT=["precision mediump float;","varying vec2 vTextureCoord;","uniform sampler2D uSampler;","uniform float uAlpha;","void main(void) {","    gl_FragColor = texture2D(uSampler, vTextureCoord) * uAlpha;","}"].join("\\n");ev.extend(a8.prototype,{init:function(){this._genImgColsRowsInfo();this._initShaders();this._getUniforms();this._getAttribLocation();var e=new aU(this._radius,this._cols,this._rows);var i=e.initSphereFacesIndices();this._sphere={sphere:e,facesVertexIndice:i,facesVertex:e._facesVertex};var T=this;this._earth.on("preload",function(){T._prepareTexture()});this._earth.on("idle",function(){T._prepareTexture()});this._initialized=true},_genImgColsRowsInfo:function(){this._imgColsRows=[];for(var e=2;e<=5;e++){this._imgColsRows[e]={cols:Math.pow(2,e-1),rows:Math.pow(2,e-1)/2}}this._imgColsRows[1]={cols:1,rows:1}},_initShaders:function(){var e=a8.VS_SHADER_TEXT;var T=a8.FS_SHADER_TEXT;var jf=this._gl;var jg=this._glProgram=jf.createProgram();var je=this._makeShader(e,jf.VERTEX_SHADER);var i=this._makeShader(T,jf.FRAGMENT_SHADER);jf.attachShader(jg,je);jf.attachShader(jg,i);jf.bindAttribLocation(jg,0,"aVertexPosition");jf.linkProgram(jg);jf.useProgram(jg)},_makeShader:function(je,e){var T=this._gl;var i=T.createShader(e);T.shaderSource(i,je);T.compileShader(i);return i},_getUniforms:function(){var i=this._glProgram;var e=this._gl;i.pMatrixUniform=e.getUniformLocation(i,"uPMatrix");i.mvMatrixUniform=e.getUniformLocation(i,"uMVMatrix");i.mMatrixUniform=e.getUniformLocation(i,"uMMatrix");i.samplerUniform=e.getUniformLocation(i,"uSampler");i.alpha=e.getUniformLocation(i,"uAlpha")},_getAttribLocation:function(){var e=this._gl;var i=this._glProgram;i.vertexPositionAttribute=e.getAttribLocation(i,"aVertexPosition");i.vertexTexCoordAttribute=e.getAttribLocation(i,"aVertexTextureCoord")},_setUniforms:function(){var i=this._glProgram;var e=this._gl;e.uniformMatrix4fv(i.pMatrixUniform,false,this._pMatrix);e.uniformMatrix4fv(i.mvMatrixUniform,false,this._mvMatrix)},onStatusChange:function(i){if(this._earth.getZoom()>=6){return}if(!this._initialized){return}this._camera=i;this._pMatrix=i.getProjectionMatrix();this._mvMatrix=i.getModelViewMatrix();this._calculateCelestialSpherePos();var e=this._getColAndRow();this._faceRange=e[0];this._imgRange=e[1]},_calculateCelestialSpherePos:function(){var jf=this._camera;var jh=this._textureTransform.rotateX;var jg=this._textureTransform.rotateY;var jk=jf.getSunZenith();var jl=jf.getPosition();var e=jf._date;var je=e.getFullYear();var i=Math.floor(je%100*0.2422+20.646)-Math.floor(je%100/4);var jj=new Date(je,2,i);var ji=e-jj;var T=Math.floor(ji/1000/60/60/24)/365.25*360;mat4.identity(this._mMatrixMilky);mat4.translate(this._mMatrixMilky,this._mMatrixMilky,jl);mat4.rotate(this._mMatrixMilky,this._mMatrixMilky,hM(195+jk.lng-T),[0,1,0]);mat4.rotate(this._mMatrixMilky,this._mMatrixMilky,hM(jh),[1,0,0]);mat4.rotate(this._mMatrixMilky,this._mMatrixMilky,hM(jg),[0,1,0])},renderFrame:function(){if(this._earth.getZoom()>=5){return}if(!this._initialized){return}var jq=this._gl;var jf=this._glProgram;jq.useProgram(jf);var i=this._webglState;i.initAttribute();i.enableAttribute(jf.vertexPositionAttribute);i.enableAttribute(jf.vertexTexCoordAttribute);i.disableUnusedAttributes();var jn=this._faceRange;if(!this._faceRange){return}var jg=this._rows;var ji=this._cols;var jo=jn[0];var jm=jn[1];var js=jn[2];var jp=jn[3];var jk=this._texturesInfo;if(!jk||!jk.done){return false}i.enableCap("cullFace");i.cullFace(jq.BACK);i.disableCap("depthTest");i.depthMask(true);this._justBindTexture(jk.texture);this._setUniforms();jq.uniform1f(jf.alpha,1);jq.uniform1i(jf.renderSun,false);jq.uniformMatrix4fv(jf.mMatrixUniform,false,this._mMatrixMilky);for(var je=js;je<=jp;je++){var jl=jo;var jr=jm;if(typeof this._vertexFromRow==="number"&&je>=this._vertexFromRow&&je<=this._vertexToRow){jl=0;jr=this._cols-1}for(var T=jl;T<=jr;T++){var jj=T;while(jj<0){jj+=this._cols}jj=jj%this._cols;var jt=this._getVertex(jj,je);var jh=this._sphere.facesVertexIndice;var e=this._getTextureCoord(jj,je,1);this._setupBuffers(jt,jh,e);this._draw()}}},_prepareTexture:function(){var T=this;if(!T._texturesInfo){T._texturesInfo={}}else{return}var i=T._texturesInfo;i.loaded=false;var e=T._earth._map.config.earthBackground;T._loadImage(e,function(je){i.loaded=true;if(!i.done){T._setupTexture(i,je);i.done=true}T._earth.fire(new fa("onrefresh"))})},_loadImage:function(i,T){var e=new Image();e.crossOrigin="anonymous";e._loaded=false;e.onload=function(){T(this);this._loaded=true};e.src=i},_setupTexture:function(i,e){if(!i){return}var je=this._gl;this._webglState.activeTexture(je.TEXTURE0);i.texture=je.createTexture();var T=i.texture;je.bindTexture(je.TEXTURE_2D,T);je.pixelStorei(je.UNPACK_FLIP_Y_WEBGL,true);je.texImage2D(je.TEXTURE_2D,0,je.RGBA,je.RGBA,je.UNSIGNED_BYTE,e);je.texParameteri(je.TEXTURE_2D,je.TEXTURE_WRAP_S,je.CLAMP_TO_EDGE);je.texParameteri(je.TEXTURE_2D,je.TEXTURE_WRAP_T,je.CLAMP_TO_EDGE);je.texParameteri(je.TEXTURE_2D,je.TEXTURE_MAG_FILTER,je.LINEAR);je.texParameteri(je.TEXTURE_2D,je.TEXTURE_MIN_FILTER,je.LINEAR)},_justBindTexture:function(e){if(!e){return}var i=this._gl;var T=this._glProgram;this._webglState.activeTexture(i.TEXTURE0);i.bindTexture(i.TEXTURE_2D,e);i.uniform1i(T.samplerUniform,0)},_setupBuffers:function(T,e,i){var je=this._gl;if(!this._trianglesVerticeBuffer){this._trianglesVerticeBuffer=je.createBuffer()}je.bindBuffer(je.ARRAY_BUFFER,this._trianglesVerticeBuffer);this._float32Array.set(T);je.bufferData(je.ARRAY_BUFFER,this._float32Array,je.STREAM_DRAW);if(!this._triangleVerticesIndexBuffer){this._triangleVerticesIndexBuffer=je.createBuffer();this._triangleVerticesIndexBuffer.vertexCount=e.length;je.bindBuffer(je.ELEMENT_ARRAY_BUFFER,this._triangleVerticesIndexBuffer);this._uint16Array.set(e);je.bufferData(je.ELEMENT_ARRAY_BUFFER,this._uint16Array,je.STREAM_DRAW)}if(this._triangleVerticesIndexBuffer.vertexCount!==e.length){this._triangleVerticesIndexBuffer.vertexCount=e.length;je.bindBuffer(je.ELEMENT_ARRAY_BUFFER,this._triangleVerticesIndexBuffer);this._uint16Array.set(e);je.bufferData(je.ELEMENT_ARRAY_BUFFER,this._uint16Array,je.STREAM_DRAW)}if(!this._vertexTexCoordBuffer){this._vertexTexCoordBuffer=je.createBuffer()}je.bindBuffer(je.ARRAY_BUFFER,this._vertexTexCoordBuffer);this._float32Array.set(i);je.bufferData(je.ARRAY_BUFFER,this._float32Array,je.STREAM_DRAW)},_getVertex:function(T,je){var e=aU.H_SEGS/this._cols;var jf=aU.H_SEGS/e;var i=T+je*jf;return this._sphere.facesVertex[i]},_getTextureCoord:function(e,i){return this._sphere.sphere.generateTextureCoord(1,e,i)},_draw:function(){var e=this._gl;var i=this._glProgram;e.bindBuffer(e.ARRAY_BUFFER,this._trianglesVerticeBuffer);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._triangleVerticesIndexBuffer);e.vertexAttribPointer(i.vertexPositionAttribute,3,e.FLOAT,false,0,0);e.bindBuffer(e.ARRAY_BUFFER,this._vertexTexCoordBuffer);e.vertexAttribPointer(i.vertexTexCoordAttribute,2,e.FLOAT,false,0,0);e.drawElements(e.TRIANGLES,this._triangleVerticesIndexBuffer.vertexCount,e.UNSIGNED_SHORT,0)},_getColAndRow:function(){var je;var jh;var jg;var T;var ji;var e;var jf;var i;je=0;jh=this._cols-1;jg=0;T=this._rows-1;ji=0;e=0;jf=0;i=0;return[[je,jh,jg,T],[ji,e,jf,i]]}});function fM(i){this._earth=i;this._canvas=i._canvas;var e=this._ratio=this._earth.scene._ratio;this._width=this._canvas.width/e;this._height=this._canvas.height/e;var T=this._gl=i.scene._gl;this._webglState=dt.WebGLState.get(T,i._guid);this._glProgram=null;this._pMatrix=mat4.create();this._mvMatrix=mat4.create();this._vertexBuffer=T.createBuffer();this._markersRenderData=[];this._imgPool=new eF("img");this._imagesAdded={};this._float32Array=new Float32Array(2000);this._useRound=true;this.zIndex=20;this._init()}fM.VS_SHADER_TEXT=["precision highp float;","attribute vec3 aVertexPosition;","attribute vec2 aVertexTextureCoord;","varying vec2 vTextureCoord;","uniform mat4 uMVMatrix;","uniform mat4 uPMatrix;","void main(void) {","    gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);","    vTextureCoord = aVertexTextureCoord;","}"].join("\\n");fM.FS_SHADER_TEXT=["precision highp float;","uniform sampler2D uSampler;","varying vec2 vTextureCoord;","void main(void) {","    gl_FragColor = texture2D(uSampler, vTextureCoord);","}"].join("\\n");ev.extend(fM.prototype,{_init:function(){this._initShaders();this._getAllUniforms();this._getAttribLocation();this._updateMatrix();this._textureAtlas=new dt.TextureAtlas(this._gl,{width:4096,height:4096});var e=this;var i=this._earth.getMap();var e=this;i.addEventListener("movestart",function(){e._useRound=false});i.addEventListener("moveend",function(){e._useRound=true});i.addEventListener("zoomstart",function(){e._useRound=false});i.addEventListener("zoomend",function(){e._useRound=true;e.onStatusChange();e._earth.fire(new fa("onrefresh"))});this._earth.on("markers_status_change",function(){e.onStatusChange();e._earth.fire(new fa("onrefresh"))})},_updateMatrix:function(){mat4.identity(this._mvMatrix);mat4.translate(this._mvMatrix,this._mvMatrix,[-this._width/2,this._height/2,0]);mat4.ortho(this._pMatrix,-this._width/2,this._width/2,-this._height/2,this._height/2,100,-100)},_initShaders:function(){var e=fM.VS_SHADER_TEXT;var T=fM.FS_SHADER_TEXT;var jf=this._gl;var jg=this._glProgram=jf.createProgram();var je=this._makeShader(e,jf.VERTEX_SHADER);var i=this._makeShader(T,jf.FRAGMENT_SHADER);jf.attachShader(jg,je);jf.attachShader(jg,i);jf.linkProgram(jg);jf.useProgram(jg)},_makeShader:function(je,e){var T=this._gl;var i=T.createShader(e);T.shaderSource(i,je);T.compileShader(i);return i},_getAllUniforms:function(){var i=this._glProgram;var e=this._gl;i.pMatrixUniform=e.getUniformLocation(i,"uPMatrix");i.mvMatrixUniform=e.getUniformLocation(i,"uMVMatrix");i.sampler=e.getUniformLocation(i,"uSampler")},_setUniforms:function(){var i=this._glProgram;var e=this._gl;e.uniformMatrix4fv(i.pMatrixUniform,false,this._pMatrix);e.uniformMatrix4fv(i.mvMatrixUniform,false,this._mvMatrix)},_getAttribLocation:function(){var i=this._glProgram;var e=this._gl;i.vertexPositionAttribute=e.getAttribLocation(i,"aVertexPosition");i.vertexTexCoordAttribute=e.getAttribLocation(i,"aVertexTextureCoord")},resize:function(){this._width=this._canvas.width/this._ratio;this._height=this._canvas.height/this._ratio;this._updateMatrix()},_addTexture:function(e){return this._textureAtlas.addTexture(e)},onStatusChange:function(jj){this._updateScreenPixel();this._calcCollision();var jg=this._earth.getZoom();if(jg>=this._earth.zoomForNight+1){this._markersRenderData=this._earth._overlayMgr.getMarkersRenderData();var ji=this;for(var je=0;je<this._markersRenderData.length;je++){var T=this._markersRenderData[je].overlay;var jh=T._config.icon;if(T.textureCoord){continue}var jk=jh.imageUrl;var jf=jh.imageDom;if(jk){if(ji._ratio>1&&jh.srcSetObject["2x"]){jk=jh.srcSetObject["2x"];jh.ratio=2}if(ji._imagesAdded[jk]){if(ji._imagesAdded[jk].status==="loaded"){if(jh.imageSize){jh.ratio=ji._imagesAdded[jk].imgSize.width/jh.imageSize.width}T.textureCoord=ji._calcTextureCoords(ji._imagesAdded[jk].imgSize,jh.size,jh.imageOffset,ji._imagesAdded[jk].textureOffset,jh.ratio);ji._earth.fire(new fa("onrefresh"))}else{ji._imagesAdded[jk].markers.push(T)}continue}ji._imagesAdded[jk]={status:"loading",markers:[T]};ji._loadIconImageByUrl(jk)}else{if(jf){if(ji._imagesAdded[jf.id]){if(jh.imageSize){jh.ratio=ji._imagesAdded[jf.id].imgSize.width/jh.imageSize.width}T.textureCoord=ji._calcTextureCoords(ji._imagesAdded[jf.id].imgSize,jh.size,jh.imageOffset,ji._imagesAdded[jf.id].textureOffset,jh.ratio);ji._earth.fire(new fa("onrefresh"));continue}ji._imagesAdded[jf.id]={status:"loading",markers:[T]};ji._processImageAfterLoad(jf.id,jf)}}}}else{this._markersRenderData=[]}},_loadIconImageByUrl:function(jf){var T=this;var e=T._imgPool.get();e.crossOrigin="anonymous";e.onload=function i(){T._processImageAfterLoad(jf,this);T._imgPool.free(this)};e.onerror=function je(){T._imgPool.free(this);T._imagesAdded[jf]=null};e.src=jf},_processImageAfterLoad:function(T,jg){this._imagesAdded[T].status="loaded";var i=this._addTexture(jg);var jf=new h8(jg.width,jg.height);this._imagesAdded[T].imgSize=jf;this._imagesAdded[T].textureOffset=i;for(var e=0;e<this._imagesAdded[T].markers.length;e++){var jh=this._imagesAdded[T].markers[e];var je=jh._config.icon;if(je.imageSize){je.ratio=jf.width/je.imageSize.width}jh.textureCoord=this._calcTextureCoords(jf,je.size,je.imageOffset,i,je.ratio)}this._imagesAdded[T].markers=[];this._earth.fire(new fa("onrefresh"))},_calcTextureCoords:function(ji,jl,jq,jk,i){if(!ji||!jl||!jq||!jk){}i=i||1;var T=this._textureAtlas.getSize();var jj=-jq.width*i;var e=-jq.height*i;var jp=-jj/T.width+jk.width;var jh=(ji.height+e-jl.height*i)/T.height+jk.height;var jo=(-jj+jl.width*i)/T.width+jk.width;var jg=jh;var jn=jo;var jf=(ji.height+e)/T.height+jk.height;var jm=jp;var je=jf;return[jp,jh,jo,jg,jn,jf,jp,jh,jn,jf,jm,je]},_updateScreenPixel:function(){var js=this._earth;var jl=js.getCenter();var jo=js.scene._camera;for(var jk=0;jk<this._markersRenderData.length;jk++){var jf=this._markersRenderData[jk];var jm=jf.overlay;var je;if(js.getZoom()>15){var jp=js.scene.fromLatLngToXYZ(jm.latLng);jp=aj(jp,js.rotationInfo);je=js.scene.fromXYZToPixel(jp[0],jp[1],jp[2],{isCalcOnBack:true,useRound:this._useRound,matrixInfo:{modelViewMatrix:jo._mvMatrixForCamera}})}else{je=js.fromLatLngToPixel(jm.latLng,{isCalcOnBack:true,useRound:this._useRound})}if(je.onBack){jf.screenVertex=[];jf.screenBounds=null;continue}if(jm._config.enableCollisionDetection){var jr=jm.getIcon();var jh=je.x-jr.anchor.width;var jg=je.y-jr.anchor.height;var T=jh+jr.size.width;var e=jg+jr.size.height;jf.screenBounds={minX:jh,minY:jg,maxX:T,maxY:e}}var jn=jf.iconRenderData.vertex;var jq=[];var jj=jm._config.offset;for(var ji=0;ji<jn.length/3;ji++){jq[ji*3]=jn[ji*3]+je.x+jj.width;jq[ji*3+1]=jn[ji*3+1]-je.y+jj.height;jq[ji*3+2]=jn[ji*3+2]}jf.screenVertex=jq}},_calcCollision:function(){var jm=this._markersRenderData;var jl=[];for(var ji=0;ji<jm.length;ji++){if(jm[ji].overlay._config.enableCollisionDetection&&jm[ji].screenBounds){jl.push(jm[ji])}}jl.sort(function(jp,i){return i.overlay._config.rank-jp.overlay._config.rank});var jf=2;for(var ji=0;ji<jl.length;ji++){var e=jl[ji];var jo=e.screenBounds;e._intersectIndex=[];jl[ji].overlay.collisionDetectionFailed=false;for(var jg=ji+1;jg<jl.length;jg++){var T=jl[jg].screenBounds;if(jo.minX+jf<T.maxX-jf&&jo.maxX-jf>T.minX+jf&&jo.minY+jf<T.maxY-jf&&jo.maxY-jf>T.minY+jf){e._intersectIndex.push(jg)}}}for(var ji=0,je=jl.length;ji<je;ji++){var jh=jl[ji].overlay;if(jh.collisionDetectionFailed===false){var jn=jl[ji]._intersectIndex;for(var jg=0,jk=jn.length;jg<jk;jg++){var jj=jn[jg];jl[jj].overlay.collisionDetectionFailed=true}}}for(var ji=0,je=jl.length;ji<je;ji++){var jh=jl[ji].overlay;if(jh.collisionDetectionFailed){jh.hideInternal("collision")}else{jh.showInternal()}}},renderFrame:function(i){var je=this._earth._map;if(je._displayOptions.overlay===false){return}if(this._markersRenderData.length===0){return}var e=this._earth.getZoom();if(e<this._earth.zoomForNight+1){return}var jf=this._gl;var jg=this._glProgram;var T=this._webglState;jf.useProgram(jg);T.disableCap("depthTest");T.enableCap("blend");T.enableCap("cullFace");T.cullFace(jf.BACK);T.initAttribute();T.enableAttribute(jg.vertexPositionAttribute);T.enableAttribute(jg.vertexTexCoordAttribute);T.disableUnusedAttributes();this._drawOverlays(jf,jg)},_drawOverlays:function(jh,e){var jk=this._textureAtlas.getTexture();var jl=this._float32Array;var ji=[];for(var jf=0,T=this._markersRenderData.length;jf<T;jf++){var jg=this._markersRenderData[jf].overlay;if(!jg.textureCoord||jg.collisionDetectionFailed===true){continue}var jj=this._markersRenderData[jf].screenVertex;if(!jj){continue}for(var je=0;je<jj.length/3;je++){ji.push(jj[je*3]);ji.push(jj[je*3+1]);ji.push(jj[je*3+2]);ji.push(jg.textureCoord[je*2]);ji.push(jg.textureCoord[je*2+1])}}if(ji.length===0){return}this._setUniforms();this._webglState.activeTexture(jh.TEXTURE0);jh.bindTexture(jh.TEXTURE_2D,jk);jh.uniform1i(e.sampler,0);jh.bindBuffer(jh.ARRAY_BUFFER,this._vertexBuffer);if(ji.length<jl.length){jl.set(ji,0)}else{jl=new Float32Array(ji)}jh.bufferData(jh.ARRAY_BUFFER,jl,jh.STATIC_DRAW);jh.vertexAttribPointer(e.vertexPositionAttribute,3,jh.FLOAT,false,20,0);jh.vertexAttribPointer(e.vertexTexCoordAttribute,2,jh.FLOAT,false,20,12);jh.drawArrays(jh.TRIANGLES,0,ji.length/5)}});function iS(T,e){this._earth=T;this._opts=e||{};this.renderer=new e8(T,this);this.domains=dR.B_SATELLITE_MAP.tileUrls;var i=iT("ditu","satellite");this._udt=i.udt;this._version=i.ver}ev.extend(iS.prototype,{getTilesUrl:function(e,jj,T,jf,jh){var jg;var i="";var je=fD();if(jf==="night"){var ji=this._earth.getContainerSize().height;if(ji>800||je>=g0.HIGH_RES_MIN_RATIO){return w.imgPath+"tiles/night_1-2k.jpg?20150826"}return w.imgPath+"tiles/night_1.jpg?20150826"}else{if(jf==="world"){var ji=this._earth.getContainerSize().height;if(ji>800||je>=g0.HIGH_RES_MIN_RATIO){return w.imgPath+"tiles/world_1-2k.jpg?20150826"}return w.imgPath+"tiles/world_1.jpg?20150826"}else{if(jf==="er"){if(T<2){T=2}if(jh.indexOf("north")>-1){return w.imgPath+"tiles/north_polar_"+T+".jpg?20150826"}else{return w.imgPath+"tiles/south_polar_"+T+".jpg?20150826"}}else{i=Math.round(Math.abs(e+jj)%4);jg=this.domains[i]+"u=x={x};y={y};z={z};v=009;type=sate&fm=46&app=webearth2&v="+this._version+"&udt="+this._udt}}}return jg.replace("{index}",i).replace("{z}",T).replace("{x}",e).replace("{y}",jj).replace("-","M").replace("-","M")}});function iQ(T,e){this._earth=T;this._opts=e||{};this.type="streetlayer";var i=iT("ditu","satelliteStreet");this._udt=i.udt;this._version=i.ver}ev.extend(iQ.prototype,{getTilesUrl:function(je,jh,jg,T){var e=dR.B_STREET_MAP.tileUrls;var i=Math.round(Math.abs(je+jh)%e.length);var tdir=bmapcfg.tiles_road_dir.length>0?bmapcfg.tiles_road_dir:bmapcfg.home+"/tiles_road";if(bmapcfg.debug==true){/*debugger;*/var yl=("http://maponline2.bdimg.com/tile/?qt=vtile&x={x}&y={y}&z={z}&styles=sl&showtext=0&v="+this._version+"&udt="+this._udt).replace("{z}",jg).replace("{x}",je).replace("{y}",jh).replace("=-","=M");var old=(tdir+"/{z}/{x}/{y}"+bmapcfg.imgext).replace("{z}",jg).replace("{x}",je).replace("{y}",jh).replace("-","M");console.log("%c\\nå«æåå°å¾å è½½:"+yl+"\\n%c â¡ï¸ \\n"+"%cå«æç°å°å¾å è½½:"+old,"color: #fadfa3; background: #030307;","color: red;","color: #fadfa3; background: #030307;")}var jf=e[i]+"?qt=vtile&x={x}&y={y}&z={z}&styles=sl&showtext=0&v="+this._version+"&udt="+this._udt;jf=tdir+"/{z}/{x}/{y}"+bmapcfg.imgext;return jf.replace("{z}",jg).replace("{x}",je).replace("{y}",jh).replace("=-","=M")}});var jc=3;var hA=5;var aK=5;var ic=4;var fW=3;var H=2;var dX=1;var gM=0;var eN={3:{start:3,base:3},4:{start:4,base:5},5:{start:4,base:5},6:{start:6,base:7},7:{start:6,base:7},8:{start:8,base:9},9:{start:8,base:9},10:{start:10,base:10},11:{start:11,base:12},12:{start:11,base:12},13:{start:11,base:12},14:{start:14,base:15},15:{start:14,base:15},16:{start:16,base:17},17:{start:16,base:17},18:{start:18,base:19},19:{start:18,base:19},20:{start:18,base:19},21:{start:18,base:19}};function fP(jf,je){this._earth=jf;var e=jf.scene._ratio;this._width=jf._canvas.width/e;this._height=jf._canvas.height/e;this._opts=je||{};var T=bq();this._udt=T.udt;this._version=T.ver;var i=iT("ditu","normal");this._udt2=i.udt;this._version2=i.ver;this._tileType=hg.getInstance("na");this._iconRefreshTimer=null;this._rawDataCache=new hn(200);this._binaryCache={};this._iconCache={};this._init();this.renderer=new d0(jf,this)}ev.extend(fP.prototype,{_init:function(){this._imgPool=new eF("img");this._projection=this._earth.getProjection();this._radius=this._earth.radius;this._featureStyle=bp["FeatureStyle"+this._earth._map.config.style];this._textTextureImgWidth=4096;this._textTextureImgHeight=4096;if(this._earth.scene._ratio>1){this._textTextureImgWidth+=1024}this._textTextureImgWidth=Math.min(this._textTextureImgWidth,cK.params.maxTextureSize);this._tempI=mat2.create();this._tempRotateMatrix=mat2.create();this._tempOut=mat2.create();this._v2_0=vec2.create();this._v2_1=vec2.create();this._v2_2=vec2.create();this._v2_3=vec2.create();this._wordSpaceRatio=2;this._fixedLabelMagRatio=0.5;this._lineLabelMagRatio=700*0.56/this._earth.getContainerSize().height;this._headingHash={_0:true,_90:true,_180:true,_270:true,_360:true}},loadTileData:function(T,jj,jf,i,ji){var jg=this;var jh=ji.replace("key","cbk").replace(/-/g,"M");bp[jh]=function(jn){var jo=jn[5];if(jo){var jl=jg._imgPool.get();if(ev.Browser.safari){jl.src=""}var jk=jn[6];jl.onload=function(){jk=jk||this.height;var jq=jg.renderer.addTextTexture(this,jk);if(jq===null){jg._imgPool.free(this);return}var jp=jg._processData(this,jn,T,jj,jf,i,jq,jk);jg.renderer.setTextureInfoRes(ji,jp);jg._imgPool.free(this)};jl.src=jo}else{var jm=jg._processData(null,jn,T,jj,jf,i);jg.renderer.setTextureInfoRes(ji,jm)}jg._rawDataCache.setData(ji,jn);delete bp[jh]};var je=this._rawDataCache.getData(ji);if(je){bp[jh](je)}else{var e=jg._getTilesUrl(T,jj,jf,jh);ga.load(e)}},_processData:function(jh,je,i,jk,jg,e,T,ji){var jj={};var jf;if(jh){jf=this._calcIconAndTextInfo(je,i,jk,jg,e,jh.width,ji,T)}else{jf=this._calcIconAndTextInfo(je,i,jk,jg,e,null,null)}jj.icTxtInfo=jf;jj.imageContentHeight=ji;return jj},_calcIconAndTextInfo:function(jl,jf,jo,jm,je,jg,jn,jh){var T=[];if(jl[0]){for(var jk=0;jk<jl[0].length;jk++){if(jl[0][jk][0]===jc){T.push(jl[0][jk])}}}var jj=jl[2]||[];var ji=[];var e=[];for(var jk=0;jk<T.length;jk++){this._getFixedLabelInfo(T[jk],jf,jo,jm,je,jg,jn,jh,ji)}for(jk=0;jk<jj.length;jk++){this._getLineLabelInfo(jj[jk],jf,jo,jm,je,jg,jn,jh,e)}return{fixedLabel:ji,lineLabel:e}},_getFixedLabelInfo:function(jx,jf,jo,e,jD,jI,jy,jR,jP){var jM=this._earth._map.getMapStyleId();var jz=jx[1];if(!jz){return}var jE=this._featureStyle;var ji=jD;if(ji===9){ji=8}var jC=this._projection;var jQ=200;var jK=Math.pow(2,18-e);var T=this._tileType.getBaseTileSize(e);var jB=jf*T*jK;var jA=jo*T*jK;for(var jO=0;jO<jz.length;jO++){var jk=jz[jO];var jH=jk[0];var js=aP.getStyleFromCache(jM,jH,"point",ji,jE);var jL=aP.getStyleFromCache(jM,jH,"pointText",ji,jE);if((!jL||jL.length===0)&&(!js||js.length===0)){if(ji===5){var je=jk[1];if(!je){continue}for(var jN=0;jN<je.length;jN++){var jp=je[jN][4];if(jp&&jp[7]==="åäº¬"){js=aP.getStyleFromCache(jM,jH,"point",6,jE);jL=aP.getStyleFromCache(jM,jH,"pointText",6,jE);break}else{continue}}}else{continue}}var je=jk[1];if(!je){continue}var jl=null;var jr=1;var jn=0;var jt=0;if(js&&js[0]){js=js[0];jl=js.icon;jr=js.zoom?js.zoom/100:1}else{js=null}for(var jN=0;jN<je.length;jN++){var jp=je[jN][4];if(!jp){continue}var jJ=jp[2];if(!this._isVisible(jJ,jD)){continue}var jm=jp[12];if(jL&&jL.length>0&&!jm){continue}var jG=Math.round(jp[0]/100);var jF=Math.round(jp[1]/100);var jS={lng:jB+jG,lat:jA+jF};var ju=jC.convertMC2LL(jS);var jv=jp[7]||"";var jh={type:"fixed",latLng:ju,pt:jS,name:jv,rank:jp[4],iconPos:null,textPos:null,tilePosStr:jp[0]+","+jp[1],guid:jp[3]||""};var jj=jp[5];if((jj!==ic&&jm||!jm)&&jl!==null){jh.iconPos=this._getIconVertexData(jl,jr);if(jh.iconPos){jn=jh.iconPos.width;jt=jh.iconPos.height;var jw=this._iconCache[jl];if(!jw){jw=this._iconCache[jl]={loaded:false,img:null};var jq=this;var jg=new Image();jg.id=jl;jg.crossOrigin="anonymous";jg.onload=function(){jq._iconCache[this.id].img=this;jq._iconCache[this.id].loaded=true;jq._addToIconTexture(this);if(jq._iconRefreshTimer===null){jq._iconRefreshTimer=setTimeout(function(){jq._earth.fire(new fa("onrefresh"));jq._iconRefreshTimer=null},jQ)}this.onload=null};jg.onerror=function(){jq._iconCache[this.id]=null;this.onerror=null};jg.src=w.getIconSetPath(this._earth._map)+jl+".png"}}}if(jm){jh.textPos=this._getTextVertexData(jp,jn,jt,jI,jy,jR)}if(jh.textPos||jh.iconPos){this._addBounds(jh);jP.push(jh)}}}},_getLineLabelInfo:function(js,jj,jt,jf,jR,j0,jN,ka,jM){if(js.length!==10){return}var jk=jR;var jh=this._wordSpaceRatio;var jy=Math.pow(2,18-jf);var jg=this._tileType.getBaseTileSize(jf);var jQ=jj*jg*jy;var jP=jt*jg*jy;var j6=this._projection;var jZ=js[7].length;var jD=js[1];var j1=js[3];var jo=js[4];var e=2;var jl=jo.slice(0,e);for(var j3=e;j3<jo.length;j3+=e){jl[j3]=jl[j3-e]+jo[j3];jl[j3+1]=jl[j3-(e-1)]+jo[j3+1]}for(var j5=0;j5<jZ;j5++){var j2=js[7][j5];if(!this._isVisible(j2,jR)){continue}var jW=js[6][j5];var jB=j5*j1*e;jo=jl.slice(jB,jB+j1*e);var jI=[];var jV=1000;var jU=1000;var jA=-1000;var jz=-1000;var j8=js[9].slice(0);if(jW){j8.reverse()}var jH;var jG;var ji;var jI=[];var jF;for(var j4=0;j4<j1;j4++){var jx=js[5][j1*j5+j4];var jY=jo[j4*e]/100;var jX=jo[j4*e+1]/100;var kc={lng:jQ+jY,lat:jP+jX};var jC=j6.convertMC2LL(kc);if(j4===0){jH=jY;jG=jX;ji={lng:jQ+jH,lat:jP+jG};var jE=jo[(j1-1)*e]-jo[0];var jn=jo[(j1-1)*e+1]-jo[1];if(jW===1){jE=-jE;jn=-jn}jF=this._calcAngleByXYDiff(jE,jn);jI.baseX=ji.lng;jI.baseY=ji.lat}var jw=j8[j4];var jp=jw[0];var jr=jw[1];var jm=jw[2];var jq=jw[3];var jT=(jY-jH)/jy*jh;var jS=(jX-jG)/jy*jh;var kd=jp/this._textTextureImgWidth+ka.width;var jO=(jN-jr)/this._textTextureImgHeight+ka.height;var kb=kd;var jL=(jN-jr-jq)/this._textTextureImgHeight+ka.height;var j9=(jp+jm)/this._textTextureImgWidth+ka.width;var jK=jO;var j7=j9;var jJ=jL;jI.push([[jT,jS],[jm,jq],jx,[kd,jO,kb,jL,j9,jK,j7,jJ]]);var jv=jT-jm/2;var je=jS+jq/2;var T=jS-jq/2;var ju=jT+jm/2;if(jv<jV){jV=jv}if(ju>jA){jA=ju}if(T<jU){jU=T}if(je>jz){jz=je}}jM.push({type:"line",rank:jD,pt:ji,bounds:[jV,jU,jA,jz],wordsInfo:jI,labelAngle:jF,latLng:jC})}},_calcAngleByXYDiff:function(je,T){var i;if(je===0){if(T>0){i=90}else{i=270}return i}var e=T/je;var i=eG(Math.atan(e));if(je<0&&T>0){i+=180}else{if(je<0&&T<0){i+=180}else{if(je>0&&T<0){i+=360}}}if(i===360){i=0}return i},_isVisible:function(e,i){var je;if(!this._binaryCache[e]){je=e.toString(2);if(je.length<8){je=new Array(8-je.length+1).join("0")+je}this._binaryCache[e]=je}je=this._binaryCache[e];var T=eN[i].start;return je[i-T]==="1"},_getTextVertexData:function(ju,jj,jq,js,jm,T){var jB=ju[5];if(typeof jB!=="number"){jB=0}var jp=ju[12];var jk=jp.length;var jr=[];var jt=[];var jw=0;var jC=0;for(var jv=0;jv<jk;jv++){jC+=Math.round(jp[jv][3])}for(var jv=0;jv<jk;jv++){var jn=jp[jv];var jl=jn[0];var i=jn[1];var jh=jn[2];var e=jn[3];var jD=4;var jA;var ji;if(jj===0){jB=ic}switch(jB){case fW:var jo=jC/2-e+jD*(jk-1)/2;jA=Math.round(-jj/2-jh)-jD;ji=Math.round(jo-jw-jD*jv);break;case dX:var jo=jC/2-e+jD*(jk-1)/2;jA=Math.round(jj/2)+jD;ji=Math.round(jo-jw-jD*jv);break;case H:var jo=jq/2+jC-e+jD*jk;jA=Math.round(-jh/2);ji=Math.round(jo-jw-jD*jv);break;case gM:var jo=-jq/2-jD-e;jA=Math.round(-jh/2);ji=Math.round(jo-jw-jD*jv);break;case ic:var jo=-jC/2-jD*(jk-1)/2;jA=Math.round(-jh/2);ji=Math.round(jo-jw-jD*jv);break}jw+=e;var jz=jA+Math.round(jh);var jg=ji;var jy=jz;var jf=jg+Math.round(e);var jx=jA;var je=jf;jr.push(jA,ji,jz,jg,jy,jf,jA,ji,jy,jf,jx,je);this._calcTexCoords(jl,i,jh,e,js,jm,T,jt)}return{destVertex:jr,srcCoord:jt,width:jh,height:e}},_getIconVertexData:function(jk,jh){var jf=this._earth._map.config.style;var jo=bp["iconSetInfo"+jf][jk];if(!jo){if(jk&&jk.charCodeAt(0)>=48&&jk.charCodeAt(0)<=57){jo=bp["iconSetInfo"+jf]["_"+jk]}}if(jo){var jg=jo[0]*jh;var jl=jo[1]*jh;var je=Math.round(-jg/2);var jn=Math.round(-jl/2);var T=je+jg;var jm=jn;var i=T;var jj=jm+jl;var e=je;var ji=jj;return{destVertex:[je,jn,T,jm,i,jj,je,jn,i,jj,e,ji],srcCoord:null,width:jg,height:jl,iconType:jk}}return null},_addToIconTexture:function(jh){var jg=this.renderer;var e=jg._iconTextureAtlas.addTexture(jh);jg._iconTextureAtlasOffset[jh.id]=e;var jl=0*jh.width/1024+e.width;var jf=0*jh.height/1024+e.height;var jk=jh.width/1024+e.width;var je=jf;var jj=jk;var T=jh.height/1024+e.height;var ji=jl;var i=T;jg._iconTextureAtlasCoords[jh.id]=[jl,jf,jk,je,jj,T,jl,jf,jj,T,ji,i]},_addLineTextPos:function(jo,jm,jV,jF,jJ,jw,jX,ju,je,j2){var jn=jm[8];var jA=jm[7];var jx=jm[3];var jR=0;var jh=this._wordSpaceRatio;for(var jZ=0,jW=jn.length;jZ<jW;jZ++){var jS=jn[jZ];var jQ=(jS[1]==1?true:false);var jy=jS[2];var ji=jS[0];var jz=[];var jP=1000;var jO=1000;var jt=-1000;var js=-1000;if(jQ&&!jA._reversed){jA.reverse();jA._reversed=true}var jK=ji[0][0][0];var jH=ji[0][0][1];jz.baseX=ju+jK*jX;jz.baseY=je+jH*jX;var jv=jJ.convertMC2LL(new cf(jz.baseX,jz.baseY));for(var jY=0,jD=ji.length;jY<jD;jY++){var jl=ji[jY];var jr=jl[1];var jj=jA[jR][0];var jk=jA[jR][1];var e=jA[jR][2];var jg=jA[jR][3];var jL=jl[0][0];var jI=jl[0][1];var jN=(jL-jK)*jh;var jM=(jI-jH)*jh;var j4=jj/this._textTextureImgWidth+j2.width;var jG=(jF-jk)/this._textTextureImgHeight+j2.height;var j3=j4;var jE=(jF-jk-jg)/this._textTextureImgHeight+j2.height;var j1=(jj+e)/this._textTextureImgWidth+j2.width;var jC=jG;var j0=j1;var jB=jE;var jU=[[jN,jM],[e,jg],jr,[j4,jG,j3,jE,j1,jC,j0,jB]];jz.push(jU);var jq=jN-e/2;var jf=jM+jg/2;var T=jM-jg/2;var jp=jN+e/2;if(jq<jP){jP=jq}if(jp>jt){jt=jp}if(T<jO){jO=T}if(jf>js){js=jf}jR++}if(jD>0){var jT={type:"line",wordsInfo:jz,labelAngle:jy,latLng:jv,bounds:[jP,jO,jt,js],rank:jx};jo.push(jT)}}},_addBounds:function(jk){var jg=1000;var je=1000;var T=-1000;var e=-1000;if(jk.iconPos){var ji=jk.iconPos.destVertex;for(var jj=0,jf=ji.length;jj<jf;jj+=2){var jm=ji[jj];var jl=ji[jj+1];if(jm<jg){jg=jm}if(jm>T){T=jm}if(jl<je){je=jl}if(jl>e){e=jl}}}if(jk.textPos){var jh=jk.textPos.destVertex;for(var jj=0,jf=jh.length;jj<jf;jj+=2){var jm=jh[jj];var jl=jh[jj+1];if(jm<jg){jg=jm}if(jm>T){T=jm}if(jl<je){je=jl}if(jl>e){e=jl}}}jk.bounds=[jg,je,T,e];jk.bds=[jg/2,je/2,T/2,e/2]},_calcTexCoords:function(T,jk,i,jq,je,jo,jf,e){var jp=T/this._textTextureImgWidth+jf.width;var jj=(jo-jk-jq)/this._textTextureImgHeight+jf.height;var jn=(T+i)/this._textTextureImgWidth+jf.width;var ji=jj;var jm=jn;var jh=(jo-jk)/this._textTextureImgHeight+jf.height;var jl=jp;var jg=jh;e.push(jp,jj,jn,ji,jm,jh,jp,jj,jm,jh,jl,jg)},updateTexCoords:function(ji,jg){for(var jf=0,e=ji.length;jf<e;jf++){var T=ji[jf].textPos;for(var je=1,jh=T.srcCoord.length;je<jh;je+=2){T.srcCoord[je]=T.srcCoord[je]-T.offsetY+jg}T.offsetY=jg}},collisionTestByZoomingOut:function(jr,jz){var je=this._earth;var jg=je.getHeading();var jo=this._fixedLabelMagRatio;var jf=this._lineLabelMagRatio;var e=je.getCenter();for(var jB=0,jx=jr.length;jB<jx;jB++){var jw=jr[jB];if(jw.isDel===true){continue}if(jw.type==="fixed"){var jv=jw.latLng;var js;if(je.getZoom()>15){var jI=je.scene.fromLatLngToXYZ(jv);jI=aj(jI,je.rotationInfo);js=je.scene.fromXYZToPixel(jI[0],jI[1],jI[2],{matrixInfo:{modelViewMatrix:je.scene._camera._mvMatrixForCamera}})}else{js=je.fromLatLngToPixel(jv)}jw.scrPt=js;var jD=js.x;var jC=jz-js.y;var jj=jw.bounds;jw._tempBounds=[jD+jj[0]*jo,jC+jj[1]*jo,jD+jj[2]*jo,jC+jj[3]*jo]}else{var jv=jw.latLng;var js=je.fromLatLngToPixel(jv);var jD=js.x;var jC=jz-js.y;var jj=jw.bounds;var jm=jj[0]*jf;var jl=jj[1]*jf;var jk=jj[2]*jf;var ji=jj[3]*jf;var jH=jm;var jG=jl;var jF=jk;var jE=ji;if(jg===0||jg===360){jH=jm;jG=jl;jF=jk;jE=ji}else{if(jg===90||jg===-270){jH=jl;jG=-jk;jF=ji;jE=-jm}else{if(jg===180||jg===-180){jH=-jk;jG=-ji;jF=-jm;jE=-jl}else{if(jg===270||jg===-90){jH=-ji;jG=jm;jF=-jl;jE=jk}}}}jw._tempBounds=[jD+jH,jC+jG,jD+jF,jC+jE]}}var ju=5;if(je.getImageZoom()===5){ju=-2}if(je.getImageZoom()===8){ju=10}for(var jB=0,jx=jr.length;jB<jx;jB++){var jt=jr[jB];if(jt.isDel===true){continue}var jA=jt._tempBounds;jt.arrIntersectIndex=[];for(jy=jB+1;jy<jx;jy++){var jq=jr[jy];if(jq.isDel===true){continue}var jh=jq._tempBounds;if(!(jA[2]+ju<jh[0]-ju||jA[0]-ju>jh[2]+ju||jA[3]+ju<jh[1]-ju||jA[1]-ju>jh[3]+ju)){jt.arrIntersectIndex.push(jy)}}}for(var jB=0,jx=jr.length;jB<jx;jB++){var jn=jr[jB];if(jn.isDel===false){var T=jn.arrIntersectIndex;for(var jy=0,jp=T.length;jy<jp;jy++){jr[T[jy]].isDel=true}}}},collisionTest:function(jG,jO,je){if(!jG){return}var e=this._earth;var jE=e.getHeading();var ji=[];var jl=[];var jQ=this._fixedLabelMagRatio;var jk=this._lineLabelMagRatio;var jJ=false;if(e.getZoom()<=6){jJ=true}for(var jN=0,jL=jG.length;jN<jL;jN++){var T=jG[jN];var jn=T.key;var jf=jO.getData(jn);if(!jf||!jf.icTxtInfo){continue}var jA=jf.icTxtInfo.fixedLabel;for(var jM=0,jx=jA.length;jM<jx;jM++){var jh=jA[jM];var jt=jh.latLng;var jy;if(e.getZoom()>15){var jm=e.scene.fromLatLngToXYZ(jt);jm=aj(jm,e.rotationInfo);jy=e.scene.fromXYZToPixel(jm[0],jm[1],jm[2],{matrixInfo:{modelViewMatrix:e.scene._camera._mvMatrixForCamera}})}else{jy=e.fromLatLngToPixel(jt,{isCalcOnBack:jJ})}var jw=jy.x;var jv=je-jy.y;var jz=jh.bounds;jh.scrPt=jy;jh._tempBounds=[jw+jz[0]*jQ,jv+jz[1]*jQ,jw+jz[2]*jQ,jv+jz[3]*jQ];jl.push(jh)}var jj=jf.icTxtInfo.lineLabel;for(var jM=0,jx=jj.length;jM<jx;jM++){var jh=jj[jM];var jt=jh.latLng;var jy=e.fromLatLngToPixel(jt);var jw=jy.x;var jv=je-jy.y;var jz=jh.bounds;var jK=jz[0]*jk;var jH=jz[1]*jk;var js=jz[2]*jk;var jr=jz[3]*jk;var jF=jK;var jD=jH;var jq=js;var jp=jr;if(jE===0||jE===360){jF=jK;jD=jH;jq=js;jp=jr}else{if(jE===90||jE===-270){jF=jH;jD=-js;jq=jr;jp=-jK}else{if(jE===180||jE===-180){jF=-js;jD=-jr;jq=-jK;jp=-jH}else{if(jE===270||jE===-90){jF=-jr;jD=jK;jq=-jH;jp=js}}}}jh._tempBounds=[jw+jF,jv+jD,jw+jq,jv+jp];jl.push(jh)}ji.push(jf)}jl.sort(function(jR,i){return i.rank-jR.rank||i.pt.lng-i.pt.lng||i.pt.lat-jR.pt.lat});var jg=5;if(e.getImageZoom()===5){jg=-2}if(e.getImageZoom()===8){jg=10}for(var jN=0,jL=jl.length;jN<jL;jN++){var jC=jl[jN];var jo=jC._tempBounds;jC.isDel=false;jC.arrIntersectIndex=[];for(jM=jN+1;jM<jL;jM++){var ju=jl[jM];var jP=ju._tempBounds;if(!(jo[2]+jg<jP[0]-jg||jo[0]-jg>jP[2]+jg||jo[3]+jg<jP[1]-jg||jo[1]-jg>jP[3]+jg)){jC.arrIntersectIndex.push(jM)}}}for(var jN=0,jL=jl.length;jN<jL;jN++){var jI=jl[jN];if(jI.isDel==false){var jB=jI.arrIntersectIndex;for(var jM=0,jx=jB.length;jM<jx;jM++){jl[jB[jM]].isDel=true}}}ji._arrLabels=jl;return ji},mergeFixedLabelInfo:function(ji,jv,jq,T,jn){var e=ji.icTxtInfo.fixedLabel;var je=[];var jf=[];var ju=this._fixedLabelMagRatio;var jg=600;for(var jr=0,jo=e.length;jr<jo;jr++){var jl=e[jr];var jj=jl.scrPt;var jt=jj.x;var js=jq-jj.y;if(jl.isDel||(jt<=0||jt>=jv||js<=0||js>=jq)||jj.onBack){continue}if(jl.iconPos&&!jl.iconPos.srcCoord){if(this.renderer._iconTextureAtlasCoords[jl.iconPos.iconType]){jl.iconPos.srcCoord=this.renderer._iconTextureAtlasCoords[jl.iconPos.iconType]}}if(jl.iconPos&&jl.iconPos.srcCoord){var jm=jl.iconPos.destVertex;var jk=jl.iconPos.srcCoord;for(var jp=0,jh=jm.length;jp<jh;jp+=2){je.push(jt+jm[jp]*ju,js+jm[jp+1]*ju,jg,jk[jp],jk[jp+1])}}if(jl.textPos){var jm=jl.textPos.destVertex;var jk=jl.textPos.srcCoord;for(var jp=0,jh=jm.length;jp<jh;jp+=2){jf.push(jt+jm[jp]*ju,js+jm[jp+1]*ju,jg,jk[jp],jk[jp+1])}}}var jw={iconVertex:je,textVertex:jf};return jw},mergeLineLabelInfo:function(jl,jI){var je=this._earth;var j0=je.getHeading();var jF=je.scene;var jU=this._projection;var jz=je.getZoom();var ju=jz+2;var jB=Math.pow(2,18-ju);var jy=this._tempI;var jC=jl.icTxtInfo.lineLabel;var jA=[];var jE=this._lineLabelMagRatio;var jw="_"+j0+"_"+jz;if(jI&&jC[jw]){return jC[jw]}var jJ=this.renderer.getStatusChangeEvent();var j8="_"+Math.abs(j0);if(jJ&&jJ.type==="onheading_changed"&&!this._headingHash[j8]&&jC[jC.preCacheKey]){return jC[jC.preCacheKey]}for(var j6=0,j4=jC.length;j6<j4;j6++){var jx=jC[j6];if(jx.isDel){continue}var jK=jx.wordsInfo;var jH=jx.labelAngle;var j2=jK.baseX;var j1=jK.baseY;for(var j5=0,jN=jK.length;j5<jN;j5++){var j3=jK[j5];var jZ=j3[0][0];var jX=j3[0][1];var e=j3[1][0];var jh=j3[1][1];var jD=j3[2];if(((j0===90||j0===-270)&&((jH>=45&&jH<=135)||(jH>=225&&jH<=315)))||((j0===-90||j0===270)&&((jH>=135&&jH<=225)||((jH>=315&&jH<=360)||(jH>=0&&jH<=45))))||(Math.abs(j0)===180)){var jG=jK[jN-1-j5];jZ=jG[0][0];jX=jG[0][1];jD=jG[2]}var jQ=j3[3];var kf=jQ[0];var jP=jQ[1];var ke=jQ[2];var jO=jQ[3];var kd=jQ[4];var jM=jQ[5];var kc=jQ[6];var jL=jQ[7];var jj=j2+(jZ-e/2)*jB*jE;var jW=j1+(jX+jh/2)*jB*jE;var jg=jj;var jV=j1+(jX-jh/2)*jB*jE;var jf=j2+(jZ+e/2)*jB*jE;var jT=jW;var T=jf;var jR=jV;var jk=(jj+jf)/2;var ji=(jW+jV)/2;var jS=this._tempRotateMatrix;var jY=this._tempOut;var jt=this._v2_0;var jq=this._v2_1;var jo=this._v2_2;var jm=this._v2_3;vec2.set(jt,jj-jk,jW-ji);vec2.set(jq,jg-jk,jV-ji);vec2.set(jo,jf-jk,jT-ji);vec2.set(jm,T-jk,jR-ji);mat2.rotate(jS,jy,(jD+j0)*Math.PI/180);mat2.multiply(jY,jS,jt);jj=jY[0]+jk;jW=jY[1]+ji;mat2.multiply(jY,jS,jq);jg=jY[0]+jk;jV=jY[1]+ji;mat2.multiply(jY,jS,jo);jf=jY[0]+jk;jT=jY[1]+ji;mat2.multiply(jY,jS,jm);T=jY[0]+jk;jR=jY[1]+ji;var jv=jU.convertMC2LL(new cf(jj,jW));var js=jU.convertMC2LL(new cf(jg,jV));var jp=jU.convertMC2LL(new cf(jf,jT));var jn=jU.convertMC2LL(new cf(T,jR));var kb=jF.fromLatLngToXYZ(jv,this._radius);var ka=jF.fromLatLngToXYZ(js,this._radius);var j9=jF.fromLatLngToXYZ(jp,this._radius);var j7=jF.fromLatLngToXYZ(jn,this._radius);if(this._earth.getZoom()>15){kb=aj(kb,je.rotationInfo);ka=aj(ka,je.rotationInfo);j9=aj(j9,je.rotationInfo);j7=aj(j7,je.rotationInfo)}jA.push(kb[0],kb[1],kb[2],kf,jP,ka[0],ka[1],ka[2],ke,jO,j9[0],j9[1],j9[2],kd,jM,ka[0],ka[1],ka[2],ke,jO,j7[0],j7[1],j7[2],kc,jL,j9[0],j9[1],j9[2],kd,jM)}}if(this._headingHash[j8]){var jr=jC.preCacheKey;if(jr){jC[jr]=null;delete jC[jr]}jC[jw]=jA;jC.preCacheKey=jw}return jA},_getTilesUrl:function(T,jj,ji,jh){var jf=dR.B_NORMAL_MAP.vectorTileUrls;var jg=Math.round(Math.abs(T+jj)%jf.length);var i="x={x}&y={y}&z={z}&udt={udt}&v={v}&styles=sl&textimg=1&textonly=1&scaler=2&fn="+eY+".{fn}";var je=i.replace("{x}",T).replace("{y}",jj).replace("{z}",ji).replace("{udt}",this._udt2).replace("{v}",this._version2).replace("{fn}",jh);var e=jf[jg]+"?qt=vtile&param="+window.encodeURIComponent(er(je));return e}});function fr(e){this._earth=e;this._overlays=[[],[],[]];this._markersRenderData=[];this._tiles=new hn(200);this._customOverlays=[];this._init();e._overlayMgr=this}ev.extend(fr.prototype,{_init:function(){this._bind();this._drawCanvas=bL("canvas");this._drawCanvasLOD=bL("canvas")},_bind:function(){var je=this;var jg=this._earth._map;function e(ji){if(jg.mapType!==BMAP_EARTH_MAP){return}je._update()}function jf(ji){if(jg.mapType!==BMAP_EARTH_MAP){return}je._updateMarker(ji.overlay,ji.action)}jg.on("addoverlay",function jh(jl){if(jg.mapType!==BMAP_EARTH_MAP){return}if(!(jl.overlay instanceof hL)&&!(jl.overlay instanceof iU)){return}var jj=jl.overlay;var ji=0;if(jl.overlay instanceof fl){ji=1}else{if(jl.overlay instanceof iU){ji=2}}for(var jk=0;jk<je._overlays[ji].length;jk++){if(je._overlays[ji][jk].hashCode===jj.hashCode){return}}je._overlays[ji].push(jj);if(ji!==2){jj.on("lineupdate",e);je._update()}else{jj.on("status_change",jf);je._updateMarker(jj,"add")}});jg.on("removeoverlay",function T(jl){if(jg.mapType!==BMAP_EARTH_MAP){return}if(!(jl.overlay instanceof hL)&&!(jl.overlay instanceof iU)){return}var jj=jl.overlay;var ji=0;if(jl.overlay instanceof fl){ji=1}else{if(jl.overlay instanceof iU){ji=2}}for(var jk=0;jk<je._overlays[ji].length;jk++){if(je._overlays[ji][jk].hashCode===jj.hashCode){je._overlays[ji].splice(jk,1);break}}if(ji!==2){jj.off("lineupdate",e);je._update()}else{jj.off("status_change",jf);je._updateMarker(jj,"remove")}});jg.on("clearoverlays",function i(ji){if(jg.mapType!==BMAP_EARTH_MAP){return}je._syncOverlayFromMap(e,jf)});jg.on("maptypechange",function(){if(this.mapType==="B_EARTH_MAP"){je._syncOverlayFromMap(e,jf)}});this._syncOverlayFromMap(e,jf)},_updateRenderData:function(e){if(!this._markersRenderData[e.hashCode]){return}for(var T=0;T<this._markersRenderData.length;T++){if(this._markersRenderData[T].hashCode===e.hashCode){this._markersRenderData[T].iconRenderData=e._config.icon.getRenderData(e._rotation);break}}},_addMarkerToRenderData:function(e){if(this._markersRenderData[e.hashCode]){return}var i=e._config.icon;this._markersRenderData.push({overlay:e,hashCode:e.hashCode,iconRenderData:e._config.icon.getRenderData(e._rotation)});this._markersRenderData[e.hashCode]=true;this._markersRenderData.sort(function(je,T){return je.overlay._zIndex-T.overlay._zIndex})},_removeMarkerFromRenderData:function(e){if(!this._markersRenderData[e.hashCode]){return}for(var T=0;T<this._markersRenderData.length;T++){if(this._markersRenderData[T].hashCode===e.hashCode){this._markersRenderData.splice(T,1);break}}this._markersRenderData[e.hashCode]=null},_clearOverlaysData:function(e,je){var jg;for(var T=0;T<this._overlays[0].length;T++){jg=this._overlays[0][T];jg.off("lineupdate",e)}for(T=0;T<this._overlays[1].length;T++){jg=this._overlays[1][T];jg.off("lineupdate",e)}var jf;for(T=0;T<this._overlays[2].length;T++){jf=this._overlays[2][T];jf.off("status_change",je)}this._overlays[0].length=this._overlays[1].length=this._overlays[2].length=0;this._markersRenderData=[]},_update:function(){var e=this;if(e._updateTimer){return}e._updateTimer=setTimeout(function(){e._tiles.clear();var i=new fa("onoverlaylayer_status_change");e._earth.fire(i);e._updateTimer=null},24)},_updateMarker:function(e,jf){if(e&&jf){if(jf==="add"||jf==="show"){if(e._visible===true){this._addMarkerToRenderData(e)}}else{if(jf==="remove"||jf==="hide"){this._removeMarkerFromRenderData(e)}else{this._updateRenderData(e);this._markersRenderData.sort(function(jg,i){return jg.overlay._zIndex-i.overlay._zIndex})}}}else{for(var T=0;T<this._overlays[2].length;T++){if(this._overlays[2][T]._visible===true){this._addMarkerToRenderData(this._overlays[2][T])}else{this._removeMarkerFromRenderData(this._overlays[2][T])}}}var je=new fa("onmarkers_status_change");this._earth.fire(je)},_syncOverlayFromMap:function(T,jf){this._clearOverlaysData(T,jf);var e=this._earth._map._overlays;for(var i in e){var je=e[i];if(je instanceof fl===true||je instanceof dT===true){this._overlays[1].push(je);je.on("lineupdate",T)}else{if(je instanceof gB===true){this._overlays[0].push(je);je.on("lineupdate",T)}else{if(je instanceof iU){this._overlays[2].push(je);je.on("status_change",jf)}}}}this._update();this._updateMarker()},generateOverlayTile:function(e){var jo;if(typeof e==="number"){jo=this._drawCanvasLOD}else{jo=this._drawCanvas}jo.getContext("2d").clearRect(0,0,9999,9999);var jF=this._overlays[0];var jg=this._overlays[1];var jH;var jn=new hf();for(var jz=0,jv=jF.length;jz<jv;jz++){jH=jF[jz].getBoundsIn();jn.extend(jH.getMin());jn.extend(jH.getMax())}for(jz=0,jv=jg.length;jz<jv;jz++){jH=jg[jz].getBoundsIn(true);jn.extend(jH.getMin());jn.extend(jH.getMax())}var jx=jn.clone();var jt=this._earth.getBounds();var jr=jt.getSouthWest();var jh=jt.getNorthEast();if(jr.lng>jh.lng){jh.lng=180}var jI=ig.convertLL2MC(jr);var T=ig.convertLL2MC(jh);e=e||this._earth.getImageZoom();var jq=Math.pow(2,e-18);var jG=this._earth._map;var je=jG.config.defaultMaxBounds;var jE=Math.max(jI.lng,je.sw.lng);var jD=Math.max(jI.lat,je.sw.lat);var jC=Math.min(T.lng,je.ne.lng);var jB=Math.min(T.lat,je.ne.lat);var jk=new hf(new cf(jE,jD),new cf(jC,jB));var jm=jx.intersects(jk);if(jm===null){if(!jk.containsBounds(jx)){if(this._earth.getZoom()>=4){return}}}jm=jm||jx;if(this._earth.getZoom()<4){jm=jx}if(jm.isEmpty()){return}var jf=jm.getMin();var ji=jm.getMax();var jj=new eO(jf.lng*jq,jf.lat*jq);var jl=new eO(ji.lng*jq,ji.lat*jq);var ju=Math.floor(jj.x/256);var js=Math.ceil(jl.x/256);var jy=Math.floor(jj.y/256);var jw=Math.ceil(jl.y/256);var jA=(js-ju+1)*256;var jp=(jw-jy+1)*256;jo.width=jA;jo.height=jp;jo.fromCol=ju;jo.fromRow=jy;jo.toCol=js;jo.toRow=jw;jo.cols=js-ju+1;jo.rows=jw-jy+1;for(jz=0,jv=jF.length;jz<jv;jz++){this._generateOverlayTileEach(jF[jz],ju,js,jy,jw,e,jo,true)}for(jz=0,jv=jg.length;jz<jv;jz++){this._generateOverlayTileEach(jg[jz],ju,js,jy,jw,e,jo,false)}},_generateOverlayTileEach:function(jA,jt,jo,jy,ju,T,jf,jk){var ji=jA.getBoundsIn(true);var jw=ji.clone();var jp=this._earth.getBounds();var jB=ig.convertLL2MC(jp.getSouthWest());var je=ig.convertLL2MC(jp.getNorthEast());T=T||this._earth.getImageZoom();var jn=Math.pow(2,T-18);var jh=new hf(jB,je);var jl=jw.intersects(jh);if(jl===null){if(!jh.containsBounds(jw)){if(this._earth.getZoom()>=4){return}}}if(jA.isVisible()===false){return}var jm=(ju-jy+1)*256;var js=jf.getContext("2d");js.save();js.lineCap=jA.getStrokeLineCap();js.lineJoin=jA.getStrokeLineJoin();js.globalAlpha=jA.getStrokeOpacity()+0.1;js.lineWidth=jA.getStrokeWeight()+1;js.strokeStyle=jA.getStrokeColor();js.beginPath();var e=jA.getParsedPoints();for(var jv=0;jv<e.length;jv++){var jj=e[jv];for(var jx=0,jr=jj.length;jx<jr;jx++){var jq=jj[jx];var jg=new eO(jq.lng*jn,jq.lat*jn);var jz=new eO(jg.x-jt*256,jm-(jg.y-jy*256));if(jx===0){js.moveTo(jz.x,jz.y)}else{js.lineTo(jz.x,jz.y)}}if(jk){js.closePath()}}if(jA.getStrokeStyle()==="dashed"){js.setLineDash([js.lineWidth*2,js.lineWidth*3])}js.stroke();if(jA instanceof gB){js.save();js.globalAlpha=jA.getFillOpacity();js.fillStyle=jA.getFillColor()||"transparent";js.fill("evenodd");js.restore()}js.restore()},getOverlayCanvas:function(e){if(e){return this._drawCanvasLOD}return this._drawCanvas},getMarkersRenderData:function(){return this._markersRenderData}});function ai(i,e){this._map=i;this._earth=e;this._container=e.getContainer();this._initEarthZoom=e.getZoom();this._draggingOnEarth=false;this._npLatLng=new b9(90,0);this._spLatLng=new b9(-90,0);this._opButton="";this._moved=false;this._bind()}ev.extend(ai.prototype,{_bind:function(){var i=this._map;var e=this;i.addEventListener("dblclick",function(je){if(this.mapType!==BMAP_EARTH_MAP){return}if(e._earth.getLock()){return}if(e._clickTimer){clearTimeout(e._clickTimer);e._clickTimer=null}var T=je.offsetPosMap;if(je.overlay instanceof iU){return}if(e.dragAni){e.dragAni.stop();e.dragAni=null}e._earth.fire(new fa("onearthdblclickzoom"));e._earth.zoomWithMousePosFix(e._earth.getZoom()+1,T)});this._earth.on("earthwheelzoom",function(){if(e.dragAni){e.dragAni.stop();e.dragAni=null}});ev.on(document,"keydown",function(T){if(i.mapType!==BMAP_EARTH_MAP){return}if(i.temp.stopArrow===true){i.temp.stopArrow=false}if(i.config.enableKeyboard&&i.temp.canKeyboard){switch(T.keyCode){case dL.KEY_LEFT:case dL.KEY_UP:case dL.KEY_RIGHT:case dL.KEY_DOWN:if(i.temp.operating===false){e._earth.fire(new fa("onearthkeyboardmove"))}i.temp.operating=true;e.moveByArrowKey(T.keyCode,"keydown");T.cancelBubble=true;T.returnValue=false;break}}});ev.on(document,"keyup",function(T){if(i.mapType!==BMAP_EARTH_MAP){return}if(i.config.enableKeyboard){switch(T.keyCode){case dL.KEY_LEFT:case dL.KEY_UP:case dL.KEY_RIGHT:case dL.KEY_DOWN:e.moveByArrowKey(T.keyCode,"keyup");break}}i.temp.operating=false});i.addEventListener("minuspress",function(){if(this.mapType!==BMAP_EARTH_MAP){return}e._earth.fire(new fa("onearthkeyboardzoomout"));e._earth.zoomOut()});i.addEventListener("pluspress",function(){if(this.mapType!==BMAP_EARTH_MAP){return}e._earth.fire(new fa("onearthkeyboardzoomin"));e._earth.zoomIn()})},onReadyToDrag:function(T){if(this._earth.getLock()){return}var i=T.offsetPosMap.x;var je=T.offsetPosMap.y;if(T.button===0){this._onDragStart(i,je)}else{if(T.button===2){this._onDragStartRight(i,je)}}},onReadyToPinch:function(){if(this._earth.getLock()){return}this._initEarthZoom=this._earth.getZoom()},onDragging:function(je,T){if(this._earth.getLock()){return}var i=je.offsetPosMap.x;var jf=je.offsetPosMap.y;this._lastMoveTime=Date.now();if(T.button===0){this._onDragging(i,jf,T.velocity,T.dir)}else{if(T.button===2){this._onDraggingRight(i,jf)}}this._moved=true},onPinching:function(jf,i){if(this._earth.getLock()){return}var je=i.zoomRatio;var T=this._initEarthZoom+Math.log(je)/Math.log(2);this._earth.zoomWithMousePosFix(T,i.pinchStartPosition,{opMethod:"screenPinch",stopCurrentAnimation:true,noAnimation:true})},onDragEnd:function(je,T){if(this._earth.getLock()){return}var i=je.offsetPosMap.x;var jf=je.offsetPosMap.y;if(je.button===0){this._onDragEnd(i,jf,T.velocity,T.dir)}else{if(je.button===2){this._onDragEndRight(i,jf)}}this._moved=false},onPinchEnd:function(i){},_onDragStart:function(e,T){if(this.dragAni){this.dragAni.stop();this.dragAni=null}var i=this._initLatLng=this._earth.fromPixelToLatLng(new eO(e,T));if(!i){return}this._initX=e;this._initY=T;this._earth.scene.saveMatrixInfo();this._curCenter=this._earth.getCenter().clone()},_onDragging:function(jm,jk,jg,je){var jn=this._earth;if(!this._mousemove){this._mousemove=true;jn.fire(new fa("onmovestart"));jn.fire(new fa("ondragstart"));this._dragStartTime=Date.now()}var T=jn.fromPixelToLatLng(new eO(jm,jk));if(!T){if(this._draggingOnEarth===false){return}this._draggingOnEarth=false;if(this._initLatLng){jn.fire(new fa("onearthdragend"));this._processMotion(jm,jk,jg*1.3,je);this._initLatLng=null}return}if(!this._initLatLng){return this._onDragStart(jm,jk)}this._draggingOnEarth=true;var e=this._earth._map;e.platform.style.cursor=e.config.draggingCursor;var ji=this._getLatLngDiffByXYDiff(jm,jk);if(ji===null){if(this._initLatLng){this._initLatLng=null}return}var jf=ji.lat;var jh=ji.lng;jn.fire(new fa("ondragging"));if(jn.getZoom()<4){this._needToRevertX=false;this._needToRevertY=false;var jl=jm-this._initX;var jj=jk-this._initY;var i;if(jn.ifLatLngInView(this._npLatLng)){i=this._earth.fromLatLngToPixel(this._npLatLng);var jo=this._earth.getHeading();if(jo===0&&this._initY<i.y||jo===180&&this._initY>i.y){jl=-jl;this._needToRevertX=true}else{if(jo===90&&this._initX>i.x||jo===270&&this._initX<i.x){jj=-jj;this._needToRevertY=true}}}else{if(jn.ifLatLngInView(this._spLatLng)){i=this._earth.fromLatLngToPixel(this._npLatLng);if(jo===0&&this._initY>i.y||jo===180&&this._initY>i.y){this._needToRevertX=true;jl=-jl}else{if(jo===90&&this._initX<i.x||jo===270&&this._initX<i.x){this._needToRevertY=true;jj=-jj}}}}this._setEarthCenterByXYDiff(jl,jj)}else{this._setEarthCenterByLatLngDiff(jf,jh)}this._moveDiffX=this._lastDiffX-jl;this._moveDiffY=this._lastDiffY-jj;this._lastDiffX=jl;this._lastDiffY=jj},_getLatLngDiffByXYDiff:function(e,jf){var T=this._earth.fromPixelToLatLng(new eO(e,jf),{useOld:true});if(!T){return null}var je=T.lat-this._initLatLng.lat;var i=T.lng-this._initLatLng.lng;return{lat:je,lng:i}},_setEarthCenterByLatLngDiff:function(i,e){this._earth.fire(new fa("onmoving"));this._earth.setCenter(new b9(this._curCenter.lat-i,this._curCenter.lng-e),{noAnimation:true,noFireEvent:true,stopCurrentAnimation:true,from:"mouse"})},_setEarthCenterByXYDiff:function(jf,T){this._earth.fire(new fa("onmoving"));var jh=this._earth.getHeading();var i=hM(jh);var e=this._getLatLngSpan(jf,T);var jg=this._curCenter.lat+e.lat*Math.cos(i)+e.lng*Math.sin(i);var je=this._curCenter.lng+e.lng*Math.cos(i)-e.lat*Math.sin(i);this._earth.setCenter(new b9(jg,je),{noAnimation:true,stopCurrentAnimation:true,from:"mouse",noFireEvent:true})},_getLatLngSpan:function(je,e){var T=this._earth._imageRawZoom||this._earth.getImageZoom();var i=-je/Math.pow(2,T-1);var jf=e/Math.pow(2,T-1);return{lat:jf,lng:i}},_onDragEnd:function(i,ji,jf,T){if(!this._mousemove){var jh=new fa("onclick");jh.pixel=new eO(i,ji);jh.latLng=this._initLatLng||null;this._earth.fire(jh);if(!this._clickTimer){var je=this;this._clickTimer=setTimeout(function(){je._clickTimer=null;var jj=new fa("onclickex");jj.pixel=new eO(i,ji);je._earth.fire(jj)},200)}}else{var jg=this._earth._map;jg.platform.style.cursor=jg.config.defaultCursor;this._earth.fire(new fa("onearthdragend"))}if(this._draggingOnEarth===true&&this._earth._map.config.enableInertialDragging){this._processMotion(i,ji,jf,T)}this._draggingOnEarth=false;this._lastMoveTime=null;this._mousemove=false},_processMotion:function(jn,jm,jl,jt){if(!this._initLatLng){return}if(!this._moved){return}var jE={x:jn-this._initX,y:jm-this._initY};var e=this._earth;var ji=Date.now();e.fire(new fa("ondragend"));var jr=ji-this._lastMoveTime;var js=Math.abs(this._moveDiffX);var jy=Math.abs(this._moveDiffY);if(jr>100||(jr>10&&js<10&&jy<10)||(js<3&&jy<3)){this._earth.fire(new fa("onanimation_end"));this._earth.fire(new fa("onmoveend"));return}var je=0.5*jl;var jx=0;var jv=0;if(jt.y===0){jx=je}else{var jk=Math.abs(jt.x/jt.y);jv=Math.round(Math.sqrt(je*je/(1+jk*jk)));jx=Math.round(jk*jv)}if(jt.x<0){jx=-jx}if(jt.y<0){jv=-jv}var jq;var jo;var jC;var i;var jB=e.getZoom();var jw=e.getHeading();var T=new b9(0,0);if(jB<4){jq=jE.x+jx;jo=jE.y+jv}else{var jA=this._getLatLngDiffByXYDiff(jn,jm);var ju=hM(jw);var jh=jx*Math.cos(ju)+jv*Math.sin(ju);var jf=jv*Math.cos(ju)-jx*Math.sin(ju);var T=this._getLatLngSpan(jh,jf);jC=jA.lng-T.lng;i=jA.lat-T.lat}var jD=this;var jj;var jg;var jp;var jz;this.dragAni=new e3({duration:10000,fps:60,render:function(jG,jF){if(jF===1){return}this._motionElaspsed=Date.now()-ji;var jH=Math.exp(-this._motionElaspsed/250);if(jH<0.01){if(jD.dragAni){jD.dragAni.stop();jD.dragAni=null}return}if(jB<4){jj=(jq-jx*jH);jg=(jo-jv*jH);if(jD._needToRevertX){jj=-jj}else{if(jD._needToRevertY){jg=-jg}}jD._setEarthCenterByXYDiff(jj,jg)}else{jp=(jC+T.lng*jH);jz=(i+T.lat*jH);jD._setEarthCenterByLatLngDiff(jz,jp)}},finish:function(){jD._earth.fire(new fa("onanimation_end"));jD.dragAni=null;jD._earth.fire(new fa("onmoveend"));jD._initLatLng=null},onStop:function(jF){jD._earth.fire(new fa("onanimation_end"));jD.dragAni=null;jD._initLatLng=null;jD._earth.fire(new fa("onmoveend"))}})},_onDragStartRight:function(e,i){this._initXRight=e;this._initYRight=i;if(this._earth.getZoom()<5){return}this._earth.fire(new fa("ondragstart"));this._initTilt=this._earth.getTilt()},_onDraggingRight:function(i,je){if(this._earth.getZoom()<5){return}this._rightDragged=true;var T=je-this._initYRight;var e=T/2;this._earth.fire(new fa("ondragging"));this._earth.setTilt(this._initTilt+e,{noAnimation:true})},_onDragEndRight:function(e,jg){var jf=!this._rightDragged;var je=this._earth._map;if(this._rightDblclickTimer){clearTimeout(this._rightDblclickTimer);this._rightDblclickTimer=null;if(jf){je.dispatchEvent(new fa("onrightclick"));je.dispatchEvent(new fa("onrightdblclick"));this._earth.fire(new fa("onearthrightdblclickzoom"));this._earth.zoomWithMousePosFix(this._earth.getZoom()-1,new eO(e,jg))}}else{if(jf){je.dispatchEvent(new fa("onrightclick"))}else{this._earth.fire(new fa("ondragend"))}var i=new fa("onrightclickex");var T=this;this._rightDblclickTimer=setTimeout(function(){T._rightDblclickTimer=null;if(jf){je.dispatchEvent(i)}},je.config.clickInterval)}if(this._rightDragged){this._earth.fire(new fa("onearthrightdragend"))}this._rightDragged=false},moveByArrowKey:function(jj,T){var jh=this._earth;if(jh.getLock()){return}if(jh._ani){jh._ani.stop()}var e=jh._map;if(T==="keydown"){this._earth.fire(new fa("onmovestart"));e.temp.arrow|=dL.arrowOpCodes[jj]}else{if(T==="keyup"){e.temp.arrow&=~dL.arrowOpCodes[jj]}}var ji=e.temp.arrow;var jg=e._arrow._lastArrow;var je=jg===ji?false:true;e._arrow._lastArrow=ji;var jk=jh.getZoom();var jf=this;if(ji===0||(ji&1&&ji&4)||(ji&2&&ji&8)){this._arrowAni&&this._arrowAni.stop();this._arrowMomentumAni&&this._arrowMomentumAni.stop();this._arrowAni=null;if(ji===0){this._initCenter=jh.getCenter().clone();this._initPanLng=8/Math.pow(2,jk);this._initPanLat=8/Math.pow(2,jk);var i=8/Math.pow(2,jk);this._arrowMomentumAni=new e3({duration:500,transition:fY.easeInCubic,render:function(jm){var jp=jf._initCenter;var jl=jp.lat;var jo=jp.lng;var jn=jg;if(jn&dL.arrowOpCodes[dL.KEY_LEFT]){jf._initPanLng+=i*(1-jm);jo=jp.lng-jf._initPanLng}if(jn&dL.arrowOpCodes[dL.KEY_RIGHT]){jf._initPanLng+=i*(1-jm);jo=jp.lng+jf._initPanLng}if(jn&dL.arrowOpCodes[dL.KEY_UP]){jf._initPanLat+=i*(1-jm);jl=jp.lat+jf._initPanLat}if(jn&dL.arrowOpCodes[dL.KEY_DOWN]){jf._initPanLat+=i*(1-jm);jl=jp.lat-jf._initPanLat}jh.setCenter(new b9(jl,jo),{noAnimation:true,noFireEvent:true,from:"keyboard"})},finish:function(){jf._earth.fire(new fa("onmoveend"));jf._arrowMomentumAni=null},stop:function(){jf._earth.fire(new fa("onmoveend"));jf._arrowMomentumAni=null}})}return}if(je){this._initCenter=jh.getCenter().clone();this._initPanLng=8/Math.pow(2,jk);this._initPanLat=8/Math.pow(2,jk)}if(this._arrowAni){return}this._arrowMomentumAni&&this._arrowMomentumAni.stop();var i=8/Math.pow(2,jk);this._arrowAni=new e3({duration:999999,transition:fY.linear,render:function(jn,jm){var jq=jf._initCenter;var jl=jq.lat;var jp=jq.lng;var jo=e.temp.arrow;if(jo&dL.arrowOpCodes[dL.KEY_LEFT]){jf._initPanLng+=i;jp=jq.lng-jf._initPanLng}if(jo&dL.arrowOpCodes[dL.KEY_RIGHT]){jf._initPanLng+=i;jp=jq.lng+jf._initPanLng}if(jo&dL.arrowOpCodes[dL.KEY_UP]){jf._initPanLat+=i;jl=jq.lat+jf._initPanLat}if(jo&dL.arrowOpCodes[dL.KEY_DOWN]){jf._initPanLat+=i;jl=jq.lat-jf._initPanLat}jh.setCenter(new b9(jl,jp),{noAnimation:true,noFireEvent:true,from:"keyboard"})}})}});function cc(i,e){this._earth=e;this.scrollCount=0;this.maxZoomWheelDir=1;this.minZoomWheelDir=-1;var T=dR[i.getMapType()];this.maxZoom=T.maxZoom;this.minZoom=T.minZoom;this._lastWheelTime=0;this._opMethod="";this.lastWheelDelta=0;this.lastDiff=0;this.zoomEventStatus="idle";this._canDispatchEvent=true;this._mousePos=null;this._isMac=!!ev.Platform.macintosh}cc.prototype.onWheel=function(jh){if(this._earth.getLock()){return}var T=Math.floor(jh.timeStamp);var i=T-this._lastWheelTime;var jg=jh.wheelDelta>=0||jh.deltaY<0||jh.detail<0;var jo=Math.abs(jh.deltaY);var jk=Math.abs(jh.wheelDelta);var jl=jo;if(jk===0&&jl===0){return}if(i>100){this._opMethod=g4(jk,jl,jh.deltaMode);this._mousePos=jh.offsetPosMap.clone();this.scrollCount=0;this.startZoom=this._earth.getZoom()}var je=false;if(this._mousePos===null&&jh.offsetPosMap!==null){this._mousePos=jh.offsetPosMap.clone()}var jn=this._mousePos;this._lastWheelTime=T;if(this._opMethod==="mouseWheel"){var jj=jk?(jk/3):jl;this._onWheelMouse(jj,jg,jn,jh.deltaMode);return}else{if(this._opMethod==="padScroll"){jo=jl/50;je=true}else{jo=jl/20;je=true}}if(isNaN(jo)&&jh.detail){jo=Math.abs(jh.detail)}var ji=this;if(i<80){if(!this._wheelEventTimer){this._wheelEventTimer=setTimeout(function(){ji._canDispatchEvent=true;ji._wheelEventTimer=null},100)}if(ji._canDispatchEvent){var jm=new fa("onearthwheelzoom");if(ji._isMac){jm.opMethod=ji._opMethod}ji._earth.fire(jm);ji._canDispatchEvent=false}}var jp=this._earth.getZoom();var jf=jg===true?jp+0.2*jo:jp-0.2*jo;this._earth.zoomWithMousePosFix(jf,jn,{duration:200,transition:fY.linear,stopCurrentAnimation:true,noAnimation:je})};cc.prototype._onWheelMouse=function(je,jg,e,jf){var jh=this._earth;this.scrollCount++;if(this.scrollCount>10){this.scrollCount=10}if(ev.Browser.firefox){if(jf===1){je*=15}if(!ev.Platform.macintosh){this.zoomDiff=bt(je*0.005,2)*this.scrollCount}else{if(je%1!==0){je*=10}this.zoomDiff=bt(je*0.01,2)}}else{if(!ev.Platform.macintosh){this.zoomDiff=bt(je*0.005,2)*this.scrollCount}else{this.zoomDiff=bt(je*0.005,2)}}if(this.zoomDiff>2){this.zoomDiff=2}if(jg===false){this.zoomDiff=-this.zoomDiff}var T=jh.getZoom()+this.zoomDiff;jh.zoomWithMousePosFix(T,e,{opMethod:"mouseWheel",stopCurrentAnimation:true});this._preTrend=this._trend;var i=new fa("onearthwheelzoom");if(this._isMac){i.opMethod="mousescroll"}this._earth.fire(i)};');
